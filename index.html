<!DOCTYPE html>
<html lang="en">
<!--
  REVEAL! v4.6.1 – Turn + Guess UX Fix Pack (NOT 4.7)

  FIXES IN THIS FILE
  - Turn/pacing: only ACTIVE player can act (PASS/GUESS enabled); others are greyed out.
  - PASS/GUESS controls are TWO ROWS, fixed height, no resizing.
    Row 1: PASS (always visible)
    Row 2: GUESS (idle) -> swaps to [input][SEND] when guessing
    No X / no timeouts / input never disappears until SEND or PASS.
  - Auto-advance turn after PASS or SEND.
  - ENTER submits guess (and SEND button works too).
  - Host is NOT added as a player.
  - Host still sees the full board/grid.
  - Category moved above main card.
  - Jumbotron panels forced SQUARE (no rectangles).
  - Current call animation = quick "pop", NOT throbbing.
  - 23 gimmick REMOVED.
  - Wrong guesses privacy:
      * Host sees ALL guesses + %.
      * Player sees ONLY THEIR guesses + %.
  - WIN screen:
      NAME wins!
      They guessed: ANSWER
      Revealed picture
      60% dark overlay + simple fireworks
      Winning guess NOT shown in sidebar.

  NOTES
  - This remains MQTT-broker state sync (public topic). Players still RECEIVE all state,
    but UI filters what they see.
-->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>REVEAL! v4.6.1</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* [A] CORE VARS ------------------------------------------------------ */
    :root{
      --bg-color:#4c1d95;
      --panel-bg:rgba(0,0,0,0.25);
      --accent:#2dd4bf;
      --text-main:#ffffff;
      --font-head:'Fredoka One',cursive;
      --font-body:'Nunito',sans-serif;
      --tile-off:#1e293b;
      --card-max-width:450px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      height:100vh; width:100vw;
      background:var(--bg-color);
      color:var(--text-main);
      font-family:var(--font-body);
      display:flex; flex-direction:column;
      overflow:hidden;
      transition:background .25s ease;
    }

    /* [B] SCREENS -------------------------------------------------------- */
    .screen{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:var(--bg-color);
      z-index:10;
      transition:transform .3s ease;
      transform:translateX(100%);
    }
    .screen.active{transform:translateX(0); z-index:20;}

    .card-panel{
      background:rgba(255,255,255,0.10);
      backdrop-filter:blur(10px);
      padding:25px;
      border-radius:20px;
      width:90%;
      max-width:400px;
      border:2px solid rgba(255,255,255,0.2);
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    .control-group{margin-bottom:15px; text-align:left; width:100%;}
    label{display:block; font-weight:900; margin-bottom:5px; font-size:.8rem; text-transform:uppercase; opacity:.8}
    input, select{
      width:100%; padding:12px;
      border-radius:10px; border:none;
      font-family:var(--font-body);
      font-weight:800; font-size:1.05rem;
      background:#f8fafc; color:#1e293b;
      outline:none;
    }
    .code-input{
      font-family:'Courier New',monospace;
      letter-spacing:5px;
      text-align:center;
      font-size:1.5rem;
      text-transform:uppercase;
    }

    .big-btn{
      width:100%;
      padding:15px;
      border-radius:12px;
      border:none;
      font-family:var(--font-head);
      font-size:1.2rem;
      cursor:pointer;
      background:var(--accent);
      color:#000;
      box-shadow:0 5px 0 rgba(0,0,0,0.2);
      margin-top:5px;
      transition:transform .1s;
    }
    .big-btn:active{transform:translateY(2px); box-shadow:none;}
    .big-btn:disabled{background:#64748b; cursor:not-allowed; box-shadow:none; opacity:.7;}
    .big-btn.secondary{background:rgba(255,255,255,0.2); color:white;}

    /* [C] GAME LAYOUT ---------------------------------------------------- */
    #screen-game{
      display:grid;
      grid-template-rows: 1fr 60px;
      height:100%; width:100%;
      padding:0;
      background:var(--bg-color);
    }
    #game-layout{
      display:grid;
      grid-template-columns: 200px 1fr 200px;
      overflow:hidden;
    }
    .sidebar{
      background:var(--panel-bg);
      border-left:1px solid rgba(255,255,255,0.05);
      border-right:1px solid rgba(255,255,255,0.05);
      display:flex; flex-direction:column;
      padding:10px;
      overflow-y:auto;
    }
    .sb-head{
      font-family:var(--font-head);
      text-align:center;
      opacity:.65;
      margin-bottom:10px;
      font-size:.9rem;
    }
    .sb-item{
      font-size:.9rem;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      word-break:break-word;
      border-left:4px solid transparent;
      background:rgba(255,255,255,0.04);
      border-radius:8px;
      margin-bottom:8px;
    }
    .sb-item.active-turn{
      background:rgba(255,255,255,0.18);
      border-left-color:var(--accent);
    }

    #center-stage{
      display:flex;
      flex-direction:column;
      padding:10px;
      overflow-y:auto;
      align-items:center;
    }
    .game-stack{
      width:100%;
      max-width:var(--card-max-width);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom:10px;
    }

    /* [D] HEADER --------------------------------------------------------- */
    #header-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
      background:var(--panel-bg);
      padding:10px;
      border-radius:12px;
    }
    .info-cell{text-align:center; overflow:hidden;}
    .info-lbl{
      font-size:.55rem;
      opacity:.65;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .info-val{
      font-weight:900;
      font-size:.95rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #inf-code{
      font-family:'Courier New',monospace;
      cursor:pointer;
      background:rgba(255,255,255,0.12);
      border-radius:8px;
      display:inline-block;
      padding:2px 10px;
    }
    #info-status{grid-column: 1 / -1;}
    #inf-status{font-weight:900;}

    /* [E] JUMBOTRON (SQUARE PANELS) -------------------------------------- */
    #jumbotron{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      width:100%;
    }
    .jumbo-panel{
      background:rgba(0,0,0,0.35);
      border:2px solid rgba(255,255,255,0.9);
      border-radius:12px;
      aspect-ratio: 1 / 1;     /* force squares */
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Called numbers panel */
    #mini-grid-container{ padding:10px; }
    #mini-grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns:repeat(5,1fr);
      grid-template-rows:repeat(5,1fr);
      gap:0;
    }
    .trk-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(148,163,184,0.95);
      font-size:.85rem;
      font-weight:900;
      user-select:none;
    }
    .trk-cell.active{
      color:var(--accent);
      text-shadow:0 0 8px var(--accent);
    }

    /* Current call panel */
    #call-box{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px;
      background:rgba(0,0,0,0.7);
    }
    .call-lbl{
      position:absolute;
      top:10px;
      font-size:.72rem;
      opacity:.7;
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .call-val{
      font-family:var(--font-head);
      font-size:5rem;
      line-height:1;
      color:white;
      transform-origin:center;
    }
    .call-pop{ animation: callPop .18s ease-out; }
    @keyframes callPop{
      0%{ transform:scale(.85); filter:brightness(1.0); }
      100%{ transform:scale(1.0); filter:brightness(1.15); }
    }

    /* CATEGORY STRIP (moved above main card) ------------------------------ */
    #cat-strip{
      background:var(--panel-bg);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      justify-content:center;
      gap:10px;
      align-items:baseline;
      text-align:center;
    }
    #cat-strip .lbl{
      font-size:.7rem;
      opacity:.7;
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    #cat-strip .val{
      font-family:var(--font-head);
      font-size:1.05rem;
    }

    /* [F] CARD + TILES ---------------------------------------------------- */
    #card-wrapper{
      width:100%;
      aspect-ratio: 1 / 1;
      position:relative;
      background:#000;
      border:4px solid rgba(255,255,255,0.9);
      border-radius:12px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      overflow:hidden;
    }
    #target-img{
      width:100%; height:100%;
      object-fit:cover;
      position:absolute; inset:0;
      z-index:1;
    }
    #tile-grid{
      position:absolute; inset:0;
      z-index:10;
      display:grid;
      grid-template-columns:repeat(5,1fr);
      grid-template-rows:repeat(5,1fr);
      gap:0;
    }
    .tile{
      background:var(--tile-off);
      color:rgba(255,255,255,0.28);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:var(--font-head);
      font-size:2rem;
      cursor:pointer;
      user-select:none;
      transition:opacity .2s ease;
    }
    .tile.locked{ cursor:not-allowed; opacity:1 !important; }
    .tile.revealed{ opacity:0; pointer-events:none; }

    /* [G] CONTROLS: TWO ROWS, FIXED HEIGHT -------------------------------- */
    #controls-bar{
      width:100%;
      height:110px;              /* fixed; never changes */
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ctrl-row{
      height:50px;
      display:flex;
      gap:10px;
    }
    .ctrl-btn{
      flex:1 1 auto;
      height:100%;
      border-radius:12px;
      border:none;
      font-family:var(--font-head);
      font-size:1.25rem;
      cursor:pointer;
      box-shadow:0 4px 0 rgba(0,0,0,0.3);
    }
    .ctrl-btn:active{ transform:translateY(4px); box-shadow:none; }
    .btn-pass{ background:#ef4444; color:white; }
    .btn-guess{ background:var(--accent); color:black; }
    .btn-send{ background:var(--accent); color:black; flex:0 0 120px; }

    .ctrl-btn.disabled,
    .ctrl-input.disabled{
      opacity:.35;
      cursor:not-allowed;
      box-shadow:none;
      pointer-events:none;
    }

    .ctrl-input{
      flex:1 1 auto;
      height:100%;
      padding:0 14px;
      border-radius:12px;
      border:none;
      font-size:1.15rem;
      text-align:center;
      outline:none;
      background:white;
      color:black;
      min-width:0;
      font-weight:900;
      font-family:var(--font-body);
    }

    /* [H] FOOTER CHAT PLACEHOLDER ----------------------------------------- */
    #chat-bar{
      background:rgba(0,0,0,0.35);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,0.1);
    }
    #chat-input{ flex:1; padding:10px; border-radius:10px; border:none; font-family:var(--font-body); outline:none; margin:0; }
    #chat-send{ width:70px; border-radius:10px; border:none; background:#3b82f6; color:white; font-weight:900; cursor:pointer; }

    /* [I] WIN OVERLAY + FIREWORKS ----------------------------------------- */
    #win-overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.60);
      z-index:9999;
      overflow:hidden;
    }
    #win-overlay.show{ display:flex; }

    .win-card{
      width:min(520px, 92vw);
      background:rgba(15,23,42,0.92);
      border:2px solid rgba(255,255,255,0.25);
      border-radius:18px;
      padding:18px;
      text-align:center;
      box-shadow:0 20px 60px rgba(0,0,0,0.55);
      backdrop-filter:blur(8px);
      position:relative;
      z-index:2;
    }
    .win-title{
      font-family:var(--font-head);
      font-size:2rem;
      margin:0 0 8px;
    }
    .win-sub{
      font-weight:900;
      opacity:.9;
      margin:0 0 12px;
    }
    .win-img{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      border:2px solid rgba(255,255,255,0.2);
      object-fit:cover;
    }

    /* simple fireworks */
    .fw{
      position:absolute;
      bottom:-40px;
      width:10px; height:10px;
      border-radius:999px;
      background:var(--accent);
      animation: fwShoot 1.2s ease-out infinite;
      opacity:.9;
      z-index:1;
    }
    .fw:nth-child(1){ left:10%; animation-delay:0s; }
    .fw:nth-child(2){ left:25%; animation-delay:.2s; }
    .fw:nth-child(3){ left:40%; animation-delay:.4s; }
    .fw:nth-child(4){ left:60%; animation-delay:.1s; }
    .fw:nth-child(5){ left:75%; animation-delay:.35s; }
    .fw:nth-child(6){ left:90%; animation-delay:.55s; }
    @keyframes fwShoot{
      0%{ transform:translateY(0) scale(1); filter:brightness(1); }
      60%{ transform:translateY(-65vh) scale(1.2); filter:brightness(1.25); }
      100%{ transform:translateY(-78vh) scale(0.2); opacity:0; }
    }

    /* [J] MOBILE ---------------------------------------------------------- */
    @media (max-width: 800px){
      #game-layout{ grid-template-columns:1fr; }
      .sidebar{ display:none; }
      #chat-bar{ display:none; }
    }
  </style>
</head>

<body>

  <!-- [S1] LOBBY ---------------------------------------------------------- -->
  <div id="screen-lobby" class="screen active">
    <div class="card-panel">
      <h1>REVEAL! v4.6.1</h1>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
        <button class="big-btn" onclick="goTo('screen-host-setup')">HOST GAME</button>
        <div style="opacity:0.5; margin:5px 0;">OR</div>
        <button class="big-btn secondary" onclick="goTo('screen-join-code')">JOIN GAME</button>
      </div>
    </div>
  </div>

  <!-- [S2] HOST SETUP ----------------------------------------------------- -->
  <div id="screen-host-setup" class="screen">
    <div class="card-panel">
      <h2>GAME SETUP</h2>
      <div class="control-group"><label>HOST NAME</label><input type="text" id="host-name" placeholder="Name"></div>
      <div class="control-group"><label>CATEGORY</label><input type="text" id="game-cat" placeholder="e.g. Landmarks"></div>
      <div class="control-group"><label>ANSWER</label><input type="text" id="game-ans" placeholder="Secret Answer"></div>
      <div class="control-group"><label>IMAGE</label><input type="file" id="img-upload" accept="image/*" onchange="processImage()"></div>
      <div class="control-group"><label>STYLE (PREVIEW)</label>
        <select id="host-style" onchange="setSkin(this.value)">
          <option value="neon">Neon Grape</option>
          <option value="darkacad">Dark Academia</option>
          <option value="artdeco">Art Deco</option>
          <option value="slate">Storm Slate</option>
          <option value="sunset">Miami Sunset</option>
          <option value="forest">Cryptid Forest</option>
          <option value="carnival">Killer Carnival</option>
        </select>
      </div>

      <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:15px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- [S3] JOIN CODE ------------------------------------------------------ -->
  <div id="screen-join-code" class="screen">
    <div class="card-panel">
      <h2>ENTER CODE</h2>
      <input type="text" id="join-code" class="code-input" maxlength="4" placeholder="ABCD">
      <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:15px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- [S4] JOIN NAME ------------------------------------------------------ -->
  <div id="screen-join-setup" class="screen">
    <div class="card-panel">
      <h2 id="join-room-disp">ROOM FOUND</h2>
      <div id="join-host-disp" style="color:var(--accent); margin-bottom:15px; font-weight:bold;">Connecting...</div>
      <input type="text" id="join-name" placeholder="YOUR NAME">
      <div class="control-group" style="margin-top:12px;"><label>STYLE (PREVIEW)</label>
        <select id="join-style" onchange="setSkin(this.value)">
          <option value="neon">Neon Grape</option>
          <option value="darkacad">Dark Academia</option>
          <option value="artdeco">Art Deco</option>
          <option value="slate">Storm Slate</option>
          <option value="sunset">Miami Sunset</option>
          <option value="forest">Cryptid Forest</option>
          <option value="carnival">Killer Carnival</option>
        </select>
      </div>
      <button class="big-btn" id="btn-enter" disabled onclick="enterGame()">ENTER GAME</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:15px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- [S5] GAME ----------------------------------------------------------- -->
  <div id="screen-game" class="screen">
    <div id="game-layout">

      <!-- LEFT: PLAYERS -->
      <div class="sidebar" id="sb-players">
        <div class="sb-head">PLAYERS</div>
        <div id="list-players"></div>
      </div>

      <!-- CENTER -->
      <div id="center-stage">
        <div class="game-stack">

          <!-- HEADER -->
          <div id="header-row">
            <div class="info-cell">
              <div class="info-lbl">HOST</div>
              <div class="info-val" id="inf-host">?</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">YOU</div>
              <div class="info-val" id="inf-you">?</div>
            </div>

            <div class="info-cell">
              <div class="info-lbl">CODE</div>
              <div class="info-val" id="inf-code" onclick="copyCode()">????</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">STYLE</div>
              <select id="style-in-game" onchange="setSkin(this.value)" style="padding:0;margin:0;height:22px;font-size:.9rem;background:transparent;color:white;border:none;outline:none;font-weight:900;">
                <option value="neon">Neon Grape</option>
                <option value="darkacad">Dark Academia</option>
                <option value="artdeco">Art Deco</option>
                <option value="slate">Storm Slate</option>
                <option value="sunset">Miami Sunset</option>
                <option value="forest">Cryptid Forest</option>
                <option value="carnival">Killer Carnival</option>
              </select>
            </div>

            <div class="info-cell" id="info-status">
              <div class="info-lbl">STATUS</div>
              <div class="info-val" id="inf-status">WAITING</div>
            </div>
          </div>

          <!-- JUMBOTRON -->
          <div id="jumbotron">
            <div id="mini-grid-container" class="jumbo-panel">
              <div id="mini-grid"></div>
            </div>
            <div id="call-box" class="jumbo-panel">
              <div class="call-lbl">CURRENT CALL</div>
              <div class="call-val" id="call-val">--</div>
            </div>
          </div>

          <!-- CATEGORY STRIP -->
          <div id="cat-strip">
            <div class="lbl">CATEGORY</div>
            <div class="val" id="cat-val">?</div>
          </div>

          <!-- CARD -->
          <div id="card-wrapper">
            <img id="target-img" src="" alt="">
            <div id="tile-grid"></div>
          </div>

          <!-- CONTROLS (TWO ROWS) -->
          <div id="controls-bar">
            <div class="ctrl-row">
              <button id="btn-pass" class="ctrl-btn btn-pass" onclick="passTurn()">PASS</button>
            </div>

            <!-- Row 2: idle guess button -->
            <div class="ctrl-row" id="row-guess-idle">
              <button id="btn-guess" class="ctrl-btn btn-guess" onclick="openGuess()">GUESS</button>
            </div>

            <!-- Row 2: active guess input -->
            <div class="ctrl-row" id="row-guess-input" style="display:none;">
              <input id="guess-field" class="ctrl-input" type="text" placeholder="TYPE YOUR GUESS">
              <button id="btn-send" class="ctrl-btn btn-send" onclick="sendGuess()">SEND</button>
            </div>
          </div>

          <!-- HOST BUTTON (kept separate but only visible if host) -->
          <div style="width:100%;">
            <button id="btn-host-call" class="big-btn" style="display:none; margin-top:0;" onclick="hostCall()">CALL NEXT NUMBER</button>
          </div>

        </div>
      </div>

      <!-- RIGHT: WRONG GUESSES -->
      <div class="sidebar" id="sb-guesses">
        <div class="sb-head">WRONG GUESSES</div>
        <div id="list-guesses"></div>
      </div>
    </div>

    <!-- FOOTER CHAT PLACEHOLDER -->
    <div id="chat-bar">
      <input type="text" id="chat-input" placeholder="Chat...">
      <button id="chat-send" onclick="alert('Chat later.')">SEND</button>
    </div>
  </div>

  <!-- WIN OVERLAY -->
  <div id="win-overlay">
    <div class="fw"></div><div class="fw"></div><div class="fw"></div><div class="fw"></div><div class="fw"></div><div class="fw"></div>
    <div class="win-card">
      <h2 class="win-title" id="win-title">Someone wins!</h2>
      <p class="win-sub" id="win-sub">They guessed: ???</p>
      <img class="win-img" id="win-img" src="" alt="">
    </div>
  </div>

<script>
  /* [1] SKINS ------------------------------------------------------------ */
  const SKINS = {
    neon:     { bg:'#4c1d95', acc:'#2dd4bf', text:'#ffffff', tile:'#1e293b' }, // Neon Grape
    darkacad: { bg:'#0b1220', acc:'#d4b483', text:'#f8f5ee', tile:'#111827' }, // Dark Academia
    artdeco:  { bg:'#0f172a', acc:'#fbbf24', text:'#fff7ed', tile:'#1f2937' }, // Art Deco
    slate:    { bg:'#0f172a', acc:'#38bdf8', text:'#e2e8f0', tile:'#1f2937' }, // Storm Slate
    sunset:   { bg:'#7c2d12', acc:'#fb7185', text:'#fff7ed', tile:'#451a03' }, // Miami Sunset
    forest:   { bg:'#064e3b', acc:'#a7f3d0', text:'#ecfdf5', tile:'#052e16' }, // Cryptid Forest
    carnival: { bg:'#3b0764', acc:'#f472b6', text:'#fae8ff', tile:'#1f0933' }, // Killer Carnival
  };

  let currentSkin = localStorage.getItem('reveal_skin_v461') || 'neon';

  function applySkin(key){
    const s = SKINS[key] || SKINS.neon;
    const r = document.documentElement.style;
    r.setProperty('--bg-color', s.bg);
    r.setProperty('--accent', s.acc);
    r.setProperty('--text-main', s.text);
    r.setProperty('--tile-off', s.tile);
  }

  function syncSkinSelects(){
    const ids = ['host-style','join-style','style-in-game'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.value = currentSkin;
    });
  }

  function setSkin(key){
    currentSkin = key;
    localStorage.setItem('reveal_skin_v461', currentSkin);
    applySkin(currentSkin);
    syncSkinSelects();
  }

  applySkin(currentSkin);

  /* [2] GLOBAL STATE ----------------------------------------------------- */
  let myName = '';
  let roomCode = '';
  let isHost = false;
  let client = null;
  let gameImg = null;

  const BROKER    = 'wss://broker.emqx.io:8084/mqtt';
  const TOPIC_PRE = 'reveal_v4_6_1';

  // authoritative state is broadcast by host
  let gameState = {
    host: "",
    cat: "",
    ans: "",
    players: [],           // [{name}]
    activeIdx: 0,          // index into players[]
    guesses: [],           // {from, txt, pct}  (wrong guesses only)
    revealed: [],          // [numbers called]
    status: "WAITING",     // WAITING | WIN
    winner: "",
    winGuess: ""
  };

  /* [3] NAV -------------------------------------------------------------- */
  function goTo(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  }

  /* [4] IMAGE HANDLING (HOST) -------------------------------------------- */
  function processImage(){
    const file = document.getElementById('img-upload').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        const s = Math.min(img.width, img.height);
        c.width = 600; c.height = 600;
        ctx.drawImage(img, (img.width - s)/2, (img.height - s)/2, s, s, 0, 0, 600, 600);
        gameImg = c.toDataURL('image/jpeg', 0.72);
        document.getElementById('btn-create').disabled = false;
      };
    };
    reader.readAsDataURL(file);
  }

  /* [5] MQTT ------------------------------------------------------------- */
  function connectMQTT(){
    if (client) return;
    client = mqtt.connect(BROKER);

    client.on('connect', ()=>{
      client.subscribe(`${TOPIC_PRE}/${roomCode}`);
      if (!isHost){
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:'REQ_STATE'}));
      }
    });

    client.on('message', handleMsg);
  }

  function sendState(){
    if (client && client.connected && isHost){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({
        type:'STATE',
        state: gameState,
        img: gameImg
      }));
    }
  }

  /* [6] HOST: CREATE ------------------------------------------------------ */
  function createGame(){
    myName = (document.getElementById('host-name').value || '').trim() || 'Host';
    isHost = true;

    gameState.host = myName;
    gameState.cat  = (document.getElementById('game-cat').value || '').trim();
    gameState.ans  = (document.getElementById('game-ans').value || '').trim();
    gameState.players = [];
    gameState.activeIdx = 0;
    gameState.guesses = [];
    gameState.revealed = [];
    gameState.status = "WAITING";
    gameState.winner = "";
    gameState.winGuess = "";

    roomCode = Math.random().toString(36).substr(2,4).toUpperCase();

    connectMQTT();
    startGameUI();

    sendState();
    setInterval(()=>{
      if (client && client.connected && isHost) sendState();
    }, 1500);
  }

  /* [7] JOIN -------------------------------------------------------------- */
  function searchRoom(){
    const code = (document.getElementById('join-code').value || '').trim().toUpperCase();
    if (code.length !== 4){ alert('Enter 4-letter code.'); return; }
    roomCode = code;
    isHost = false;

    document.getElementById('btn-search').innerText = 'SEARCHING...';
    connectMQTT();
  }

  function enterGame(){
    myName = (document.getElementById('join-name').value || '').trim();
    if (!myName) return;

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:'JOIN', name: myName}));
    }

    startGameUI();
  }

  /* [8] UI INIT ----------------------------------------------------------- */
  function startGameUI(){
    goTo('screen-game');

    // header fields
    document.getElementById('inf-code').innerText = roomCode;
    document.getElementById('inf-you').innerText = myName || '?';

    // show host call button only to host
    document.getElementById('btn-host-call').style.display = isHost ? 'block' : 'none';

    // sync skin dropdown to actual selected skin (fix "always top option" issue)
    syncSkinSelects();

    // mini-grid 1–25
    const mg = document.getElementById('mini-grid');
    mg.innerHTML = '';
    for (let i=1;i<=25;i++){
      const d = document.createElement('div');
      d.className = 'trk-cell';
      d.id = 'trk-' + i;
      d.innerText = i;
      mg.appendChild(d);
    }

    // main grid tiles (random per client — fine for this phase)
    const grid = document.getElementById('tile-grid');
    grid.innerHTML = '';
    let nums = Array.from({length:25}, (_,i)=>i+1);
    for (let i=nums.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [nums[i], nums[j]] = [nums[j], nums[i]];
    }
    nums.forEach(n=>{
      const t = document.createElement('div');
      t.className = 'tile';
      t.innerText = n;
      t.dataset.n = n;
      t.onclick = ()=>{
        const num = parseInt(t.dataset.n,10);
        if ((gameState.revealed || []).includes(num)){
          t.classList.add('revealed');
        } else {
          alert("That number hasn't been called yet.");
        }
      };
      grid.appendChild(t);
    });

    // guess field enter submits
    const gf = document.getElementById('guess-field');
    gf.onkeydown = (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        sendGuess();
      }
    };

    // set image if known
    if (gameImg) document.getElementById('target-img').src = gameImg;

    // ensure guess UI starts idle
    closeGuessUI();

    updateUI();
  }

  /* [9] MESSAGE HANDLER --------------------------------------------------- */
  function handleMsg(topic, payload){
    let msg;
    try { msg = JSON.parse(payload.toString()); }
    catch { return; }

    if (msg.type === 'STATE'){
      gameState = msg.state || gameState;
      if (msg.img) gameImg = msg.img;

      // join flow: move to name screen once state arrives
      if (document.getElementById('screen-join-code').classList.contains('active')){
        document.getElementById('join-room-disp').innerText = 'ROOM: ' + roomCode;
        document.getElementById('join-host-disp').innerText = 'HOST: ' + (gameState.host || '...');
        document.getElementById('btn-enter').disabled = false;
        document.getElementById('btn-search').innerText = 'NEXT';
        goTo('screen-join-setup');
        syncSkinSelects();
      }

      // if game UI is open, keep image updated
      const ti = document.getElementById('target-img');
      if (ti && gameImg) ti.src = gameImg;

      updateUI();
      return;
    }

    if (msg.type === 'REQ_STATE' && isHost){
      sendState();
      return;
    }

    if (msg.type === 'JOIN' && isHost){
      const name = (msg.name || '').trim();
      if (!name) return;

      // host is NOT a player
      if (name === gameState.host) return;

      const exists = (gameState.players || []).some(p=>p.name === name);
      if (!exists){
        gameState.players.push({name});
        // if first player joining, make them active
        if (gameState.players.length === 1){
          gameState.activeIdx = 0;
        }
        sendState();
      }
      return;
    }

    if (msg.type === 'GUESS' && isHost){
      handleIncomingGuessAsHost(msg);
      return;
    }

    if (msg.type === 'PASS' && isHost){
      // ignore passes from non-active
      if (!isActivePlayer(msg.from)) return;
      advanceTurn();
      sendState();
      return;
    }
  }

  /* [10] TURN HELPERS ----------------------------------------------------- */
  function getActivePlayerName(){
    const ps = gameState.players || [];
    if (!ps.length) return '';
    const idx = Math.max(0, Math.min(gameState.activeIdx || 0, ps.length - 1));
    return ps[idx]?.name || '';
  }

  function isActivePlayer(name){
    return !!name && name === getActivePlayerName();
  }

  function advanceTurn(){
    const ps = gameState.players || [];
    if (!ps.length){ gameState.activeIdx = 0; return; }
    gameState.activeIdx = ( (gameState.activeIdx || 0) + 1 ) % ps.length;
  }

  /* [11] UI UPDATE -------------------------------------------------------- */
  function updateUI(){
    // header
    document.getElementById('inf-host').innerText = gameState.host || '?';
    document.getElementById('inf-you').innerText  = myName || '?';
    document.getElementById('cat-val').innerText  = gameState.cat || '?';

    // status
    const st = document.getElementById('inf-status');
    if (gameState.status === 'WIN'){
      st.innerText = `WIN: ${gameState.winner || '???'}`;
    } else {
      const ap = getActivePlayerName();
      st.innerText = ap ? `TURN: ${ap}` : 'WAITING FOR PLAYERS';
    }

    // mini-grid + last call
    let last = 0;
    (gameState.revealed || []).forEach(n=>{
      const el = document.getElementById('trk-' + n);
      if (el) el.classList.add('active');
      last = n;
    });

    // call box value + non-throbbing pop
    const cv = document.getElementById('call-val');
    if (cv){
      const nextText = (last || '--').toString();
      if (cv.innerText !== nextText){
        cv.innerText = nextText;
        cv.classList.remove('call-pop');
        void cv.offsetWidth; // reflow
        cv.classList.add('call-pop');
      }
    }

    // players list with active highlight
    const pl = document.getElementById('list-players');
    if (pl){
      pl.innerHTML = '';
      const active = getActivePlayerName();
      (gameState.players || []).forEach(p=>{
        const d = document.createElement('div');
        d.className = 'sb-item' + (p.name === active ? ' active-turn' : '');
        d.innerText = p.name;
        pl.appendChild(d);
      });
    }

    // wrong guesses list (filtered)
    const lg = document.getElementById('list-guesses');
    if (lg){
      lg.innerHTML = '';
      const all = gameState.guesses || [];
      const view = isHost ? all : all.filter(g=>g.from === myName);
      view.forEach(g=>{
        const d = document.createElement('div');
        d.className = 'sb-item';
        d.innerText = isHost
          ? `${g.from}: "${g.txt}" (${g.pct}%)`
          : `"${g.txt}" (${g.pct}%)`;
        lg.appendChild(d);
      });
    }

    // enable/disable controls for active player only (players; host never guesses)
    const myTurn = (!isHost) && isActivePlayer(myName) && (gameState.status !== 'WIN');
    setControlsEnabled(myTurn);

    // if not my turn, force guess UI closed (but never while typing on your turn)
    if (!myTurn) closeGuessUI();

    // win overlay
    if (gameState.status === 'WIN'){
      showWinOverlay();
    } else {
      hideWinOverlay();
    }
  }

  function setControlsEnabled(enabled){
    const passBtn = document.getElementById('btn-pass');
    const guessBtn = document.getElementById('btn-guess');
    const gf = document.getElementById('guess-field');
    const sendBtn = document.getElementById('btn-send');

    [passBtn, guessBtn, gf, sendBtn].forEach(el=>{
      if (!el) return;
      if (enabled){
        el.classList.remove('disabled');
      } else {
        el.classList.add('disabled');
      }
    });
  }

  /* [12] CONTROLS UX ------------------------------------------------------ */
  function openGuess(){
    // only if enabled (class gating)
    const guessBtn = document.getElementById('btn-guess');
    if (guessBtn.classList.contains('disabled')) return;

    document.getElementById('row-guess-idle').style.display = 'none';
    document.getElementById('row-guess-input').style.display = 'flex';
    const gf = document.getElementById('guess-field');
    gf.focus();
  }

  function closeGuessUI(){
    document.getElementById('row-guess-input').style.display = 'none';
    document.getElementById('row-guess-idle').style.display = 'flex';
    const gf = document.getElementById('guess-field');
    gf.value = '';
  }

  function passTurn(){
    const passBtn = document.getElementById('btn-pass');
    if (passBtn.classList.contains('disabled')) return;
    if (gameState.status === 'WIN') return;

    // player sends PASS to host; host advances & broadcasts
    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:'PASS', from: myName}));
    }

    // locally close guess UI
    closeGuessUI();
  }

  function sendGuess(){
    const sendBtn = document.getElementById('btn-send');
    if (sendBtn.classList.contains('disabled')) return;
    if (gameState.status === 'WIN') return;

    const gf = document.getElementById('guess-field');
    const g = (gf.value || '').trim();
    if (!g) return;   // Q2: no min length requirement beyond non-empty

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:'GUESS', from: myName, txt: g}));
    }

    // keep UI stable; close guess (PASS is always available but guess is done)
    closeGuessUI();
  }

  /* [13] HOST CALL -------------------------------------------------------- */
  function hostCall(){
    if (!isHost) return;
    if (gameState.status === 'WIN') return;

    const avail = [];
    for (let i=1;i<=25;i++){
      if (!(gameState.revealed || []).includes(i)) avail.push(i);
    }
    if (!avail.length) return;

    const pick = avail[Math.floor(Math.random()*avail.length)];
    gameState.revealed.push(pick);

    // after host calls, turn advances (autoadvance pacing)
    if ((gameState.players || []).length){
      advanceTurn();
    }

    sendState();
    updateUI();
  }

  /* [14] FUZZY MATCHING (HOST) ------------------------------------------- */
  function sanitizeText(s){
    return (s||'').replace(/\s+/g,'').toUpperCase();
  }

  function levenshtein(a,b){
    const m=a.length, n=b.length;
    const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i;
    for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++){
      for(let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1]?0:1;
        dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }
    }
    return dp[m][n];
  }

  function similarityPercent(guess, answer){
    const g=sanitizeText(guess);
    const a=sanitizeText(answer);
    if(!g||!a) return 0;
    const dist=levenshtein(g,a);
    const maxLen=Math.max(g.length,a.length);
    return Math.round((1 - dist/maxLen)*100);
  }

  function handleIncomingGuessAsHost(msg){
    // only active player can guess
    if (!isActivePlayer(msg.from)) return;

    const pct = similarityPercent(msg.txt, gameState.ans);
    const win = (pct >= 90);

    if (win){
      gameState.status  = 'WIN';
      gameState.winner  = msg.from;
      gameState.winGuess = msg.txt;

      // reveal full image
      gameState.revealed = Array.from({length:25}, (_,i)=>i+1);

      // IMPORTANT: winning guess does NOT go in sidebar
      sendState();
      return;
    }

    // wrong guess gets recorded with pct
    gameState.guesses.push({from: msg.from, txt: msg.txt, pct});

    // autoadvance after guess
    advanceTurn();

    sendState();
  }

  /* [15] WIN OVERLAY ------------------------------------------------------ */
  function showWinOverlay(){
    const o = document.getElementById('win-overlay');
    if (!o.classList.contains('show')){
      o.classList.add('show');
    }
    const title = document.getElementById('win-title');
    const sub   = document.getElementById('win-sub');
    const img   = document.getElementById('win-img');

    title.innerText = `${gameState.winner || 'Someone'} wins!`;
    sub.innerText   = `They guessed: ${gameState.ans || '???'}`;

    if (gameImg) img.src = gameImg;
  }

  function hideWinOverlay(){
    const o = document.getElementById('win-overlay');
    o.classList.remove('show');
  }

  /* [16] SMALL UTILS ------------------------------------------------------ */
  function copyCode(){
    if (!roomCode) return;
    navigator.clipboard.writeText(roomCode);
    alert('Room code copied: ' + roomCode);
  }

  // keep selects synced on load
  window.addEventListener('load', ()=>{
    syncSkinSelects();
  });
</script>

</body>
</html>
