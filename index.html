<!DOCTYPE html>
<html lang="en">
<!-- 
    REVEAL! v4.0 - THE LAYOUT OVERHAUL
    - STRUCTURE: 3-Column Grid (Players | Game | Guesses).
    - JUMBOTRON: Split into Small Tracker Grid + Big Call Box.
    - LOGIC: Tile 23 is normal on card, but turns into Pyramid in the Call Box.
    - CONTROLS: "Guess" launches input directly (no confirm).
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REVEAL! v4.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1e1b4b;
            --panel-bg: rgba(0,0,0,0.3);
            --accent: #facc15; /* Gold */
            --text-main: #fff;
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
            --tile-off: #334155;
            --tile-on: #22c55e;
        }

        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg-color); color: var(--text-main);
            font-family: var(--font-body);
            display: grid;
            grid-template-columns: 200px 1fr 200px; /* Sidebars fixed, Center flex */
            grid-template-rows: 1fr; /* Full height */
            overflow: hidden;
        }

        /* --- SIDEBARS --- */
        .sidebar {
            background: rgba(0,0,0,0.2);
            border-left: 1px solid rgba(255,255,255,0.1);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
            padding: 10px; overflow-y: auto;
        }
        .sb-header { font-family: var(--font-head); text-align: center; margin-bottom: 10px; opacity: 0.7; }
        .list-item { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        
        /* --- CENTER STAGE --- */
        #main-stage {
            display: grid;
            grid-template-rows: auto auto 1fr auto auto; /* Header, Tracker, Card, Controls, Chat */
            gap: 10px;
            padding: 10px;
            height: 100vh;
            overflow-y: auto;
        }

        /* ROW 1: HEADER INFO */
        #header-row {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; /* Host, Cat, Code, Style */
            gap: 10px;
            background: var(--panel-bg);
            padding: 10px; border-radius: 10px;
            align-items: center;
        }
        .info-box { text-align: center; }
        .info-label { font-size: 0.6rem; opacity: 0.6; text-transform: uppercase; font-weight: 900; }
        .info-val { font-weight: bold; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #room-code-box { 
            font-family: 'Courier New', monospace; cursor: pointer; 
            background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px;
            transition: background 0.2s;
        }
        #room-code-box:active { background: var(--accent); color: black; }

        /* ROW 2: NUMBER TRACKER */
        #tracker-row {
            display: grid;
            grid-template-columns: 1fr 120px; /* Grid takes space, Call box fixed width */
            gap: 10px;
            background: var(--panel-bg);
            padding: 10px; border-radius: 10px;
        }
        
        /* The Small 5x5 Grid for Called Numbers */
        #mini-tracker {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            height: 100px; /* Fixed height for consistency */
        }
        .trk-dot {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: bold; border-radius: 4px;
        }
        .trk-dot.active { background: var(--accent); color: black; box-shadow: 0 0 5px var(--accent); }

        /* The Call Box (Jumbotron) */
        #call-display {
            background: black; border: 2px solid white; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .call-text { font-family: var(--font-head); font-size: 3rem; color: white; }
        
        /* The Pyramid (Only appears here for #23) */
        .pyramid {
            width: 0; height: 0; 
            border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 50px solid #fbbf24;
            position: relative; animation: popIn 0.3s;
        }
        .pyramid::after {
            content: '23'; position: absolute; bottom: -45px; left: -12px;
            color: black; font-weight: bold; font-family: var(--font-head); font-size: 1rem;
        }

        /* ROW 3: THE CARD (CENTER STAGE) */
        #card-container {
            display: flex; align-items: center; justify-content: center;
            min-height: 0; /* Important for flex/grid nesting */
        }
        #the-card {
            width: 100%; max-width: 500px; aspect-ratio: 1/1;
            background: #000; border: 5px solid white; border-radius: 10px;
            position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #target-image { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
        #tile-grid {
            position: absolute; inset: 0; 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 1px;
        }
        .tile {
            background: var(--tile-color); color: rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-head); font-size: 2rem; cursor: pointer;
            transition: opacity 0.2s;
        }
        .tile.revealed { opacity: 0; pointer-events: none; }

        /* ROW 4: CONTROLS */
        #controls-row {
            display: flex; gap: 10px; height: 60px;
        }
        .control-btn {
            flex: 1; border: none; border-radius: 10px;
            font-family: var(--font-head); font-size: 1.2rem; cursor: pointer;
            transition: transform 0.1s;
        }
        .control-btn:active { transform: translateY(2px); }
        .btn-guess { background: var(--accent); color: #000; }
        .btn-pass { background: #ef4444; color: #fff; }
        .btn-call { background: #fff; color: #000; font-size: 1.5rem; }

        /* ROW 5: CHAT */
        #chat-row {
            height: 50px; display: flex; gap: 10px;
        }
        #chat-input { flex: 1; padding: 10px; border-radius: 8px; border: none; outline: none; font-family: var(--font-body); }
        #chat-send { width: 60px; border-radius: 8px; border: none; background: #3b82f6; color: white; cursor: pointer; font-weight: bold; }

        /* GUESS INPUT OVERLAY */
        #guess-input-container {
            display: none; width: 100%; gap: 10px;
        }
        #text-guess { flex: 1; padding: 10px; border-radius: 8px; font-size: 1.2rem; border: none; outline: none; }
        
        /* UTILS */
        .hidden { display: none !important; }
        @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }
        
        /* Mobile Stack */
        @media (max-width: 800px) {
            body { grid-template-columns: 1fr; } /* Stack columns */
            .sidebar { display: none; } /* Hide sidebars on phone, put in drawer later */
            #header-row { grid-template-columns: 1fr 1fr; } /* 2x2 header */
        }
    </style>
</head>
<body>

    <!-- LEFT COLUMN: PLAYERS -->
    <div class="sidebar" id="col-players">
        <div class="sb-header">PLAYERS</div>
        <div id="list-players"></div>
    </div>

    <!-- CENTER COLUMN: GAME -->
    <div id="main-stage">
        
        <!-- ROW 1: HEADER -->
        <div id="header-row">
            <div class="info-box">
                <div class="info-label">HOST</div>
                <div class="info-val" id="disp-host">???</div>
            </div>
            <div class="info-box">
                <div class="info-label">CATEGORY</div>
                <div class="info-val" id="disp-cat">???</div>
            </div>
            <div class="info-box">
                <div class="info-label">CODE</div>
                <div class="info-val" id="room-code-box" onclick="copyCode()">ABCD</div>
            </div>
            <div class="info-box">
                <div class="info-label">STYLE</div>
                <select id="style-select" onchange="applySkin(this.value)" style="padding:0; width:100%; text-align:center; background:transparent; color:white; border:none; font-weight:bold; font-size:0.8rem;">
                    <option value="vibrant">Vibrant</option>
                    <option value="dark">Dark</option>
                    <option value="retro">Retro</option>
                    <!-- Add others -->
                </select>
            </div>
        </div>

        <!-- ROW 2: TRACKER + JUMBOTRON -->
        <div id="tracker-row">
            <div id="mini-tracker">
                <!-- 1-25 generated by JS -->
            </div>
            <div id="call-display">
                <div class="call-text">--</div>
            </div>
        </div>

        <!-- ROW 3: THE CARD -->
        <div id="card-container">
            <div id="the-card">
                <img id="target-image" src="">
                <div id="tile-grid"></div>
            </div>
        </div>

        <!-- ROW 4: CONTROLS -->
        <div id="controls-row">
            <!-- Dynamic content based on Host vs Player -->
            <button class="control-btn btn-call" id="btn-host-action" onclick="hostAction()">CALL NUMBER</button>
            
            <div id="player-actions" style="display:none; width:100%; gap:10px;">
                <button class="control-btn btn-guess" onclick="showGuessInput()">GUESS</button>
                <button class="control-btn btn-pass" onclick="passTurn()">PASS</button>
            </div>

            <div id="guess-input-container">
                <input type="text" id="text-guess" placeholder="TYPE IT...">
                <button class="control-btn btn-guess" onclick="submitGuess()">SEND</button>
                <button class="control-btn
