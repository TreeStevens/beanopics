<!DOCTYPE html>
<html lang="en">
<!--
REVEAL! v5.0.4
(Solid Tiles + Turn Logic Fix + UI Polish)

CHANGES IN THIS VERSION (v5.0.4)
#5 CSS: .c-tile is now 100% Opaque (Solid). No image bleed-through.
#5 CSS: #game-style-pick width set to auto/min-width to fit text.
#18 LOGIC: Fixed "Player 2 starts Round 1" bug. Rotation now starts after Round 1.
#20 UI: Tiles remain solid until explicitly clicked/revealed.

TEST CHECKLIST:
1. Tiles are solid color (cannot see image underneath).
2. Style dropdown text is fully visible.
3. Round 1 starts with the first player in the list.
4. Round 2 rotates to the second player.
-->

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>REVEAL! v5.0.4</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/*
========================================
#2 THEME CONFIGURATION
========================================
*/
:root{
  --bg-color:#0f172a;
  --glass-bg:rgba(30, 41, 59, 0.9);
  --glass-border:rgba(255,255,255,0.15);
  --accent:#2dd4bf;
  --accent-text:#000;
  --danger:#ef4444;
  --success:#22c55e;
  --text-main:#fff;
  --font-head:'Fredoka One',cursive;
  --font-body:'Nunito',sans-serif;
  --tile-off:#1e293b;
  --tile-pulse:rgba(250, 204, 21, 0.8);
}

*{box-sizing:border-box}
body{
  margin:0; height:100vh; width:100vw; overflow:hidden;
  background:var(--bg-color); color:var(--text-main);
  font-family:var(--font-body);
  display:flex; align-items:center; justify-content:center;
}

.screen{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background:var(--bg-color);
  transform:translateX(100%); transition:transform .25s cubic-bezier(0.4, 0, 0.2, 1);
  z-index:10;
}
.screen.active{transform:translateX(0); z-index:20;}

/* Animations */
@keyframes pulseTile { 
  0%{box-shadow:inset 0 0 0 0px var(--tile-pulse);} 
  50%{box-shadow:inset 0 0 0 4px var(--tile-pulse);} 
  100%{box-shadow:inset 0 0 0 0px var(--tile-pulse);} 
}
@keyframes popIn { 0%{transform:scale(0.5); opacity:0;} 80%{transform:scale(1.1);} 100%{transform:scale(1); opacity:1;} }

/*
========================================
#4 SHARED COMPONENTS
========================================
*/
.card-panel{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:24px;
  width:90%; max-width:420px;
  padding:32px 24px;
  backdrop-filter:blur(12px);
  box-shadow:0 20px 40px rgba(0,0,0,.4);
  text-align:center;
}
h1,h2{margin:0 0 16px 0; font-family:var(--font-head); letter-spacing:0.5px;}

.control-group{margin:16px 0; text-align:left;}
label{display:block; font-weight:900; font-size:.7rem; opacity:.7; text-transform:uppercase; margin-bottom:6px;}
input, select{
  width:100%; border:none; border-radius:12px; padding:14px;
  font-family:var(--font-body); font-weight:800; font-size:1.1rem;
  background:rgba(0,0,0,0.3); color:#fff; outline:none;
  border:2px solid transparent; transition:border-color .2s;
}
input:focus{border-color:var(--accent);}

.big-btn{
  width:100%; border:none; border-radius:14px; padding:16px;
  font-family:var(--font-head); font-size:1.2rem;
  background:var(--accent); color:var(--accent-text);
  cursor:pointer; box-shadow:0 6px 0 rgba(0,0,0,.3);
  transition:transform .1s, box-shadow .1s; margin-top:12px;
}
.big-btn:active:not(:disabled){transform:translateY(3px); box-shadow:none;}
.big-btn:disabled{opacity:0.5; cursor:not-allowed; filter:grayscale(1);}
.big-btn.secondary{background:rgba(255,255,255,0.1); color:#fff; box-shadow:none;}

/*
========================================
#5 APP LAYOUT
========================================
*/
#app-grid{
  display:grid;
  width:100%; max-width:1200px; height:100%;
  grid-template-columns: 280px 1fr;
  grid-template-rows: 120px 40px 1fr 100px;
  overflow:hidden;
}

/* HEADER */
#area-sky{
  grid-column: 1 / -1; grid-row: 1;
  display:flex; justify-content:space-between; align-items:center;
  z-index:50; padding:10px 20px;
  pointer-events:none;
}

.stats-pill{
  pointer-events:auto;
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  backdrop-filter:blur(10px);
  border-radius:20px;
  padding:10px 24px;
  display:flex; align-items:center; gap:24px;
  box-shadow:0 10px 20px rgba(0,0,0,0.2);
}
.sb-item{text-align:center;}
.sb-val{font-family:var(--font-head); font-size:1.8rem; line-height:1; font-variant-numeric:tabular-nums;}
.sb-lbl{font-size:.65rem; font-weight:900; opacity:.6; text-transform:uppercase; letter-spacing:1px; margin-top:4px;}
.val-red{color:var(--danger);}

.call-box-container{
  pointer-events:auto;
  display:flex; flex-direction:column; align-items:center;
}
.call-box{
  background:#fff; color:#000;
  border-radius:16px; width:90px; height:90px;
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-head); font-size:4rem;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  animation:popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.call-lbl{
  font-family:var(--font-head); font-size:0.8rem; margin-top:6px; 
  text-shadow:0 2px 4px rgba(0,0,0,0.5); opacity:0.8;
}

/* TICKER */
#area-ticker{
  grid-column: 2; grid-row: 2;
  display:flex; justify-content:center; align-items:center; gap:16px;
  font-weight:900; text-transform:uppercase; letter-spacing:1px; font-size:.8rem;
  z-index:40;
}
.tick-cat{font-size:1.2rem; color:var(--accent); text-shadow:0 2px 10px rgba(0,0,0,0.5);}

/* SIDEBAR */
#area-sidebar{
  grid-column: 1; grid-row: 2 / span 3;
  background:rgba(0,0,0,0.2);
  border-right:1px solid var(--glass-border);
  display:flex; flex-direction:column;
  overflow:hidden;
}
.sb-section{padding:16px; overflow-y:auto; flex:1;}
.sb-section h3{
  font-family:var(--font-head); font-size:1rem; opacity:0.5; margin:0 0 10px 0; text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:6px;
}
.player-row{
  display:flex; align-items:center; gap:12px;
  padding:8px; border-radius:8px; margin-bottom:4px;
  background:rgba(255,255,255,0.05); transition:background .2s;
}
.player-row.is-host{background:transparent; border:1px dashed rgba(255,255,255,0.15);}
.player-row.active{background:rgba(255,255,255,0.15); border-left:4px solid var(--accent);}
.mini-grid{
  display:grid; grid-template-columns:repeat(5,1fr); gap:1px;
  width:25px; height:25px; opacity:.8; flex-shrink:0;
}
.mg-cell{background:rgba(255,255,255,0.2); width:100%; height:100%;}
.mg-cell.hit{background:var(--accent);}
.p-name{font-weight:800; font-size:.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.badge-you{font-size:.6rem; background:#fff; color:#000; padding:1px 4px; border-radius:4px; margin-left:6px;}
.guess-row{
  font-size:.85rem; opacity:.8; padding:8px; border-bottom:1px solid rgba(255,255,255,0.1);
  background:rgba(0,0,0,0.2); border-radius:6px; margin-bottom:4px;
}
.guess-rnd{font-size:.65rem; opacity:.6; float:right; margin-top:2px;}

/* STAGE */
#area-stage{
  grid-column: 2; grid-row: 3;
  display:flex; align-items:center; justify-content:center;
  position:relative; padding:20px;
}
#card-container{
  width:100%; max-width:500px; aspect-ratio:1/1;
  background:#000; border-radius:16px;
  position:relative; overflow:hidden;
  box-shadow:0 30px 60px rgba(0,0,0,0.5);
}
#card-img{width:100%; height:100%; object-fit:cover; display:block; position:absolute; inset:0;}
#card-grid{
  position:absolute; inset:0; z-index:10;
  display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(5,1fr);
  gap:1px;
}
.c-tile{
  background:var(--tile-off);
  color:#fff; /* Contrast for numbers */
  opacity: 1; /* SOLID OPAQUE - NO PEEKING */
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-head); font-size:2.2rem;
  cursor:pointer; user-select:none;
  transition: opacity 0.2s ease;
}
.c-tile.revealed{opacity:0; pointer-events:none;}
.c-tile.missed{
  color:var(--accent); 
  border:4px solid var(--accent); /* Inset border */
  animation:pulseTile 5s infinite;
}

/* HOST JUDGMENT */
#host-dashboard-overlay{
  position:absolute; inset:0; z-index:20;
  background:rgba(0,0,0,0.85);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:20px; text-align:center;
  backdrop-filter:blur(8px);
}
.vs-card{
  width:100%; padding:20px; background:var(--glass-bg);
  border:1px solid var(--glass-border); border-radius:16px;
}
.vs-lbl{font-size:0.7rem; font-weight:900; opacity:0.6; text-transform:uppercase; margin-bottom:4px;}
.vs-val{font-size:1.5rem; font-family:var(--font-head); color:#fff; margin-bottom:16px;}
.vs-val.highlight{color:var(--accent); font-size:2rem;}

/* CONSOLE */
#area-console{
  grid-column: 2; grid-row: 4;
  background:var(--glass-bg);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--glass-border);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 20px; gap:16px;
  z-index:60;
}
.console-center{flex:1; display:flex; justify-content:center; gap:10px;}
.console-btn{
  flex:1; max-width:240px; height:64px;
  border:none; border-radius:16px;
  font-family:var(--font-head); font-size:1.4rem;
  cursor:pointer; box-shadow:0 5px 0 rgba(0,0,0,0.3);
  transition:transform .1s;
}
.console-btn:active:not(:disabled){transform:translateY(3px); box-shadow:none;}
.console-btn:disabled{opacity:.4; cursor:not-allowed; filter:grayscale(1); transform:none; box-shadow:none;}
.btn-primary{background:var(--accent); color:var(--accent-text);}
.btn-danger{background:var(--danger); color:#fff;}
.btn-success{background:var(--success); color:#fff;}
.btn-neutral{background:rgba(255,255,255,0.15); color:#fff; box-shadow:none;}

/* Aux Buttons */
.aux-btn{
  height:50px; padding:0 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.2);
  background:rgba(0,0,0,0.3); color:#fff; font-weight:900; font-size:0.8rem;
  cursor:pointer; display:flex; align-items:center; gap:6px;
  min-width: 140px; /* Ensure width for style name */
}
select.aux-btn{appearance:none; outline:none; color:var(--accent);}

#console-input-wrap{display:none; width:100%; max-width:600px; gap:10px;}

/* RESPONSIVE */
@media (max-width: 900px){
  #app-grid{
    grid-template-columns: 1fr;
    grid-template-rows: 120px 30px 1fr 100px;
  }
  #area-sidebar{display:none;}
  #area-ticker{grid-column: 1;}
  #area-console{grid-column: 1;}
}

/* WIN OVERLAY */
#win-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.9);
  z-index:100; display:none; flex-direction:column;
  align-items:center; justify-content:center; padding:20px;
}
#win-card{
  background:#fff; border-radius:24px; padding:24px;
  width:100%; max-width:400px; text-align:center;
  color:#0f172a;
}

#toast{
  position:fixed; bottom:120px; left:50%; transform:translateX(-50%);
  background:rgba(15,23,42,.96); color:#fbbf24;
  padding:10px 16px; border-radius:999px;
  font-size:.9rem; font-weight:900;
  z-index:999; opacity:0; pointer-events:none; transition:opacity .2s ease;
}
#toast.show{opacity:1;}
</style>
</head>
<body>

<!-- SETUP SCREENS -->
<div id="screen-lobby" class="screen active">
  <div class="card-panel">
    <h1>REVEAL! v5.0.4</h1>
    <button class="big-btn" onclick="showHostSetup()">HOST GAME</button>
    <button class="big-btn secondary" onclick="showJoinSetup()">JOIN GAME</button>
  </div>
</div>

<div id="screen-host-setup" class="screen">
  <div class="card-panel">
    <h2>SETUP</h2>
    <input id="host-name" type="text" placeholder="Host Name" class="control-group">
    <input id="game-cat" type="text" placeholder="Category (e.g. 80s Movies)" class="control-group">
    <input id="game-ans" type="text" placeholder="Secret Answer" class="control-group">
    <div class="control-group">
      <label>IMAGE</label>
      <input id="img-upload" type="file" accept="image/*" onchange="processImage()">
    </div>
    <div class="control-group">
      <label>STYLE</label>
      <select id="host-style" onchange="setMySkin(this.value)"></select>
    </div>
    <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
  </div>
</div>

<div id="screen-join-code" class="screen">
  <div class="card-panel">
    <h2>ENTER CODE</h2>
    <input id="join-code" type="text" maxlength="4" placeholder="ABCD" style="text-align:center; letter-spacing:5px; text-transform:uppercase;">
    <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
    <div style="margin-top:20px; font-size:0.8rem; opacity:0.6;">Stuck? Disable VPN/AdBlock.</div>
  </div>
</div>

<div id="screen-join-setup" class="screen">
  <div class="card-panel">
    <h2>JOINING...</h2>
    <div id="join-room-disp" style="opacity:0.7; font-weight:900;">ROOM FOUND</div>
    <input id="join-name" type="text" placeholder="Your Name" class="control-group">
    <select id="join-style" onchange="setMySkin(this.value)" class="control-group"></select>
    <button class="big-btn" id="btn-enter" onclick="enterGame()">ENTER</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
  </div>
</div>

<!-- GAME APP -->
<div id="screen-game" class="screen">
  <div id="app-grid">
    
    <!-- SKY -->
    <div id="area-sky">
      <div class="stats-pill">
        <div class="sb-item">
          <div class="sb-val" id="disp-timer">2:00</div>
          <div class="sb-lbl">TIMER</div>
        </div>
        <div class="sb-item">
          <div class="sb-val" id="disp-round">0</div>
          <div class="sb-lbl">ROUND</div>
        </div>
      </div>

      <div class="call-box-container">
        <div class="call-box" id="disp-call">--</div>
        <div class="call-lbl">CALLED</div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div id="area-sidebar">
      <div class="sb-section" style="flex:1; border-bottom:1px solid rgba(255,255,255,0.1);">
        <h3>PLAYERS</h3>
        <div id="list-players"></div>
      </div>
      <div class="sb-section" style="height:35%;">
        <h3>GUESSES</h3>
        <div id="list-guesses"></div>
      </div>
    </div>

    <!-- TICKER -->
    <div id="area-ticker">
      <span class="tick-cat" id="disp-cat">CATEGORY</span>
      <span>â€¢</span>
      <span class="tick-stat" id="disp-status">WAITING</span>
    </div>

    <!-- STAGE -->
    <div id="area-stage">
      <div id="card-container">
        <img id="card-img" src="">
        
        <!-- PLAYER GRID -->
        <div id="card-grid"></div>
        
        <!-- HOST JUDGMENT -->
        <div id="host-dashboard-overlay" style="display:none;">
          <div class="vs-card">
            <div class="vs-lbl">PLAYER GUESS</div>
            <div class="vs-val highlight" id="host-judge-guess">???</div>
            <div style="font-size:0.9rem; opacity:0.5; margin:10px 0;">VS</div>
            <div class="vs-lbl">SECRET ANSWER</div>
            <div class="vs-val" id="host-judge-ans">???</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONSOLE -->
    <div id="area-console">
      
      <!-- Style Picker -->
      <select id="game-style-pick" class="aux-btn" onchange="setMySkin(this.value)">
        <option value="modern_dark">Style...</option>
      </select>

      <div class="console-center">
        <!-- HOST -->
        <div id="host-controls" style="display:none; gap:10px;">
          <button id="btn-host-call" class="console-btn btn-primary" onclick="hostCall()">CALL NEXT</button>
          <button id="btn-host-wrong" class="console-btn btn-danger" onclick="hostJudge(false)" style="display:none;">WRONG</button>
          <button id="btn-host-right" class="console-btn btn-success" onclick="hostJudge(true)" style="display:none;">RIGHT</button>
        </div>

        <!-- PLAYER -->
        <div id="player-controls" style="display:none; gap:10px;">
          <button id="btn-pass" class="console-btn btn-danger" onclick="passTurn()">PASS</button>
          <button id="btn-guess" class="console-btn btn-primary" onclick="openGuess()">GUESS</button>
        </div>

        <!-- INPUT -->
        <div id="console-input-wrap">
          <input id="guess-input" type="text" placeholder="TYPE GUESS...">
          <button class="console-btn btn-primary" onclick="sendGuess()">SEND</button>
          <button class="console-btn btn-neutral" onclick="closeGuessUI()" style="max-width:80px;">X</button>
        </div>
      </div>

      <!-- Room Code -->
      <button id="btn-room-code" class="aux-btn" onclick="copyCode()" style="display:none;">
        CODE: <span id="disp-code" style="font-size:1rem; margin-left:6px;"></span>
      </button>

    </div>

  </div>
</div>

<!-- WIN OVERLAY -->
<div id="win-overlay">
  <div id="win-card">
    <h1 id="win-title" style="color:#000;">WINNER!</h1>
    <h3 id="win-sub" style="color:#666;">Guess</h3>
    <img id="win-img" src="" style="width:100%; border-radius:12px; margin-top:10px;">
    <button class="big-btn secondary" style="background:#0f172a; margin-top:20px;" onclick="document.getElementById('win-overlay').style.display='none'">CLOSE</button>
  </div>
</div>

<div id="toast"></div>

<!-- LOGIC -->
<script>
const SKINS = {
  modern_dark: { label:"Modern Dark", bg:"#0f172a", acc:"#2dd4bf", text:"#fff", tile:"#1e293b" },
  neon_grape: { label:"Neon Grape", bg:"#4c1d95", acc:"#d946ef", text:"#fff", tile:"#312e81" },
  dark_academia:{ label:"Dark Academia", bg:"#12100e", acc:"#d6ad60", text:"#f5efe6", tile:"#2a2420" },
  art_deco: { label:"Art Deco", bg:"#0b1220", acc:"#f5c542", text:"#f8fafc", tile:"#1f2937" },
  midnight_gold:{ label:"Midnight Gold", bg:"#18181b", acc:"#facc15", text:"#f4f4f5", tile:"#27272a" },
  storm_slate: { label:"Storm Slate", bg:"#0f172a", acc:"#38bdf8", text:"#e2e8f0", tile:"#1f2937" },
  miami_sunset: { label:"Miami Sunset", bg:"#7c2d12", acc:"#fb7185", text:"#fff7ed", tile:"#451a03" },
  cryptid_forest:{label:"Cryptid Forest", bg:"#064e3b", acc:"#a7f3d0", text:"#ecfdf5", tile:"#052e16" },
  killer_carnival:{label:"Killer Carnival",bg:"#3b0764",acc:"#f472b6", text:"#fae8ff", tile:"#1f0933" },
  blue_ice: { label:"Blue Ice", bg:"#0c4a6e", acc:"#a5f3fc", text:"#ecfeff", tile:"#083344" },
  lava_lamp: { label:"Lava Lamp", bg:"#7f1d1d", acc:"#fdba74", text:"#fff7ed", tile:"#3f0b0b" },
  old_paper: { label:"Old Paper", bg:"#1c1917", acc:"#fbbf24", text:"#fef3c7", tile:"#292524" },
  mono_punch: { label:"Mono Punch", bg:"#111827", acc:"#ffffff", text:"#ffffff", tile:"#374151" }
};

let mySkinKey = localStorage.getItem("reveal_skin") || "modern_dark";
let myName="", roomCode="", isHost=false, client=null, gameImg=null;
let gameState = {
  host:"", cat:"", ans:"", players:[],
  activeIdx:0, roundStartIdx:0, round:0, 
  phase:"CALL", pendingGuess:null,
  guesses:[], revealed:[], status:"WAITING", winner:""
};
let myClicked = new Set();
let timerSec=120;
const TURN_CHIME = new Audio("chime.mp3"); 

const BROKER = "wss://broker.emqx.io:8084/mqtt";
const TOPIC_PRE = "reveal_v5_0";

function handleMsg(topic, m){
  const msg = JSON.parse(m.toString());
  if(msg.type==="STATE"){
    const oldTurn = getActivePlayerName();
    const oldPhase = gameState.phase;
    gameState = msg.state || gameState;
    if(msg.img) gameImg = msg.img;
    
    if(getActivePlayerName() !== oldTurn || (oldPhase!=="TURNS" && gameState.phase==="TURNS")){
      timerSec = 120;
    }
    if(document.getElementById("screen-join-code").classList.contains("active")){
      goTo("screen-join-setup");
      document.getElementById("join-room-disp").textContent = "ROOM: "+roomCode;
    }
    updateUI();
  }
  if(isHost) hostHandleMsg(msg);
}

function sendState(){
  if(client && client.connected && isHost){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"STATE", state:gameState, img:gameImg}));
  }
}

function hostHandleMsg(msg){
  if(msg.type==="REQ_STATE") sendState();
  if(msg.type==="JOIN"){
    const n = (msg.name||"").trim();
    if(n && !gameState.players.some(p=>p.name===n)){
      gameState.players.push({name:n});
      sendState();
    }
  }
  if(msg.type==="PASS" && gameState.phase==="TURNS" && isActivePlayer(msg.from)){
    advanceTurn();
    sendState();
  }
  if(msg.type==="GUESS" && gameState.phase==="TURNS" && isActivePlayer(msg.from)){
    gameState.pendingGuess = {from:msg.from, txt:msg.txt};
    gameState.phase = "ADJUDICATE";
    sendState();
  }
}

function hostCall(){
  const avail = [];
  for(let i=1; i<=25; i++) if(!gameState.revealed.includes(i)) avail.push(i);
  if(avail.length === 0) return;
  const pick = avail[Math.floor(Math.random()*avail.length)];
  gameState.revealed.push(pick);
  
  // FIX: Rotation Logic
  gameState.round++;
  // If Round 1 (first ever), start with index 0. If > 1, rotate.
  if (gameState.round > 1) {
    gameState.roundStartIdx = (gameState.roundStartIdx + 1) % (gameState.players.length || 1);
  } else {
    gameState.roundStartIdx = 0;
  }
  
  gameState.activeIdx = gameState.roundStartIdx;
  gameState.phase = "TURNS";
  gameState.pendingGuess = null;
  sendState();
}

function hostJudge(isRight){
  const pg = gameState.pendingGuess;
  if(isRight){
    gameState.status = "WIN";
    gameState.phase = "WIN";
    gameState.winner = pg.from;
    gameState.winGuess = pg.txt;
    gameState.revealed = Array.from({length:25},(_,i)=>i+1);
    sendState();
    showWin(pg.from, pg.txt);
  } else {
    gameState.guesses.push({from:pg.from, txt:pg.txt, round:gameState.round});
    gameState.phase = "TURNS";
    gameState.pendingGuess = null;
    advanceTurn();
    sendState();
  }
}

function advanceTurn(){
  gameState.activeIdx = (gameState.activeIdx + 1) % gameState.players.length;
  if(gameState.activeIdx === gameState.roundStartIdx) gameState.phase = "CALL";
}

function passTurn(){ client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"PASS", from:myName})); closeGuessUI(); }
function sendGuess(){
  const txt = document.getElementById("guess-input").value;
  if(txt) client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"GUESS", from:myName, txt:txt}));
  closeGuessUI();
}

function updateUI(){
  document.getElementById("disp-round").textContent = gameState.round;
  document.getElementById("disp-call").textContent = gameState.revealed[gameState.revealed.length-1] || "--";
  document.getElementById("disp-cat").textContent = gameState.cat;
  
  let statusTxt = "WAITING";
  if(gameState.phase==="CALL") statusTxt = "HOST IS CALLING...";
  if(gameState.phase==="TURNS") statusTxt = `TURN: ${getActivePlayerName()}`;
  if(gameState.phase==="ADJUDICATE") statusTxt = "JUDGING GUESS...";
  if(gameState.phase==="WIN") statusTxt = "GAME OVER";
  document.getElementById("disp-status").textContent = statusTxt;

  // HOST JUDGE UI
  if(isHost && gameState.phase==="ADJUDICATE" && gameState.pendingGuess){
    document.getElementById("host-dashboard-overlay").style.display="flex";
    document.getElementById("host-judge-guess").textContent = gameState.pendingGuess.txt;
    document.getElementById("host-judge-ans").textContent = gameState.ans;
    document.getElementById("card-grid").style.display="none";
  } else {
    document.getElementById("host-dashboard-overlay").style.display="none";
    if(!isHost) document.getElementById("card-grid").style.display="grid";
  }

  // PLAYERS
  const pl = document.getElementById("list-players");
  pl.innerHTML = `<div class="player-row is-host"><div class="p-name" style="width:100%;text-align:center;">HOST: ${gameState.host}</div></div>`;
  const ap = getActivePlayerName();
  gameState.players.forEach(p=>{
    const row = document.createElement("div");
    row.className = "player-row" + (p.name===ap ? " active" : "");
    const mg = document.createElement("div");
    mg.className = "mini-grid";
    generateGridFor(p.name).forEach(n=>{
      const d = document.createElement("div");
      d.className = "mg-cell" + (gameState.revealed.includes(n) ? " hit" : "");
      mg.appendChild(d);
    });
    row.appendChild(mg);
    const nDiv = document.createElement("div");
    nDiv.className = "p-name";
    nDiv.textContent = p.name;
    if(p.name===myName) nDiv.innerHTML += `<span class='badge-you'>YOU</span>`;
    row.appendChild(nDiv);
    pl.appendChild(row);
  });

  // MAIN CARD
  if(!isHost){
    const nums = generateGridFor(myName);
    const grid = document.getElementById("card-grid");
    grid.innerHTML = "";
    nums.forEach(n=>{
      const d = document.createElement("div");
      d.className = "c-tile";
      d.textContent = n;
      const isCalled = gameState.revealed.includes(n);
      const isClicked = myClicked.has(n);
      
      if(isClicked) d.classList.add("revealed");
      else if(isCalled) d.classList.add("missed");
      
      d.onclick = function(){
        if(isCalled){
          this.classList.add("revealed");
          this.classList.remove("missed");
          myClicked.add(n);
          localStorage.setItem('reveal_click_'+roomCode, JSON.stringify([...myClicked]));
        }
      }
      grid.appendChild(d);
    });
  } else {
    if(gameState.phase!=="ADJUDICATE") document.getElementById("card-grid").style.display="none"; 
  }
  
  if(gameImg) document.getElementById("card-img").src = gameImg;

  // CONSOLE
  const areaConsole = document.getElementById("area-console");
  const hostCtrl = document.getElementById("host-controls");
  const plyrCtrl = document.getElementById("player-controls");
  const inputCtrl = document.getElementById("console-input-wrap");
  
  hostCtrl.style.display = "none";
  plyrCtrl.style.display = "none";
  inputCtrl.style.display = "none";

  if(isHost){
    hostCtrl.style.display = "flex";
    if(gameState.phase==="CALL") {
      document.getElementById("btn-host-call").style.display="block";
      document.getElementById("btn-host-wrong").style.display="none";
      document.getElementById("btn-host-right").style.display="none";
    } else if(gameState.phase==="ADJUDICATE"){
      document.getElementById("btn-host-call").style.display="none";
      document.getElementById("btn-host-wrong").style.display="block";
      document.getElementById("btn-host-right").style.display="block";
    } else {
      document.getElementById("btn-host-call").style.display="none";
    }
    document.getElementById("btn-room-code").style.display="flex";
  } else {
    document.getElementById("btn-room-code").style.display="none";
    if(gameState.phase==="TURNS" && isActivePlayer(myName)){
      plyrCtrl.style.display = "flex";
    }
  }
  
  const gl = document.getElementById("list-guesses");
  gl.innerHTML = "";
  gameState.guesses.forEach(g=>{
    const div = document.createElement("div");
    div.className = "guess-row";
    div.innerHTML = `"${g.txt}" <br><span style="font-size:0.75rem;opacity:0.6;">${g.from}</span> <span class="guess-rnd">R${g.round||"?"}</span>`;
    gl.appendChild(div);
  });
  
  if(gameState.phase==="WIN") showWin(gameState.winner, gameState.winGuess);

  document.getElementById("disp-code").textContent = roomCode;
}

function isActivePlayer(n){ return gameState.players[gameState.activeIdx]?.name === n; }
function getActivePlayerName(){ return gameState.players[gameState.activeIdx]?.name || ""; }
function openGuess(){ 
  document.getElementById("player-controls").style.display="none"; 
  document.getElementById("console-input-wrap").style.display="flex"; 
  document.getElementById("guess-input").focus();
}
function closeGuessUI(){ updateUI(); }
function copyCode(){
  navigator.clipboard.writeText(roomCode);
  const t = document.getElementById("toast");
  t.textContent = "CODE COPIED: " + roomCode;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2000);
}

function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
function stringToSeed(str) { let h = 1779033703 ^ str.length; for(let i = 0; i < str.length; i++) { h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h << 13 | h >>> 19; } return function() { h = Math.imul(h ^ (h >>> 16), 2246822507); h = Math.imul(h ^ (h >>> 13), 3266489909); return (h ^= h >>> 16) >>> 0; } }
function generateGridFor(pName) {
  const rng = mulberry32(stringToSeed(roomCode+"_"+pName)());
  let nums = Array.from({length:25},(_,i)=>i+1);
  for(let i=nums.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [nums[i],nums[j]]=[nums[j],nums[i]]; }
  return nums;
}

function processImage(){
  const file = document.getElementById("img-upload").files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement("canvas");
      c.width=700; c.height=700;
      const ctx = c.getContext("2d");
      const s = Math.min(img.width,img.height);
      ctx.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,700,700);
      gameImg = c.toDataURL("image/jpeg",0.8);
      document.getElementById("btn-create").disabled = false;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function createGame(){
  myName = document.getElementById("host-name").value.trim() || "Host";
  gameState.host = myName;
  gameState.cat = document.getElementById("game-cat").value.trim();
  gameState.ans = document.getElementById("game-ans").value.trim();
  roomCode = Math.random().toString(36).slice(2,6).toUpperCase();
  isHost = true;
  
  client = mqtt.connect(BROKER);
  client.on("connect",()=>{
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    sendState();
  });
  client.on("message", handleMsg);
  goTo("screen-game");
  updateUI();
  
  setInterval(()=>{
    if(gameState.phase==="TURNS"){
      timerSec--;
      const el = document.getElementById("disp-timer");
      const abs = Math.abs(timerSec);
      el.textContent = (timerSec<0?"-":"") + Math.floor(abs/60) + ":" + (abs%60).toString().padStart(2,"0");
      if(timerSec<=0) {
        el.style.color = "var(--danger)";
        if(Math.abs(timerSec)%15===0 && isActivePlayer(myName)) TURN_CHIME.play().catch(e=>{});
      } else {
        el.style.color = "";
      }
      if(isActivePlayer(myName)) document.title = (timerSec%2===0) ? "ðŸ”´ YOUR TURN" : "REVEAL!";
      else document.title = "REVEAL!";
    }
  },1000);
}

function searchRoom(){
  roomCode = document.getElementById("join-code").value.trim().toUpperCase();
  const btn = document.getElementById("btn-search");
  btn.textContent = "CONNECTING...";
  client = mqtt.connect(BROKER);
  let cT = setTimeout(()=>{ btn.textContent="BLOCKED (VPN?)"; client.end(); },5000);
  client.on("connect",()=>{
    clearTimeout(cT);
    btn.textContent = "CHECKING ROOM...";
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"REQ_STATE"}));
    setTimeout(()=>{
      if(!gameState.host){ btn.textContent="ROOM NOT FOUND"; client.end(); }
    },5000);
  });
  client.on("message", handleMsg);
}

function enterGame(){
  myName = document.getElementById("join-name").value.trim();
  if(!myName) return;
  const saved = localStorage.getItem('reveal_click_'+roomCode);
  if(saved) myClicked = new Set(JSON.parse(saved));
  client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"JOIN", name:myName}));
  goTo("screen-game");
}

function goTo(id){ document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active")); document.getElementById(id).classList.add("active"); }
function showHostSetup(){ goTo("screen-host-setup"); populateSkinSelect("host-style"); populateSkinSelect("game-style-pick"); }
function showJoinSetup(){ goTo("screen-join-code"); populateSkinSelect("join-style"); populateSkinSelect("game-style-pick"); }

function setMySkin(k){ 
  localStorage.setItem("reveal_skin", k);
  const s = SKINS[k] || SKINS.modern_dark;
  const r = document.documentElement.style;
  r.setProperty("--bg-color",s.bg); r.setProperty("--accent",s.acc); r.setProperty("--tile-off",s.tile);
}
function populateSkinSelect(id){
  const el = document.getElementById(id); if(!el)return; el.innerHTML="";
  Object.keys(SKINS).forEach(k=>el.innerHTML+=`<option value="${k}">${SKINS[k].label}</option>`);
}

function showWin(w,g){
  document.getElementById("win-title").textContent = w + " WINS!";
  document.getElementById("win-sub").textContent = "Guess: " + g;
  document.getElementById("win-img").src = gameImg;
  document.getElementById("win-overlay").style.display = "flex";
}

window.onbeforeunload = ()=> "Game in progress!";
setMySkin(localStorage.getItem("reveal_skin")||"modern_dark");
</script>
</body>
</html>
