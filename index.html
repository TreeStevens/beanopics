<!DOCTYPE html>
<html lang="en">
<!--
REVEAL! v5.0.0
(Modern "App" Layout + Dealer Rotation Fix + Host/Player Split UI)

CHANGES IN THIS VERSION (v5.0.0)
#0 ARCHITECTURE: Complete UI rewrite. "Sky/Stage/Wings/Console" layout.
#6 UI: New "Scoreboard" header (floating glass pill).
#6 UI: New "Console" footer (big touch targets).
#16 LOGIC: Fixed Round counter (starts at 0).
#18 LOGIC: Fixed Dealer Rotation (Active Player correctly rotates each round).
#20 UI: Host sees "Answer Key" floating on stage.
#20 UI: Tiles pulse yellow (missed-call) if valid but unclicked.
#20 UI: Timer goes red/negative in overtime.

TEST CHECKLIST:
1. "Pre-Game" state shows Round 0.
2. Host Call -> Round 1 -> Active Player is correct.
3. Host Call -> Round 2 -> Active Player shifts by +1.
4. Player Console shows PASS/GUESS only on turn.
5. Host Console shows CALL or WRONG/RIGHT.
-->

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>REVEAL! v5.0.0</title>

<!--
========================================
#1 GLOBAL DEPENDENCIES
========================================
-->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/*
========================================
#2 THEME CONFIGURATION (VARS)
========================================
*/
:root{
  --bg-color:#0f172a; /* Slate 900 - Modern Dark */
  --glass-bg:rgba(30, 41, 59, 0.7);
  --glass-border:rgba(255,255,255,0.1);
  --accent:#2dd4bf;
  --accent-text:#000;
  --danger:#ef4444;
  --success:#22c55e;
  --text-main:#fff;
  --font-head:'Fredoka One',cursive;
  --font-body:'Nunito',sans-serif;
  
  --card-bg:#fff;
  --tile-off:#1e293b;
  --tile-pulse:rgba(250, 204, 21, 0.6); /* Yellow */
}

/*
========================================
#3 BASE STYLES & ANIMATIONS
========================================
*/
*{box-sizing:border-box}
body{
  margin:0; height:100vh; width:100vw; overflow:hidden;
  background:var(--bg-color); color:var(--text-main);
  font-family:var(--font-body);
}

/* Screen Transitions */
.screen{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background:var(--bg-color);
  transform:translateX(100%); transition:transform .25s cubic-bezier(0.4, 0, 0.2, 1);
  z-index:10;
}
.screen.active{transform:translateX(0); z-index:20;}

/* Animations */
@keyframes pulseRed { 50% { opacity: 0.5; } }
@keyframes popIn { 0% { transform: scale(0.8); opacity:0; } 100% { transform: scale(1); opacity:1; } }
@keyframes pulseTile { 0%{box-shadow:inset 0 0 0 rgba(255,255,255,0);} 50%{box-shadow:inset 0 0 40px var(--tile-pulse);} 100%{box-shadow:inset 0 0 0 rgba(255,255,255,0);} }

/*
========================================
#4 SHARED COMPONENTS
========================================
*/
.card-panel{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  border-radius:24px;
  width:90%; max-width:420px;
  padding:32px 24px;
  backdrop-filter:blur(12px);
  box-shadow:0 20px 40px rgba(0,0,0,.4);
  text-align:center;
}
h1,h2{margin:0 0 16px 0; font-family:var(--font-head); letter-spacing:0.5px;}

/* Inputs & Buttons */
.control-group{margin:16px 0; text-align:left;}
label{display:block; font-weight:900; font-size:.7rem; opacity:.7; text-transform:uppercase; margin-bottom:6px;}
input, select{
  width:100%; border:none; border-radius:12px; padding:14px;
  font-family:var(--font-body); font-weight:800; font-size:1.1rem;
  background:#1e293b; color:#fff; outline:none;
  border:2px solid transparent; transition:border-color .2s;
}
input:focus{border-color:var(--accent);}

.big-btn{
  width:100%; border:none; border-radius:14px; padding:16px;
  font-family:var(--font-head); font-size:1.2rem;
  background:var(--accent); color:var(--accent-text);
  cursor:pointer; box-shadow:0 6px 0 rgba(0,0,0,.3);
  transition:transform .1s, box-shadow .1s; margin-top:12px;
}
.big-btn:active:not(:disabled){transform:translateY(3px); box-shadow:none;}
.big-btn:disabled{opacity:0.5; cursor:not-allowed; filter:grayscale(1);}
.big-btn.secondary{background:rgba(255,255,255,0.1); color:#fff; box-shadow:none;}

/*
========================================
#5 APP LAYOUT (GRID SYSTEM)
========================================
*/
#app-grid{
  display:grid;
  width:100%; height:100%;
  /* Columns: Wing | Stage | Wing */
  grid-template-columns: 260px 1fr 260px;
  /* Rows: Sky | Ticker | Stage | Console */
  grid-template-rows: 80px 40px 1fr 100px;
  overflow:hidden;
}

/* THE SKY (Header) */
#area-sky{
  grid-column: 1 / -1; grid-row: 1;
  display:flex; justify-content:center; align-items:center;
  z-index:50;
}
.scoreboard-pill{
  background:var(--glass-bg);
  border:1px solid var(--glass-border);
  backdrop-filter:blur(10px);
  border-radius:999px;
  padding:8px 24px;
  display:flex; align-items:center; gap:24px;
  box-shadow:0 10px 20px rgba(0,0,0,0.2);
}
.sb-item{text-align:center;}
.sb-val{font-family:var(--font-head); font-size:1.8rem; line-height:1; font-variant-numeric:tabular-nums;}
.sb-lbl{font-size:.65rem; font-weight:900; opacity:.6; text-transform:uppercase; letter-spacing:1px;}
.val-red{color:var(--danger);}

/* Current Call Box */
.call-box{
  background:#fff; color:#000;
  border-radius:12px; width:60px; height:60px;
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-head); font-size:2.5rem;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

/* THE TICKER (Status Line) */
#area-ticker{
  grid-column: 1 / -1; grid-row: 2;
  display:flex; justify-content:center; align-items:center; gap:16px;
  font-weight:900; text-transform:uppercase; letter-spacing:1px; font-size:.8rem;
  z-index:40;
}
.tick-cat{opacity:.7;}
.tick-stat{color:var(--accent);}

/* THE WINGS (Sidebars) */
.wing{
  grid-row: 3 / span 1;
  overflow-y:auto; padding:20px;
  display:flex; flex-direction:column; gap:12px;
}
#area-left{grid-column: 1;}
#area-right{grid-column: 3;}

/* Sidebar Items */
.wing-head{
  font-family:var(--font-head); opacity:.5; font-size:.9rem; text-align:center; margin-bottom:8px;
}
.player-row{
  display:flex; align-items:center; gap:12px;
  padding:8px; border-radius:8px; transition:background .2s;
}
.player-row.active{background:rgba(255,255,255,0.1); border-left:3px solid var(--accent);}
.mini-grid{
  display:grid; grid-template-columns:repeat(5,1fr); gap:1px;
  width:30px; height:30px; opacity:.8;
}
.mg-cell{background:rgba(255,255,255,0.2); width:100%; height:100%;}
.mg-cell.hit{background:var(--accent);}
.p-name{font-weight:800; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.badge-you{font-size:.6rem; background:#fff; color:#000; padding:1px 4px; border-radius:4px; margin-left:6px;}

.guess-row{
  font-size:.9rem; opacity:.8; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.1);
}

/* THE STAGE (Center) */
#area-stage{
  grid-column: 2; grid-row: 3;
  display:flex; align-items:center; justify-content:center;
  position:relative;
}
#card-container{
  width:100%; max-width:450px; aspect-ratio:1/1;
  background:#fff; border-radius:16px;
  position:relative; overflow:hidden;
  box-shadow:0 30px 60px rgba(0,0,0,0.5);
}
#card-img{width:100%; height:100%; object-fit:cover; display:block;}
#card-grid{
  position:absolute; inset:0;
  display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(5,1fr);
  gap:1px; background:rgba(0,0,0,0.1);
}
.c-tile{
  background:var(--tile-off);
  color:rgba(255,255,255,0.3);
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-head); font-size:2rem;
  cursor:pointer; user-select:none;
}
.c-tile.revealed{opacity:0; pointer-events:none;}
.c-tile.missed{
  color:var(--accent); border:2px solid var(--accent);
  animation:pulseTile 1.5s infinite;
}

/* Host Answer Floating */
#host-floating-ans{
  position:absolute; top:-40px; left:50%; transform:translateX(-50%);
  background:#000; color:var(--accent);
  padding:4px 12px; border-radius:8px; font-weight:900; font-size:.8rem;
  border:1px solid var(--accent);
  display:none;
}

/* THE CONSOLE (Footer) */
#area-console{
  grid-column: 1 / -1; grid-row: 4;
  background:var(--glass-bg);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--glass-border);
  display:flex; align-items:center; justify-content:center;
  padding:0 20px; gap:16px;
  z-index:60;
}
.console-btn{
  flex:1; max-width:200px; height:60px;
  border:none; border-radius:12px;
  font-family:var(--font-head); font-size:1.3rem;
  cursor:pointer; box-shadow:0 5px 0 rgba(0,0,0,0.3);
  transition:transform .1s;
}
.console-btn:active:not(:disabled){transform:translateY(3px); box-shadow:none;}
.console-btn:disabled{opacity:.4; cursor:not-allowed; filter:grayscale(1); transform:none; box-shadow:none;}
.btn-primary{background:var(--accent); color:#000;}
.btn-danger{background:var(--danger); color:#fff;}
.btn-success{background:var(--success); color:#fff;}
.btn-neutral{background:rgba(255,255,255,0.15); color:#fff; box-shadow:none;}

/* Console Input Mode */
#console-input-wrap{
  display:none; width:100%; max-width:600px; gap:10px;
}

/* INFO BAR (Very bottom) */
#info-bar{
  position:absolute; bottom:4px; width:100%; text-align:center;
  font-size:.65rem; opacity:.4; font-weight:900; pointer-events:none; z-index:70;
}

/* RESPONSIVE */
@media (max-width: 900px){
  #app-grid{
    grid-template-columns: 1fr;
    grid-template-rows: 70px 30px 1fr 90px;
  }
  .wing{display:none;} /* Hide wings on mobile for focus */
  #card-container{max-width:90%;}
}

/*
========================================
#6 WIN OVERLAY
========================================
*/
#win-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.85);
  z-index:100; display:none; flex-direction:column;
  align-items:center; justify-content:center; padding:20px;
}
#win-card{
  background:#fff; border-radius:24px; padding:24px;
  width:100%; max-width:400px; text-align:center;
  color:#0f172a;
}
</style>
</head>
<body>

<!--
========================================
#7 LOBBY & SETUP SCREENS
========================================
-->
<div id="screen-lobby" class="screen active">
  <div class="card-panel">
    <h1>REVEAL! v5.0</h1>
    <button class="big-btn" onclick="showHostSetup()">HOST GAME</button>
    <button class="big-btn secondary" onclick="showJoinSetup()">JOIN GAME</button>
  </div>
</div>

<div id="screen-host-setup" class="screen">
  <div class="card-panel">
    <h2>SETUP</h2>
    <input id="host-name" type="text" placeholder="Host Name" class="control-group">
    <input id="game-cat" type="text" placeholder="Category (e.g. 80s Movies)" class="control-group">
    <input id="game-ans" type="text" placeholder="Secret Answer" class="control-group">
    <div class="control-group">
      <label>IMAGE</label>
      <input id="img-upload" type="file" accept="image/*" onchange="processImage()">
    </div>
    <div class="control-group">
      <label>STYLE</label>
      <select id="host-style" onchange="setMySkin(this.value)"></select>
    </div>
    <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
  </div>
</div>

<div id="screen-join-code" class="screen">
  <div class="card-panel">
    <h2>ENTER CODE</h2>
    <input id="join-code" type="text" maxlength="4" placeholder="ABCD" style="text-align:center; letter-spacing:5px; text-transform:uppercase;">
    <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
    <div style="margin-top:20px; font-size:0.8rem; opacity:0.6;">Stuck? Disable VPN/AdBlock.</div>
  </div>
</div>

<div id="screen-join-setup" class="screen">
  <div class="card-panel">
    <h2>JOINING...</h2>
    <div id="join-room-disp" style="opacity:0.7; font-weight:900;">ROOM FOUND</div>
    <input id="join-name" type="text" placeholder="Your Name" class="control-group">
    <select id="join-style" onchange="setMySkin(this.value)" class="control-group"></select>
    <button class="big-btn" id="btn-enter" onclick="enterGame()">ENTER</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
  </div>
</div>

<!--
========================================
#8 MAIN GAME APP
========================================
-->
<div id="screen-game" class="screen">
  <div id="app-grid">
    
    <!-- SKY (Header) -->
    <div id="area-sky">
      <div class="scoreboard-pill">
        <div class="sb-item">
          <div class="sb-val" id="disp-timer">2:00</div>
          <div class="sb-lbl">TIMER</div>
        </div>
        <div class="sb-item">
          <div class="sb-val" id="disp-round">0</div>
          <div class="sb-lbl">ROUND</div>
        </div>
        <div class="call-box" id="disp-call">--</div>
      </div>
    </div>

    <!-- TICKER (Status) -->
    <div id="area-ticker">
      <span class="tick-cat" id="disp-cat">CATEGORY</span>
      <span>â€¢</span>
      <span class="tick-stat" id="disp-status">WAITING</span>
    </div>

    <!-- LEFT WING (Players) -->
    <div id="area-left" class="wing">
      <div class="wing-head">PLAYERS</div>
      <div id="list-players"></div>
    </div>

    <!-- STAGE (Card) -->
    <div id="area-stage">
      <div id="host-floating-ans">ANS: ???</div>
      <div id="card-container">
        <img id="card-img" src="">
        <div id="card-grid"></div>
      </div>
    </div>

    <!-- RIGHT WING (Wrong Guesses) -->
    <div id="area-right" class="wing">
      <div class="wing-head">WRONG GUESSES</div>
      <div id="list-guesses"></div>
    </div>

    <!-- CONSOLE (Footer) -->
    <div id="area-console">
      
      <!-- HOST CONTROLS -->
      <div id="host-controls" style="display:none; width:100%; gap:10px; display:flex;">
        <button id="btn-host-call" class="console-btn btn-primary" onclick="hostCall()">CALL NEXT</button>
        <button id="btn-host-wrong" class="console-btn btn-danger" onclick="hostJudge(false)" style="display:none;">WRONG</button>
        <button id="btn-host-right" class="console-btn btn-success" onclick="hostJudge(true)" style="display:none;">RIGHT</button>
      </div>

      <!-- PLAYER CONTROLS -->
      <div id="player-controls" style="display:none; width:100%; gap:10px; display:flex;">
        <button id="btn-pass" class="console-btn btn-danger" onclick="passTurn()">PASS</button>
        <button id="btn-guess" class="console-btn btn-primary" onclick="openGuess()">GUESS</button>
      </div>

      <!-- INPUT MODE -->
      <div id="console-input-wrap">
        <input id="guess-input" type="text" placeholder="TYPE GUESS...">
        <button class="console-btn btn-primary" onclick="sendGuess()">SEND</button>
        <button class="console-btn btn-neutral" onclick="closeGuessUI()">X</button>
      </div>

    </div>

  </div>
  
  <div id="info-bar">ROOM: <span id="disp-code"></span> | HOST: <span id="disp-host"></span></div>
</div>

<!-- WIN OVERLAY -->
<div id="win-overlay">
  <div id="win-card">
    <h1 id="win-title" style="color:#000;">WINNER!</h1>
    <h3 id="win-sub" style="color:#666;">Guess</h3>
    <img id="win-img" src="" style="width:100%; border-radius:12px; margin-top:10px;">
    <button class="big-btn secondary" style="background:#0f172a; margin-top:20px;" onclick="document.getElementById('win-overlay').style.display='none'">CLOSE</button>
  </div>
</div>

<div id="toast"></div>

<!--
========================================
#9 GAME LOGIC
========================================
-->
<script>
/* --- CONFIG & STATE --- */
const SKINS = {
  modern_dark: { label:"Modern Dark", bg:"#0f172a", acc:"#2dd4bf", text:"#fff", tile:"#1e293b" },
  neon_grape: { label:"Neon Grape", bg:"#4c1d95", acc:"#d946ef", text:"#fff", tile:"#312e81" },
  forest: { label:"Forest", bg:"#064e3b", acc:"#34d399", text:"#ecfdf5", tile:"#065f46" },
};
let mySkinKey = localStorage.getItem("reveal_skin") || "modern_dark";

let myName="", roomCode="", isHost=false, client=null, gameImg=null;
let gameState = {
  host:"", cat:"", ans:"", players:[],
  activeIdx:0, roundStartIdx:0, round:0, 
  phase:"CALL", pendingGuess:null,
  guesses:[], revealed:[], status:"WAITING", winner:""
};

let timerSec=120, timerInt=null;
const TURN_CHIME = new Audio("chime.mp3"); 

/* --- MQTT SETUP --- */
const BROKER = "wss://broker.emqx.io:8084/mqtt";
const TOPIC_PRE = "reveal_v5_0";

function connectMQTT(){
  /* Logic moved to specific actions to handle errors better */
}
function handleMsg(topic, m){
  const msg = JSON.parse(m.toString());
  if(msg.type==="STATE"){
    // Turn Change Detection for Timer
    const oldTurn = getActivePlayerName();
    const oldPhase = gameState.phase;
    gameState = msg.state || gameState;
    if(msg.img) gameImg = msg.img;
    
    if(getActivePlayerName() !== oldTurn || (oldPhase!=="TURNS" && gameState.phase==="TURNS")){
      timerSec = 120; // Reset Timer
    }

    if(document.getElementById("screen-join-code").classList.contains("active")){
      goTo("screen-join-setup");
      document.getElementById("join-room-disp").textContent = "ROOM: "+roomCode;
    }
    updateUI();
  }
  // Other msg types handled by host logic below
  if(isHost) hostHandleMsg(msg);
}

function sendState(){
  if(client && client.connected && isHost){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"STATE", state:gameState, img:gameImg}));
  }
}

/* --- HOST LOGIC (AUTHORITY) --- */
function hostHandleMsg(msg){
  if(msg.type==="REQ_STATE") sendState();
  
  if(msg.type==="JOIN"){
    const n = (msg.name||"").trim();
    if(n && !gameState.players.some(p=>p.name===n)){
      gameState.players.push({name:n});
      sendState();
    }
  }
  
  if(msg.type==="PASS" && gameState.phase==="TURNS" && isActivePlayer(msg.from)){
    // ROTATE TURN
    advanceTurn();
    sendState();
  }

  if(msg.type==="GUESS" && gameState.phase==="TURNS" && isActivePlayer(msg.from)){
    gameState.pendingGuess = {from:msg.from, txt:msg.txt};
    gameState.phase = "ADJUDICATE";
    sendState();
  }
}

function hostCall(){
  const avail = [];
  for(let i=1; i<=25; i++) if(!gameState.revealed.includes(i)) avail.push(i);
  if(avail.length === 0) return;

  const pick = avail[Math.floor(Math.random()*avail.length)];
  gameState.revealed.push(pick);
  
  // LOGIC FIX: Dealer Rotation
  // 1. Increment Round
  gameState.round++;
  // 2. Rotate the Round Starter
  gameState.roundStartIdx = (gameState.roundStartIdx + 1) % (gameState.players.length || 1);
  // 3. Set Active Player to Starter
  gameState.activeIdx = gameState.roundStartIdx;
  
  gameState.phase = "TURNS";
  gameState.pendingGuess = null;
  sendState();
}

function hostJudge(isRight){
  const pg = gameState.pendingGuess;
  if(isRight){
    gameState.status = "WIN";
    gameState.phase = "WIN";
    gameState.winner = pg.from;
    gameState.winGuess = pg.txt;
    gameState.revealed = Array.from({length:25},(_,i)=>i+1); // Reveal all
    sendState();
    showWin(pg.from, pg.txt);
  } else {
    gameState.guesses.push({from:pg.from, txt:pg.txt});
    gameState.phase = "TURNS";
    gameState.pendingGuess = null;
    advanceTurn();
    sendState();
  }
}

function advanceTurn(){
  // Cycle to next player
  gameState.activeIdx = (gameState.activeIdx + 1) % gameState.players.length;
  // Check if we looped back to round starter (Round Over)
  if(gameState.activeIdx === gameState.roundStartIdx){
    gameState.phase = "CALL"; // Back to Host
  }
}

/* --- PLAYER LOGIC --- */
function passTurn(){
  client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"PASS", from:myName}));
  closeGuessUI();
}
function sendGuess(){
  const txt = document.getElementById("guess-input").value;
  if(txt) client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"GUESS", from:myName, txt:txt}));
  closeGuessUI();
}

/* --- UI RENDERING --- */
function updateUI(){
  // Sky
  document.getElementById("disp-round").textContent = gameState.round;
  document.getElementById("disp-call").textContent = gameState.revealed[gameState.revealed.length-1] || "--";
  
  // Ticker
  document.getElementById("disp-cat").textContent = gameState.cat;
  
  let statusTxt = "WAITING";
  if(gameState.phase==="CALL") statusTxt = "HOST IS CALLING...";
  if(gameState.phase==="TURNS") statusTxt = `TURN: ${getActivePlayerName()}`;
  if(gameState.phase==="ADJUDICATE") statusTxt = "JUDGING GUESS...";
  if(gameState.phase==="WIN") statusTxt = "GAME OVER";
  document.getElementById("disp-status").textContent = statusTxt;

  // Answer Key (Host Only)
  const floatAns = document.getElementById("host-floating-ans");
  if(isHost && gameState.ans){
    floatAns.style.display = "block";
    floatAns.textContent = "ANS: " + gameState.ans;
  } else {
    floatAns.style.display = "none";
  }

  // Players List
  const pl = document.getElementById("list-players");
  pl.innerHTML = "";
  const ap = getActivePlayerName();
  gameState.players.forEach(p=>{
    const row = document.createElement("div");
    row.className = "player-row" + (p.name===ap ? " active" : "");
    
    // Mini Grid
    const mg = document.createElement("div");
    mg.className = "mini-grid";
    const pNums = generateGridFor(p.name);
    pNums.forEach(n=>{
      const d = document.createElement("div");
      d.className = "mg-cell" + (gameState.revealed.includes(n) ? " hit" : "");
      mg.appendChild(d);
    });
    row.appendChild(mg);
    
    // Name
    const nDiv = document.createElement("div");
    nDiv.className = "p-name";
    nDiv.textContent = p.name;
    if(p.name===myName) nDiv.innerHTML += `<span class='badge-you'>YOU</span>`;
    row.appendChild(nDiv);
    
    pl.appendChild(row);
  });

  // Main Card
  const nums = generateGridFor(myName);
  const grid = document.getElementById("card-grid");
  grid.innerHTML = "";
  nums.forEach(n=>{
    const d = document.createElement("div");
    d.className = "c-tile";
    d.textContent = n;
    d.dataset.n = n;
    
    const isCalled = gameState.revealed.includes(n);
    const isRevealed = d.classList.contains("revealed"); // Logic handled by click usually
    
    // Re-apply local reveal state logic? 
    // Simplified: Check standard DOM class or LocalStorage if we were fancy.
    // For now: We rely on user clicking. 
    // BUT we need to check Pulse.
    if(isCalled) d.classList.add("missed"); // Pulse by default if called
    
    d.onclick = function(){
      if(isCalled){
        this.classList.add("revealed");
        this.classList.remove("missed");
      }
    }
    grid.appendChild(d);
  });
  
  if(gameImg) document.getElementById("card-img").src = gameImg;

  // Console Logic
  const areaConsole = document.getElementById("area-console");
  const hostCtrl = document.getElementById("host-controls");
  const plyrCtrl = document.getElementById("player-controls");
  const inputCtrl = document.getElementById("console-input-wrap");
  
  hostCtrl.style.display = "none";
  plyrCtrl.style.display = "none";
  inputCtrl.style.display = "none";
  areaConsole.style.display = "flex";

  if(isHost){
    hostCtrl.style.display = "flex";
    if(gameState.phase==="CALL") {
      document.getElementById("btn-host-call").style.display="block";
      document.getElementById("btn-host-wrong").style.display="none";
      document.getElementById("btn-host-right").style.display="none";
    } else if(gameState.phase==="ADJUDICATE"){
      document.getElementById("btn-host-call").style.display="none";
      document.getElementById("btn-host-wrong").style.display="block";
      document.getElementById("btn-host-right").style.display="block";
    } else {
      // Host waiting during turns
      document.getElementById("btn-host-call").style.display="none";
    }
  } else {
    // Player
    if(gameState.phase==="TURNS" && isActivePlayer(myName)){
      plyrCtrl.style.display = "flex";
    }
  }
  
  // Guesses
  const gl = document.getElementById("list-guesses");
  gl.innerHTML = "";
  gameState.guesses.forEach(g=>{
    const div = document.createElement("div");
    div.className = "guess-row";
    div.textContent = `"${g.txt}" (${g.from})`;
    gl.appendChild(div);
  });
  
  if(gameState.phase==="WIN") showWin(gameState.winner, gameState.winGuess);

  // Footer Info
  document.getElementById("disp-code").textContent = roomCode;
  document.getElementById("disp-host").textContent = gameState.host;
}

/* --- HELPERS --- */
function isActivePlayer(n){ return gameState.players[gameState.activeIdx]?.name === n; }
function getActivePlayerName(){ return gameState.players[gameState.activeIdx]?.name || ""; }
function openGuess(){ 
  document.getElementById("player-controls").style.display="none"; 
  document.getElementById("console-input-wrap").style.display="flex"; 
  document.getElementById("guess-input").focus();
}
function closeGuessUI(){ updateUI(); }

/* --- RNG --- */
function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
function stringToSeed(str) { let h = 1779033703 ^ str.length; for(let i = 0; i < str.length; i++) { h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = h << 13 | h >>> 19; } return function() { h = Math.imul(h ^ (h >>> 16), 2246822507); h = Math.imul(h ^ (h >>> 13), 3266489909); return (h ^= h >>> 16) >>> 0; } }
function generateGridFor(pName) {
  const rng = mulberry32(stringToSeed(roomCode+"_"+pName)());
  let nums = Array.from({length:25},(_,i)=>i+1);
  for(let i=nums.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [nums[i],nums[j]]=[nums[j],nums[i]]; }
  return nums;
}

/* --- SETUP FLOW --- */
function processImage(){
  const file = document.getElementById("img-upload").files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement("canvas");
      c.width=700; c.height=700;
      const ctx = c.getContext("2d");
      const s = Math.min(img.width,img.height);
      ctx.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,700,700);
      gameImg = c.toDataURL("image/jpeg",0.8);
      document.getElementById("btn-create").disabled = false;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function createGame(){
  myName = document.getElementById("host-name").value.trim() || "Host";
  gameState.host = myName;
  gameState.cat = document.getElementById("game-cat").value.trim();
  gameState.ans = document.getElementById("game-ans").value.trim();
  roomCode = Math.random().toString(36).slice(2,6).toUpperCase();
  isHost = true;
  
  client = mqtt.connect(BROKER);
  client.on("connect",()=>{
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    sendState();
  });
  client.on("message", handleMsg);
  goTo("screen-game");
  updateUI();
  
  // Tick Timer
  setInterval(()=>{
    if(gameState.phase==="TURNS"){
      timerSec--;
      const el = document.getElementById("disp-timer");
      const abs = Math.abs(timerSec);
      el.textContent = (timerSec<0?"-":"") + Math.floor(abs/60) + ":" + (abs%60).toString().padStart(2,"0");
      if(timerSec<=0) {
        el.style.color = "var(--danger)";
        if(Math.abs(timerSec)%15===0 && isActivePlayer(myName)) TURN_CHIME.play().catch(e=>{});
      } else {
        el.style.color = "";
      }
      
      // Tab Blink
      if(isActivePlayer(myName)) document.title = (timerSec%2===0) ? "ðŸ”´ YOUR TURN" : "REVEAL!";
      else document.title = "REVEAL!";
    }
  },1000);
}

function searchRoom(){
  roomCode = document.getElementById("join-code").value.trim().toUpperCase();
  const btn = document.getElementById("btn-search");
  btn.textContent = "CONNECTING...";
  
  client = mqtt.connect(BROKER);
  let cT = setTimeout(()=>{ btn.textContent="BLOCKED (VPN?)"; client.end(); },5000);
  
  client.on("connect",()=>{
    clearTimeout(cT);
    btn.textContent = "CHECKING ROOM...";
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"REQ_STATE"}));
    setTimeout(()=>{
      if(!gameState.host){ btn.textContent="ROOM NOT FOUND"; client.end(); }
    },5000);
  });
  client.on("message", handleMsg);
}

function enterGame(){
  myName = document.getElementById("join-name").value.trim();
  if(!myName) return;
  client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"JOIN", name:myName}));
  goTo("screen-game");
}

/* --- NAV --- */
function goTo(id){ document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active")); document.getElementById(id).classList.add("active"); }
function showHostSetup(){ goTo("screen-host-setup"); populateSkinSelect("host-style"); }
function showJoinSetup(){ goTo("screen-join-code"); }

/* --- SKINS --- */
function setMySkin(k){ 
  localStorage.setItem("reveal_skin", k);
  const s = SKINS[k] || SKINS.modern_dark;
  const r = document.documentElement.style;
  r.setProperty("--bg-color",s.bg); r.setProperty("--accent",s.acc); r.setProperty("--tile-off",s.tile);
}
function populateSkinSelect(id){
  const el = document.getElementById(id); el.innerHTML="";
  Object.keys(SKINS).forEach(k=>el.innerHTML+=`<option value="${k}">${SKINS[k].label}</option>`);
}

function showWin(w,g){
  document.getElementById("win-title").textContent = w + " WINS!";
  document.getElementById("win-sub").textContent = "Guess: " + g;
  document.getElementById("win-img").src = gameImg;
  document.getElementById("win-overlay").style.display = "flex";
}

/* Init */
window.onbeforeunload = ()=> "Game in progress!";
setMySkin(localStorage.getItem("reveal_skin")||"modern_dark");
</script>
</body>
</html>
