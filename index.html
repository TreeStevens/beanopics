<!DOCTYPE html>
<html lang="en">
<!-- 
    IMAGE REVEAL BEANO v3
    
    SECTION 1: CONFIGURATION & THEMES
    - Defines the 10 color schemes.
    - Sets up global variables.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REVEAL! v22.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* 1.1 CSS VARIABLES & RESETS */
        :root {
            --bg-color: #4c1d95;
            --accent: #2dd4bf;
            --text-color: #ffffff;
            --tile-color: #1e293b;
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            font-family: var(--font-body);
            overflow: hidden; height: 100vh; display: flex; flex-direction: column;
            transition: background 0.3s ease;
        }

        /* 1.2 COMMON UI ELEMENTS */
        .screen {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto; transform: translateX(100%); transition: transform 0.3s ease;
        }
        .screen.active { transform: translateX(0); }
        .card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; width: 100%; max-width: 400px;
            border: 2px solid rgba(255,255,255,0.2); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .big-btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-family: var(--font-head); font-size: 1.4rem; cursor: pointer;
            background: var(--accent); color: #000;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); margin-top: 10px;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
        input, select {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            font-family: var(--font-body); font-weight: 800; font-size: 1.1rem;
            background: rgba(255,255,255,0.95); color: #111; outline: none; margin-bottom: 10px;
        }
        .code-input { font-family: 'Courier New', monospace; letter-spacing: 5px; text-align: center; text-transform: uppercase; font-weight: 900; font-size: 1.5rem; }

        /* 1.3 GAME LAYOUT (3 COLUMNS) */
        #game-layout { display: flex; flex: 1; width: 100%; overflow: hidden; position: relative; margin-top: 10px; }
        .side-col {
            flex: 1; padding: 10px; display: flex; flex-direction: column;
            background: rgba(0,0,0,0.1); overflow-y: auto; max-width: 250px;
        }
        #center-col {
            flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            position: relative; padding: 10px;
        }

        /* 1.4 NUMBER TRACKER (THE NEW REQUEST) */
        #host-badge { font-weight: 900; text-transform: uppercase; font-size: 1.2rem; text-align: center; width: 100%; padding: 10px; }
        
        #number-board {
            width: 100%; max-width: 500px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); border-radius: 15px;
            padding: 10px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        /* Left Side: 1-25 History */
        #num-history {
            display: grid; grid-template-columns: repeat(13, 1fr); 
            gap: 2px; width: 65%;
        }
        .hist-dot {
            width: 15px; height: 15px; background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.3);
            border-radius: 3px; font-size: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .hist-dot.active {
            background: var(--accent); color: black; box-shadow: 0 0 5px var(--accent); transform: scale(1.1);
        }
        /* Right Side: Current Call */
        #current-call-box {
            width: 30%; display: flex; justify-content: center; align-items: center;
        }
        .ball {
            width: 50px; height: 50px; background: white; border-radius: 50%;
            color: #333; font-family: var(--font-head); font-size: 1.8rem;
            display: flex; align-items: center; justify-content: center;
            border: 4px solid var(--accent); box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Illuminati 23 Style */
        .pyramid {
            width: 0; height: 0; 
            border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 50px solid #fbbf24;
            position: relative; animation: popIn 0.3s;
        }
        .pyramid::after {
            content: '23'; position: absolute; bottom: -45px; left: -12px;
            color: black; font-weight: bold; font-family: var(--font-head); font-size: 1rem;
        }

        /* 1.5 THE IMAGE GRID */
        #game-board-container {
            width: 90vmin; height: 90vmin; max-width: 500px; max-height: 500px;
            position: relative; background: #000; border: 5px solid white; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); overflow: hidden;
        }
        #target-image { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: 1; }
        #grid-overlay {
            position: absolute; inset: 0; z-index: 2;
            display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr);
            gap: 1px;
        }
        .tile {
            background: var(--tile-color); color: rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-head); font-size: 1.8rem;
            cursor: pointer; user-select: none; transition: opacity 0.3s;
        }
        .tile.revealed { opacity: 0; pointer-events: none; }
        .tile[data-n="23"] span { display: none; }
        .tile[data-n="23"]::after { content: '23'; color: #fbbf24; font-size: 1.2rem; }

        /* 1.6 LISTS & FOOTER */
        .list-header { font-family: var(--font-head); text-transform: uppercase; opacity: 0.5; margin-bottom: 10px; text-align: center; }
        .guess-item { background: rgba(255,0,0,0.2); padding: 5px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; }
        .player-item {
            background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;
            margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; text-align: center;
            border: 2px solid transparent;
        }
        .player-item.active-turn { border-color: var(--accent); background: rgba(255,255,255,0.2); animation: pulse 1s infinite; }
        
        #action-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display: flex; gap: 10px; z-index: 100; }
        
        /* 1.7 MODALS */
        #guess-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        #guess-modal.active { display: flex; }
        .timer-bar { height: 5px; background: var(--accent); width: 100%; max-width: 300px; margin-bottom: 20px; transition: width 1s linear; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 9999; display: none; font-weight: bold;
        }

        @keyframes popIn { from{transform:scale(0);} to{transform:scale(1);} }
        @keyframes pulse { 0%{border-color:var(--accent);} 50%{border-color:white;} 100%{border-color:var(--accent);} }
        @media (max-width: 700px) { .side-col { display: none; } #host-badge { font-size: 0.9rem; } }

    </style>
</head>
<body>

    <!-- TOAST NOTIFICATION (Private) -->
    <div id="toast"></div>

    <!-- START SCREEN -->
    <div id="screen-start" class="screen active center-content" style="justify-content:center;">
        <h1>REVEAL!</h1>
        <div class="subtitle">v22.0 &bull; RESTORED LOGIC</div>
        <div style="width:300px;">
            <button class="big-btn" onclick="goToHost()">HOST A GAME</button>
            <div style="text-align:center; font-size:0.7rem; opacity:0.7; margin-bottom:20px;">Upload image & Control Board</div>
            <button class="big-btn secondary" onclick="goToJoin()">JOIN A GAME</button>
            <div style="text-align:center; font-size:0.7rem; opacity:0.7;">Enter Code & Play</div>
        </div>
    </div>

    <!-- HOST SETUP -->
    <div id="screen-host" class="screen center-content">
        <h2>GAME SETUP</h2>
        <div class="card">
            <input type="text" id="host-name" placeholder="HOST NAME">
            <input type="text" id="game-cat" placeholder="CATEGORY (e.g. 80s MOVIES)">
            <input type="text" id="game-ans" placeholder="SECRET ANSWER">
            <label>Upload Image</label>
            <input type="file" id="img-upload" accept="image/*" onchange="processImage()">
            <div id="img-preview-box" style="width:100px; height:100px; margin:10px auto; display:none; border:2px solid white; border-radius:10px; overflow:hidden;">
                <img id="img-preview" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <label>Theme</label>
            <select id="host-skin" onchange="applySkin(this.value)"></select>
            <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
        </div>
        <button onclick="goTo('screen-start')" style="margin-top:20px; background:none; border:none; color:white;">&larr; BACK</button>
    </div>

    <!-- JOIN CODE -->
    <div id="screen-join-code" class="screen center-content" style="justify-content:center;">
        <h2>ENTER CODE</h2>
        <div class="card">
            <input type="text" id="join-code-input" class="code-input" maxlength="4" placeholder="ABCD">
            <button class="big-btn" onclick="verifyCode()">NEXT</button>
        </div>
        <button onclick="goTo('screen-start')" style="margin-top:20px; background:none; border:none; color:white;">&larr; BACK</button>
    </div>

    <!-- JOIN SETUP -->
    <div id="screen-join-setup" class="screen center-content">
        <h2 id="join-room-title">ROOM: ????</h2>
        <div id="join-host-display" style="margin-bottom:15px; font-weight:bold; color:var(--accent);">Loading Host...</div>
        <div class="card">
            <input type="text" id="join-name" placeholder="YOUR NAME">
            <select id="join-skin" onchange="applySkin(this.value)"></select>
            <button class="big-btn" onclick="joinGame()">ENTER</button>
        </div>
    </div>

    <!-- GAME BOARD -->
    <div id="screen-game" class="screen" style="padding:0;">
        <div id="host-badge">HOST: ???</div>
        
        <!-- SECTION 3.2: NUMBER BOARD -->
        <div id="number-board">
            <!-- Left: 1-25 History -->
            <div id="num-history"></div>
            <!-- Right: Current Call -->
            <div id="current-call-box">
                <span style="opacity:0.5; font-size:0.8rem;">READY</span>
            </div>
        </div>

        <div id="game-layout">
            <div class="side-col" id="col-guesses"><div class="list-header">WRONG</div><div id="list-guesses"></div></div>
            
            <div id="center-col">
                <div id="game-board-container">
                    <img id="target-image" src="">
                    <div id="grid-overlay"></div>
                </div>
            </div>

            <div class="side-col" id="col-players"><div class="list-header">PLAYERS</div><div id="list-players"></div></div>
        </div>

        <!-- HOST CONTROLS -->
        <div id="action-bar"></div>
    </div>

    <!-- GUESS MODAL (Turn Based) -->
    <div id="guess-modal">
        <h2 style="color:white;">IT'S YOUR TURN!</h2>
        <div class="timer-bar" id="turn-timer"></div>
        <input type="text" id="guess-input" placeholder="TYPE ANSWER..." style="max-width:300px; text-align:center;">
        <div style="display:flex; gap:10px; width:100%; max-width:300px;">
            <button class="big-btn" onclick="submitGuess()">SUBMIT</button>
            <button class="big-btn secondary" style="background:#ef4444;" onclick="passTurn()">PASS</button>
        </div>
    </div>

<script>
    /* 
       SECTION 1: CONFIGURATION
       - Skins for visual customization
       - Global State variables
    */
    const SKINS = {
        vibrant:   { n: "Vibrant",    bg: '#4c1d95', acc: '#2dd4bf', text: '#fff', tile: '#1e293b' },
        artdeco:   { n: "Art Deco",   bg: '#121212', acc: '#d4af37', text: '#e0e0e0', tile: '#1f1f1f' },
        academia:  { n: "Academia",   bg: '#2b2118', acc: '#8b9d83', text: '#eaddcf', tile: '#3e3226' },
        noir:      { n: "Noir",       bg: '#000000', acc: '#ffffff', text: '#cccccc', tile: '#333333' },
        cotton:    { n: "Cotton",     bg: '#fbcfe8', acc: '#38bdf8', text: '#333333', tile: '#ffffff' },
        matrix:    { n: "Matrix",     bg: '#000000', acc: '#00ff00', text: '#00ff00', tile: '#111111' },
        blueprint: { n: "Blueprint",  bg: '#1e3a8a', acc: '#ffffff', text: '#ffffff', tile: '#3b82f6' },
        sunset:    { n: "Sunset",     bg: '#7c2d12', acc: '#f59e0b', text: '#fff7ed', tile: '#431407' },
        dracula:   { n: "Dracula",    bg: '#282a36', acc: '#ff79c6', text: '#f8f8f2', tile: '#44475a' },
        forest:    { n: "Forest",     bg: '#064e3b', acc: '#a7f3d0', text: '#ecfdf5', tile: '#065f46' }
    };

    let myName, roomCode, isHost;
    let client, gameImg = null; 
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_PRE = 'reveal_v22_0';

    let gameState = { 
        hostName: "", 
        category: "",
        answer: "",
        players: [], 
        guesses: [], 
        revealed: [], // Numbers called
        turnOrder: [],
        currentTurnIdx: 0,
        status: 'WAITING' 
    };

    /* SECTION 2: INIT & NAVIGATION */
    document.addEventListener('DOMContentLoaded', () => {
        const skinOpts = Object.keys(SKINS).map(k => `<option value="${k}">${SKINS[k].n}</option>`).join('');
        document.getElementById('host-skin').innerHTML = skinOpts;
        document.getElementById('join-skin').innerHTML = skinOpts;
        buildNumberHistory(); // Prep the 1-25 display
    });

    function applySkin(key) {
        const s = SKINS[key] || SKINS.vibrant;
        const r = document.documentElement.style;
        r.setProperty('--bg-color', s.bg);
        r.setProperty('--accent', s.acc);
        r.setProperty('--text-color', s.text);
        r.setProperty('--tile-color', s.tile);
    }
    
    function goTo(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goToHost() { goTo('screen-host'); }
    function goToJoin() { goTo('screen-join-code'); }

    /* SECTION 3: HOST FLOW */
    function processImage() {
        const file = document.getElementById('img-upload').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const s = Math.min(img.width, img.height);
                canvas.width = 600; canvas.height = 600;
                ctx.drawImage(img, (img.width-s)/2, (img.height-s)/2, s, s, 0, 0, 600, 600);
                gameImg = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('img-preview').src = gameImg;
                document.getElementById('img-preview').parentElement.style.display='block';
                checkHostReady();
            };
        };
        reader.readAsDataURL(file);
    }

    function checkHostReady() {
        const n=document.getElementById('host-name').value, c=document.getElementById('game-cat').value, a=document.getElementById('game-ans').value;
        document.getElementById('btn-create').disabled = !(n && c && a && gameImg);
    }
    ['host-name','game-cat','game-ans'].forEach(id=>document.getElementById(id).addEventListener('keyup', checkHostReady));

    function createGame() {
        myName = document.getElementById('host-name').value;
        gameState.hostName = myName;
        gameState.category = document.getElementById('game-cat').value.toUpperCase();
        gameState.answer = document.getElementById('game-ans').value;
        
        roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        isHost = true;
        // Host doesn't play in this version
        
        setupGameUI();
        connectMQTT();
        startHostLoop();
    }

    function startHostLoop() {
        setInterval(() => {
            const pl = { type: 'STATE', state: gameState, img: gameImg };
            client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl));
        }, 1000);
    }

    /* SECTION 4: JOIN FLOW */
    function verifyCode() {
        const c = document.getElementById('join-code-input').value.trim().toUpperCase();
        if(c.length !== 4) return alert("4 Letters Required");
        roomCode = c;
        goTo('screen-join-setup');
        document.getElementById('join-room-title').innerText = "ROOM: " + c;
        isHost = false;
        connectMQTT(); // Connect early to get Host Name
    }

    function joinGame() {
        myName = document.getElementById('join-name').value;
        if(!myName) return alert("Enter Name");
        send({ type: 'JOIN', name: myName });
        setupGameUI();
    }

    /* SECTION 5: GAMEPLAY LOGIC */
    
    // 5.1 Fuzzy Logic (Levenshtein)
    function levenshtein(a, b) {
        if(a.length == 0) return b.length; 
        if(b.length == 0) return a.length; 
        var matrix = [];
        var i;
        for(i = 0; i <= b.length; i++){ matrix[i] = [i]; }
        var j;
        for(j = 0; j <= a.length; j++){ matrix[0][j] = j; }
        for(i = 1; i <= b.length; i++){
            for(j = 1; j <= a.length; j++){
                if(b.charAt(i-1) == a.charAt(j-1)){ matrix[i][j] = matrix[i-1][j-1]; } 
                else { matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1)); }
            }
        }
        return matrix[b.length][a.length];
    }

    function checkAnswer(input, answer) {
        let cleanInput = input.trim().toLowerCase();
        let cleanAns = answer.trim().toLowerCase();
        
        if (cleanInput === cleanAns) return 1.0; // Perfect match

        let dist = levenshtein(cleanInput, cleanAns);
        let len = Math.max(cleanInput.length, cleanAns.length);
        return 1.0 - (dist / len); // Return similarity score (0.0 to 1.0)
    }

    // 5.2 Board Building
    function setupGameUI() {
        goTo('screen-game');
        if(isHost) {
            document.getElementById('target-image').src = gameImg;
            updateActionBar();
        }
        buildGrid();
    }
    
    function buildNumberHistory() {
        const h = document.getElementById('num-history');
        h.innerHTML = '';
        for(let i=1; i<=25; i++) {
            let s = document.createElement('div');
            s.className = 'hist-dot';
            s.id = 'hist-'+i;
            s.innerText = i;
            h.appendChild(s);
        }
    }
    
    function buildGrid() {
        const grid = document.getElementById('grid-overlay');
        grid.innerHTML = '';
        // SHUFFLE 1-25
        let numbers = Array.from({length: 25}, (_, i) => i + 1);
        for (let i = numbers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
        }
        numbers.forEach(n => {
            let t = document.createElement('div');
            t.className = 'tile';
            if(n === 23) t.classList.add('is-23'); 
            t.dataset.n = n;
            t.innerText = n;
            // Players click to remove their own tiles locally
            t.onclick = () => { if(gameState.revealed.includes(n)) t.classList.add('revealed'); };
            grid.appendChild(t);
        });
    }

    // 5.3 Turn Logic
    function hostCallNumber() {
        let available = [];
        for(let i=1; i<=25; i++) if(!gameState.revealed.includes(i)) available.push(i);
        if(available.length > 0) {
            let pick = available[Math.floor(Math.random() * available.length)];
            gameState.revealed.push(pick);
            send({ type: 'STATE', state: gameState });
            updateBoard();
        }
    }

    function startGuessRound() {
        // Shuffle players
        let pNames = gameState.players.map(p => p.name);
        gameState.turnOrder = pNames.sort(() => Math.random() - 0.5);
        gameState.currentTurnIdx = 0;
        gameState.status = 'GUESSING';
        send({ type: 'STATE', state: gameState });
        updateBoard();
    }
    
    function submitGuess() {
        let val = document.getElementById('guess-input').value;
        let score = checkAnswer(val, gameState.answer || ""); // Guests might not have answer locally, send to host?
        // Actually, Host stores answer. Guest sends guess, Host validates.
        
        if(!isHost) {
            send({ type: 'GUESS_ATTEMPT', from: myName, text: val });
            document.getElementById('guess-modal').classList.remove('active');
        }
    }
    
    function passTurn() {
        send({ type: 'PASS_TURN' });
        document.getElementById('guess-modal').classList.remove('active');
    }

    /* SECTION 6: RENDER & UPDATES */
    function updateBoard() {
        // Update Info
        document.getElementById('host-badge').innerText = `HOST: ${gameState.hostName} | CAT: ${gameState.category || '?'}`;
        
        // Update Number Board (1-25 list)
        document.querySelectorAll('.hist-dot').forEach(d => d.classList.remove('active'));
        gameState.revealed.forEach(n => {
            let d = document.getElementById('hist-'+n);
            if(d) d.classList.add('active');
        });
        
        // Update Current Call Visual
        const callBox = document.getElementById('current-call-box');
        let lastCall = gameState.revealed[gameState.revealed.length-1];
        if(lastCall) {
            if(lastCall === 23) callBox.innerHTML = `<div class="pyramid"></div>`;
            else callBox.innerHTML = `<div class="ball">${lastCall}</div>`;
        }
        
        // Update Player List
        const pList = document.getElementById('list-players');
        pList.innerHTML = '';
        gameState.players.forEach(p => {
            let div = document.createElement('div');
            div.className = 'player-item';
            div.innerText = p.name;
            if(gameState.status === 'GUESSING' && gameState.turnOrder[gameState.currentTurnIdx] === p.name) {
                div.classList.add('active-turn');
            }
            pList.appendChild(div);
        });

        // Update Guesses
        const gList = document.getElementById('list-guesses');
        gList.innerHTML = '';
        gameState.guesses.forEach(g => {
            let div = document.createElement('div');
            div.className = 'guess-item';
            div.innerHTML = `<span>${g.name}</span>${g.text}`;
            gList.prepend(div);
        });
        
        updateActionBar();
        
        // Trigger Modal for Active Player
        if(gameState.status === 'GUESSING' && gameState.turnOrder[gameState.currentTurnIdx] === myName) {
            document.getElementById('guess-modal').classList.add('active');
        } else {
            document.getElementById('guess-modal').classList.remove('active');
        }
    }

    function updateActionBar() {
        const bar = document.getElementById('action-bar');
        bar.innerHTML = '';
        if(isHost) {
            if(gameState.status === 'GUESSING') {
                bar.innerHTML = `<button class="big-btn secondary">GUESSING IN PROGRESS...</button>`;
            } else {
                bar.innerHTML = `
                    <button class="big-btn" onclick="hostCallNumber()">CALL #</button>
                    <button class="big-btn secondary" style="background:#fbbf24; color:black;" onclick="startGuessRound()">START GUESSING</button>
                `;
            }
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    /* SECTION 7: MQTT NETWORK */
    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const t = `${TOPIC_PRE}/${roomCode}`;
        
        client.on('connect', () => {
            client.subscribe(t);
        });

        client.on('message', (tpc, m) => {
            const msg = JSON.parse(m.toString());
            
            if(msg.type === 'STATE') {
                gameState = msg.state;
                if(!isHost) {
                    if(msg.img && document.getElementById('target-image').src === "") document.getElementById('target-image').src = msg.img;
                    if(document.getElementById('screen-join-setup').classList.contains('active')) {
                         document.getElementById('join-host-display').innerText = "HOST: " + gameState.hostName;
                    }
                }
                updateBoard();
            }
            
            if(msg.type === 'JOIN' && isHost) {
                if(!gameState.players.find(p=>p.name===msg.name)) {
                    gameState.players.push({name:msg.name, score:0});
                    send({ type: 'STATE', state: gameState, img: gameImageBase64 });
                }
            }
            
            // HOST PROCESSES GUESSES
            if(msg.type === 'GUESS_ATTEMPT' && isHost) {
                let score = checkAnswer(msg.text, gameState.answer);
                
                if(score >= 0.8) {
                    // WINNER
                    alert(msg.from + " WINS! Answer: " + gameState.answer);
                    // Add win logic here (Celebration, etc)
                } else {
                    // WRONG
                    if(score >= 0.5) {
                         send({ type: 'FEEDBACK', target: msg.from, msg: `Close! ${Math.floor(score*100)}% match` });
                    }
                    gameState.guesses.push({name: msg.from, text: msg.text});
                    // Next turn
                    let next = gameState.currentTurnIdx + 1;
                    if(next >= gameState.turnOrder.length) {
                        gameState.status = 'WAITING'; // End round
                    } else {
                        gameState.currentTurnIdx = next;
                    }
                    send({ type: 'STATE', state: gameState, img: gameImageBase64 });
                }
            }
            
            if(msg.type === 'PASS_TURN' && isHost) {
                let next = gameState.currentTurnIdx + 1;
                if(next >= gameState.turnOrder.length) gameState.status = 'WAITING';
                else gameState.currentTurnIdx = next;
                send({ type: 'STATE', state: gameState, img: gameImageBase64 });
            }
            
            if(msg.type === 'FEEDBACK' && msg.target === myName) {
                showToast(msg.msg);
            }
        });
    }

    function send(pl) { client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl)); }

</script>
</body>
</html>
