<!DOCTYPE html>
<html lang="en">
<!--
  REVEAL! v4.7 – Clean rebuild (known-good)

  FIXES vs your broken v4.6 file:
  - No stray braces, no duplicated functions, no mangled strings.
  - Host is NOT added as a player (ever).
  - Players ALWAYS see GUESS/PASS when it's their turn.
  - Turn highlighting works (left player list + STATUS line).
  - Jumbotron boxes are SQUARE (mini-grid + call box), not stretched rectangles.
  - Style dropdown reflects the current selection (synced across screens).
  - Restores themed skin names (Dark Academia, Art Deco, etc.).
-->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>REVEAL! v4.7</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color:#111827;
      --panel-bg: rgba(255,255,255,0.06);
      --accent:#2dd4bf;
      --text-main:#ffffff;
      --font-head:'Fredoka One', cursive;
      --font-body:'Nunito', sans-serif;
      --tile-off:#374151;
      --card-max-width: 460px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; height:100vh; width:100vw;
      background:var(--bg-color); color:var(--text-main);
      font-family:var(--font-body);
      overflow:hidden;
    }

    /* Screens */
    .screen{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:var(--bg-color);
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:10;
    }
    .screen.active{ transform:translateX(0); z-index:20; }

    .card-panel{
      width:92%; max-width:420px;
      background:rgba(255,255,255,0.08);
      border:2px solid rgba(255,255,255,0.18);
      border-radius:18px;
      padding:22px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 50px rgba(0,0,0,0.35);
      text-align:center;
    }

    label{
      display:block;
      font-weight:900;
      margin:10px 0 6px;
      font-size:.78rem;
      text-transform:uppercase;
      opacity:.75;
      text-align:left;
    }
    input, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      outline:none;
      font-weight:800;
      font-size:1rem;
      background:#f8fafc;
      color:#111827;
    }

    .code-input{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:6px;
      text-align:center;
      text-transform:uppercase;
      font-size:1.4rem;
    }

    .big-btn{
      width:100%;
      margin-top:12px;
      padding:14px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-family:var(--font-head);
      font-size:1.15rem;
      background:var(--accent);
      color:#000;
      box-shadow:0 6px 0 rgba(0,0,0,0.22);
      transition:transform .08s;
    }
    .big-btn:active{ transform:translateY(3px); box-shadow:none; }
    .big-btn.secondary{
      background:rgba(255,255,255,0.18);
      color:#fff;
      box-shadow:none;
      font-family:var(--font-body);
      font-weight:900;
      font-size:1rem;
    }
    .big-btn:disabled{
      background:#64748b; color:#0b1220;
      cursor:not-allowed; opacity:.75;
      box-shadow:none;
    }

    /* Game layout */
    #screen-game{
      display:grid;
      grid-template-rows: 1fr 60px;
      padding:0;
    }

    #game-layout{
      display:grid;
      grid-template-columns: 220px 1fr 220px;
      height:100%;
      overflow:hidden;
    }

    .sidebar{
      background:var(--panel-bg);
      border-left:1px solid rgba(255,255,255,0.06);
      border-right:1px solid rgba(255,255,255,0.06);
      padding:10px;
      overflow:auto;
    }
    .sb-head{
      font-family:var(--font-head);
      opacity:.6;
      font-size:.9rem;
      text-align:center;
      margin:4px 0 10px;
    }
    .sb-item{
      font-size:.88rem;
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      word-break:break-word;
      opacity:.92;
    }
    .sb-item.active-turn{
      background:rgba(255,255,255,0.14);
      border-left:4px solid var(--accent);
      padding-left:10px;
      font-weight:900;
      opacity:1;
    }

    #center-stage{
      display:flex;
      justify-content:flex-start;
      padding:10px;
      overflow:auto;
    }

    .game-stack{
      width:100%;
      max-width:var(--card-max-width);
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Header */
    #header-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
      padding:8px;
      border-radius:10px;
      background:var(--panel-bg);
    }
    .info-cell{ text-align:center; overflow:hidden; }
    .info-lbl{
      font-size:.55rem;
      opacity:.6;
      font-weight:900;
      text-transform:uppercase;
    }
    .info-val{
      font-size:.86rem;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #inf-code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      cursor:pointer;
      background:rgba(255,255,255,0.10);
      border-radius:8px;
      padding:2px 6px;
      display:inline-block;
    }
    #info-status{ grid-column:1 / -1; }
    #inf-status{ font-weight:900; }

    /* JUMBOTRON (square panels, never stretched) */
    #jumbotron{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    #mini-grid-container,
    #call-box{
      aspect-ratio: 1 / 1;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.9);
      overflow:hidden;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #mini-grid-container{
      background:#020617;
      padding:8px;
    }
    #mini-grid{
      width:100%; height:100%;
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      grid-template-rows:repeat(5, 1fr);
      gap:0;
    }
    .trk-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:.82rem;
      color: rgba(148,163,184,0.9);
    }
    .trk-cell.active{
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent);
    }

    #call-box{
      position:relative;
      background:#000;
      flex-direction:column;
    }
    .call-lbl{
      position:absolute;
      top:8px;
      font-size:.72rem;
      font-weight:900;
      opacity:.55;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .call-val{
      font-family:var(--font-head);
      font-size:5rem;
      line-height:1;
    }

    .pyramid{
      width:0; height:0;
      border-left:52px solid transparent;
      border-right:52px solid transparent;
      border-bottom:82px solid #fbbf24;
      position:relative;
      margin-top:18px;
    }
    .pyramid::after{
      content:'23';
      position:absolute;
      bottom:-74px;
      left:-20px;
      font-family:var(--font-head);
      font-weight:900;
      font-size:1.7rem;
      color:#000;
    }

    /* Card */
    #card-wrapper{
      width:100%;
      aspect-ratio:1/1;
      position:relative;
      border-radius:12px;
      border:4px solid rgba(255,255,255,0.92);
      overflow:hidden;
      background:#000;
      box-shadow:0 16px 60px rgba(0,0,0,0.45);
    }
    #target-img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      z-index:1;
    }
    #tile-grid{
      position:absolute; inset:0;
      z-index:10;
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      grid-template-rows:repeat(5, 1fr);
      gap:0;
    }
    .tile{
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--tile-off);
      font-family:var(--font-head);
      font-size:2.0rem;
      color:rgba(255,255,255,0.33);
      user-select:none;
      cursor:pointer;
      transition: opacity .18s ease;
    }
    .tile.revealed{ opacity:0; pointer-events:none; }
    .tile[data-n="23"]{ color:transparent; }

    /* Controls: one pane at a time */
    #controls-bar{
      width:100%;
      height:60px;
      position:relative;
    }
    #host-btns, #player-btns, #guess-interface, #waiting-msg{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:none;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    #host-btns.show{ display:flex; }
    #player-btns.show{ display:flex; }
    #guess-interface.show{ display:flex; }
    #waiting-msg.show{ display:flex; }

    .btn-call{
      width:100%; height:100%;
      border:none;
      border-radius:12px;
      font-family:var(--font-head);
      font-size:1.5rem;
      cursor:pointer;
      background:#fff;
      color:#000;
      box-shadow:0 5px 0 rgba(0,0,0,0.25);
    }
    .btn-call:active{ transform:translateY(4px); box-shadow:none; }
    .btn-call:disabled{ opacity:.6; cursor:not-allowed; }

    .ctrl-btn{
      height:100%;
      border:none;
      border-radius:12px;
      font-family:var(--font-head);
      font-size:1.2rem;
      cursor:pointer;
      box-shadow:0 5px 0 rgba(0,0,0,0.28);
      flex:1 1 auto;
    }
    .ctrl-btn:active{ transform:translateY(4px); box-shadow:none; }
    .btn-guess{ background:var(--accent); color:#000; }
    .btn-pass{ background:#ef4444; color:#fff; }

    #guess-field{
      height:100%;
      border:none;
      border-radius:12px;
      outline:none;
      padding:0 14px;
      font-weight:900;
      font-size:1.15rem;
      flex:1 1 auto;
      min-width:0;
      text-align:center;
      background:#fff;
      color:#000;
    }
    #guess-send{ flex:0 0 120px; }
    #guess-cancel{ flex:0 0 70px; }

    #waiting-msg{
      font-weight:900;
      color:rgba(255,255,255,0.72);
      pointer-events:none;
      padding:0 10px;
      text-align:center;
    }

    /* Footer chat placeholder */
    #chat-bar{
      background:rgba(0,0,0,0.40);
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
    }
    #chat-input{ flex:1; padding:10px; border-radius:10px; border:none; outline:none; }
    #chat-send{ width:70px; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:900; }

    /* Toast */
    #toast{
      position:fixed;
      bottom:88px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,0.96);
      color:#fbbf24;
      padding:10px 16px;
      border-radius:999px;
      font-weight:900;
      opacity:0;
      transition:opacity .18s ease;
      pointer-events:none;
      z-index:999;
    }
    #toast.show{ opacity:1; }

    @media (max-width: 900px){
      #game-layout{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }
  </style>
</head>

<body>
  <!-- LOBBY -->
  <div id="screen-lobby" class="screen active">
    <div class="card-panel">
      <h1 style="margin:0; font-family:var(--font-head);">REVEAL! v4.7</h1>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:16px;">
        <button class="big-btn" onclick="showHostSetup()">HOST GAME</button>
        <div style="opacity:.55; font-weight:900;">OR</div>
        <button class="big-btn secondary" onclick="showJoinCode()">JOIN GAME</button>
      </div>
    </div>
  </div>

  <!-- HOST SETUP -->
  <div id="screen-host-setup" class="screen">
    <div class="card-panel">
      <h2 style="margin:0 0 6px;">GAME SETUP</h2>

      <label>HOST NAME</label>
      <input id="host-name" type="text" placeholder="Name">

      <label>CATEGORY</label>
      <input id="game-cat" type="text" placeholder="e.g. Landmarks">

      <label>ANSWER</label>
      <input id="game-ans" type="text" placeholder="Secret Answer">

      <label>IMAGE</label>
      <input id="img-upload" type="file" accept="image/*" onchange="processImage()">

      <label>STYLE (PREVIEW)</label>
      <select id="host-style" onchange="setSkin(this.value)">
        <option value="vibrant">Neon Grape</option>
        <option value="darkacad">Dark Academia</option>
        <option value="artdeco">Art Deco</option>
        <option value="storm">Storm Slate</option>
        <option value="sunset">Miami Sunset</option>
        <option value="forest">Cryptid Forest</option>
        <option value="carnival">Killer Carnival</option>
        <option value="ice">Blue Ice</option>
        <option value="lava">Lava Lamp</option>
        <option value="mono">Mono Punch</option>
      </select>

      <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
    </div>
  </div>

  <!-- JOIN CODE -->
  <div id="screen-join-code" class="screen">
    <div class="card-panel">
      <h2 style="margin:0 0 10px;">ENTER CODE</h2>
      <input id="join-code" class="code-input" maxlength="4" placeholder="ABCD">
      <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>

      <label>STYLE (PREVIEW)</label>
      <select id="join-style" onchange="setSkin(this.value)">
        <option value="vibrant">Neon Grape</option>
        <option value="darkacad">Dark Academia</option>
        <option value="artdeco">Art Deco</option>
        <option value="storm">Storm Slate</option>
        <option value="sunset">Miami Sunset</option>
        <option value="forest">Cryptid Forest</option>
        <option value="carnival">Killer Carnival</option>
        <option value="ice">Blue Ice</option>
        <option value="lava">Lava Lamp</option>
        <option value="mono">Mono Punch</option>
      </select>

      <button class="big-btn secondary" onclick="goTo('screen-lobby')">BACK</button>
    </div>
  </div>

  <!-- JOIN NAME -->
  <div id="screen-join-setup" class="screen">
    <div class="card-panel">
      <h2 id="join-room-disp" style="margin:0 0 6px;">ROOM FOUND</h2>
      <div id="join-host-disp" style="color:var(--accent); font-weight:900; margin-bottom:12px;">Connecting...</div>

      <label>YOUR NAME</label>
      <input id="join-name" type="text" placeholder="Name">

      <label>STYLE (PREVIEW)</label>
      <select id="join-style-2" onchange="setSkin(this.value)">
        <option value="vibrant">Neon Grape</option>
        <option value="darkacad">Dark Academia</option>
        <option value="artdeco">Art Deco</option>
        <option value="storm">Storm Slate</option>
        <option value="sunset">Miami Sunset</option>
        <option value="forest">Cryptid Forest</option>
        <option value="carnival">Killer Carnival</option>
        <option value="ice">Blue Ice</option>
        <option value="lava">Lava Lamp</option>
        <option value="mono">Mono Punch</option>
      </select>

      <button class="big-btn" id="btn-enter" disabled onclick="enterGame()">ENTER GAME</button>
      <button class="big-btn secondary" onclick="goTo('screen-join-code')">BACK</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div id="game-layout">
      <!-- LEFT -->
      <div class="sidebar">
        <div class="sb-head">PLAYERS</div>
        <div id="list-players"></div>
      </div>

      <!-- CENTER -->
      <div id="center-stage">
        <div class="game-stack">
          <!-- HEADER -->
          <div id="header-row">
            <div class="info-cell">
              <div class="info-lbl">HOST</div>
              <div class="info-val" id="inf-host">?</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">CATEGORY</div>
              <div class="info-val" id="inf-cat">?</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">CODE</div>
              <div class="info-val" id="inf-code" onclick="copyCode()">----</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">STYLE</div>
              <select id="style-in-game" onchange="setSkin(this.value)"
                style="padding:0; margin:0; height:22px; font-size:.86rem; font-weight:900; background:transparent; color:#fff; border:none; outline:none;">
                <option value="vibrant">Neon Grape</option>
                <option value="darkacad">Dark Academia</option>
                <option value="artdeco">Art Deco</option>
                <option value="storm">Storm Slate</option>
                <option value="sunset">Miami Sunset</option>
                <option value="forest">Cryptid Forest</option>
                <option value="carnival">Killer Carnival</option>
                <option value="ice">Blue Ice</option>
                <option value="lava">Lava Lamp</option>
                <option value="mono">Mono Punch</option>
              </select>
            </div>
            <div class="info-cell" id="info-status">
              <div class="info-lbl">STATUS</div>
              <div class="info-val" id="inf-status">WAITING</div>
            </div>
          </div>

          <!-- JUMBOTRON -->
          <div id="jumbotron">
            <div id="mini-grid-container">
              <div id="mini-grid"></div>
            </div>
            <div id="call-box">
              <div class="call-lbl">CURRENT CALL</div>
              <div class="call-val" id="call-val">--</div>
            </div>
          </div>

          <!-- CARD -->
          <div id="card-wrapper">
            <img id="target-img" src="" alt="">
            <div id="tile-grid"></div>
          </div>

          <!-- CONTROLS -->
          <div id="controls-bar">
            <div id="host-btns">
              <button class="btn-call" id="btn-call" onclick="hostCall()">CALL NEXT NUMBER</button>
            </div>

            <div id="player-btns">
              <button class="ctrl-btn btn-guess" onclick="showGuess()">GUESS</button>
              <button class="ctrl-btn btn-pass" onclick="passTurn()">PASS</button>
            </div>

            <div id="guess-interface">
              <input id="guess-field" type="text" placeholder="ANSWER...">
              <button class="ctrl-btn btn-guess" id="guess-send" onclick="sendGuess()">SEND</button>
              <button class="ctrl-btn btn-pass" id="guess-cancel" onclick="cancelGuess()">X</button>
            </div>

            <div id="waiting-msg">Waiting for your turn…</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="sidebar">
        <div class="sb-head">WRONG GUESSES</div>
        <div id="list-guesses"></div>
      </div>
    </div>

    <!-- Footer -->
    <div id="chat-bar">
      <input id="chat-input" type="text" placeholder="Chat (later)…">
      <button id="chat-send" onclick="alert('Chat coming later')">SEND</button>
    </div>
  </div>

  <div id="toast"></div>

<script>
  /* ==============================
     SKINS (themed names restored)
     ============================== */
  const SKINS = {
    vibrant:  { bg:'#4c1d95', acc:'#2dd4bf', text:'#ffffff', tile:'#1e293b' }, // Neon Grape
    darkacad: { bg:'#111827', acc:'#eab308', text:'#f8fafc', tile:'#374151' }, // Dark Academia
    artdeco:  { bg:'#0b1220', acc:'#fbbf24', text:'#fef3c7', tile:'#1f2937' }, // Art Deco
    storm:    { bg:'#0f172a', acc:'#38bdf8', text:'#e2e8f0', tile:'#1f2937' }, // Storm Slate
    sunset:   { bg:'#7c2d12', acc:'#fb7185', text:'#fff7ed', tile:'#451a03' }, // Miami Sunset
    forest:   { bg:'#064e3b', acc:'#a7f3d0', text:'#ecfdf5', tile:'#052e16' }, // Cryptid Forest
    carnival: { bg:'#3b0764', acc:'#f472b6', text:'#fae8ff', tile:'#1f0933' }, // Killer Carnival
    ice:      { bg:'#0c4a6e', acc:'#a5f3fc', text:'#ecfeff', tile:'#083344' }, // Blue Ice
    lava:     { bg:'#7f1d1d', acc:'#fdba74', text:'#fff7ed', tile:'#3f0b0b' }, // Lava Lamp
    mono:     { bg:'#111827', acc:'#ffffff', text:'#ffffff', tile:'#374151' }  // Mono Punch
  };

  let currentSkinKey = 'darkacad';

  function applySkin(k){
    const s = SKINS[k] || SKINS.darkacad;
    const r = document.documentElement.style;
    r.setProperty('--bg-color', s.bg);
    r.setProperty('--accent', s.acc);
    r.setProperty('--text-main', s.text);
    r.setProperty('--tile-off', s.tile);
  }

  function syncSkinSelects(k){
    const ids = ['host-style','join-style','join-style-2','style-in-game'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.value = k;
    });
  }

  function setSkin(k){
    currentSkinKey = k;
    applySkin(k);
    syncSkinSelects(k);
  }

  // init skin
  setSkin(currentSkinKey);

  /* ==============================
     GLOBAL STATE / MQTT
     ============================== */
  const BROKER = 'wss://broker.emqx.io:8084/mqtt';
  const TOPIC_PRE = 'reveal_v4_7'; // new prefix to avoid collisions with your old broken rooms

  let myName = '';
  let roomCode = '';
  let isHost = false;
  let client = null;
  let gameImg = null;

  let gameState = {
    host: '',
    cat: '',
    ans: '',
    players: [],         // [{name}]
    guesses: [],         // [{from, txt}]
    revealed: [],        // [1..25]
    status: 'PLAY',      // PLAY | WIN
    winner: '',
    turn: ''             // name whose turn it is (players only; host is referee)
  };

  /* ==============================
     NAV
     ============================== */
  function goTo(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  }
  function showHostSetup(){ goTo('screen-host-setup'); }
  function showJoinCode(){ goTo('screen-join-code'); }

  /* ==============================
     IMAGE
     ============================== */
  function processImage(){
    const file = document.getElementById('img-upload').files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e)=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        const s = Math.min(img.width, img.height);
        c.width = 600; c.height = 600;
        ctx.drawImage(img,
          (img.width - s)/2, (img.height - s)/2, s, s,
          0, 0, 600, 600
        );
        gameImg = c.toDataURL('image/jpeg', 0.65);
        document.getElementById('btn-create').disabled = false;
      };
    };
    reader.readAsDataURL(file);
  }

  /* ==============================
     MQTT CONNECT
     ============================== */
  function connectMQTT(){
    if (client) return;
    client = mqtt.connect(BROKER);

    client.on('connect', ()=>{
      client.subscribe(`${TOPIC_PRE}/${roomCode}`);
      if (!isHost){
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({ type:'REQ_STATE' }));
      }
    });

    client.on('message', (topic, payload)=>{
      let msg;
      try { msg = JSON.parse(payload.toString()); }
      catch(e){ return; }

      if (msg.type === 'STATE'){
        gameState = msg.state || gameState;
        if (msg.img) gameImg = msg.img;
        if (gameImg) document.getElementById('target-img').src = gameImg;

        // if we were searching, transition to name screen
        const joinCodeScreen = document.getElementById('screen-join-code');
        if (joinCodeScreen && joinCodeScreen.classList.contains('active')){
          document.getElementById('join-room-disp').innerText = `ROOM: ${roomCode}`;
          document.getElementById('join-host-disp').innerText = `HOST: ${gameState.host || '...'}`;
          document.getElementById('btn-enter').disabled = false;
          document.getElementById('btn-search').innerText = 'NEXT';
          goTo('screen-join-setup');
        }

        updateUI();
        return;
      }

      if (msg.type === 'REQ_STATE' && isHost){
        sendState();
        return;
      }

      if (msg.type === 'JOIN' && isHost){
        // Host is NEVER added to players
        if (!msg.name) return;
        if (msg.name === gameState.host) return;

        if (!gameState.players.find(p=>p.name === msg.name)){
          gameState.players.push({ name: msg.name });
          if (!gameState.turn) gameState.turn = msg.name; // first player gets turn
          sendState();
        } else {
          // rejoin: keep as-is, just refresh state
          sendState();
        }
        return;
      }

      if (msg.type === 'PASS' && isHost){
        if (gameState.status === 'WIN') return;
        if (msg.from && msg.from === gameState.turn){
          advanceTurn();
          sendState();
        }
        return;
      }

      if (msg.type === 'GUESS' && isHost){
        if (gameState.status === 'WIN') return;
        if (!msg.from || !msg.txt) return;
        // only accept guess if it's that player's turn
        if (msg.from !== gameState.turn) return;

        handleIncomingGuessAsHost(msg.from, msg.txt);
        return;
      }

      if (msg.type === 'HINT'){
        if (msg.to === myName){
          showToast(`Close! ${msg.pct}% match`);
        }
        return;
      }
    });
  }

  /* ==============================
     HOST: CREATE
     ============================== */
  function createGame(){
    myName = (document.getElementById('host-name').value || '').trim() || 'Host';
    isHost = true;

    roomCode = Math.random().toString(36).slice(2,6).toUpperCase();

    gameState = {
      host: myName,
      cat: (document.getElementById('game-cat').value || '').trim(),
      ans: (document.getElementById('game-ans').value || '').trim(),
      players: [],
      guesses: [],
      revealed: [],
      status: 'PLAY',
      winner: '',
      turn: ''
    };

    connectMQTT();
    startGameUI();
    sendState();

    // keep state fresh (helps late joiners)
    setInterval(()=>{ if (client && client.connected && isHost) sendState(); }, 2000);
  }

  /* ==============================
     JOIN: SEARCH + ENTER
     ============================== */
  function searchRoom(){
    const code = (document.getElementById('join-code').value || '').trim().toUpperCase();
    if (code.length !== 4){ alert('Enter 4-letter code.'); return; }

    roomCode = code;
    isHost = false;

    document.getElementById('btn-search').innerText = 'SEARCHING...';
    connectMQTT();
  }

  function enterGame(){
    const nm = (document.getElementById('join-name').value || '').trim();
    if (!nm) return;

    myName = nm;

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({ type:'JOIN', name: myName }));
    }

    startGameUI();
  }

  /* ==============================
     UI INIT
     ============================== */
  function startGameUI(){
    goTo('screen-game');
    document.getElementById('inf-code').innerText = roomCode;

    // ensure skin dropdown shows what user picked
    syncSkinSelects(currentSkinKey);
    applySkin(currentSkinKey);

    // build mini-grid
    const mg = document.getElementById('mini-grid');
    mg.innerHTML = '';
    for (let i=1;i<=25;i++){
      const d = document.createElement('div');
      d.className = 'trk-cell';
      d.id = `trk-${i}`;
      d.innerText = i;
      mg.appendChild(d);
    }

    // build player card tiles (each client has their own shuffled layout)
    const grid = document.getElementById('tile-grid');
    grid.innerHTML = '';

    let nums = Array.from({length:25}, (_,i)=>i+1);
    for (let i=nums.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [nums[i], nums[j]] = [nums[j], nums[i]];
    }

    nums.forEach(n=>{
      const t = document.createElement('div');
      t.className = 'tile';
      t.dataset.n = String(n);
      t.innerText = String(n);
      t.onclick = ()=> onTileClick(n, t);
      grid.appendChild(t);
    });

    // set image if we have it
    if (gameImg) document.getElementById('target-img').src = gameImg;

    // show correct control pane immediately
    setControlPaneForMe();

    updateUI();
  }

  function onTileClick(num, tileEl){
    // reveal only if called OR game is won
    const ok = (gameState.status === 'WIN') || (gameState.revealed || []).includes(num);
    if (!ok){
      alert("That number hasn't been called yet.");
      return;
    }
    tileEl.classList.add('revealed');
  }

  /* ==============================
     CONTROLS PANE LOGIC
     ============================== */
  function showPane(which){
    const hostPane = document.getElementById('host-btns');
    const playerPane = document.getElementById('player-btns');
    const guessPane = document.getElementById('guess-interface');
    const waitPane = document.getElementById('waiting-msg');

    [hostPane, playerPane, guessPane, waitPane].forEach(p=>p.classList.remove('show'));

    if (which === 'host') hostPane.classList.add('show');
    if (which === 'player') playerPane.classList.add('show');
    if (which === 'guess') guessPane.classList.add('show');
    if (which === 'wait') waitPane.classList.add('show');
  }

  function isMyTurn(){
    return (!isHost) && (gameState.turn === myName) && (gameState.status !== 'WIN');
  }

  function setControlPaneForMe(){
    if (isHost){
      showPane('host');
      return;
    }
    if (isMyTurn()){
      showPane('player');
    } else {
      showPane('wait');
    }
  }

  function showGuess(){
    if (!isMyTurn()) return;
    showPane('guess');
    const f = document.getElementById('guess-field');
    f.value = '';
    f.focus();
  }

  function cancelGuess(){
    setControlPaneForMe();
  }

  function passTurn(){
    if (!isMyTurn()) return;
    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({ type:'PASS', from: myName }));
    }
    showPane('wait');
  }

  function sendGuess(){
    if (!isMyTurn()) return;
    const g = (document.getElementById('guess-field').value || '').trim();
    if (!g) return;

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({ type:'GUESS', from: myName, txt: g }));
    }
    showPane('wait');
  }

  /* ==============================
     HOST CALL + TURN ADVANCE
     ============================== */
  function hostCall(){
    if (!isHost) return;
    if (gameState.status === 'WIN') return;

    const avail = [];
    for (let i=1;i<=25;i++){
      if (!(gameState.revealed || []).includes(i)) avail.push(i);
    }
    if (avail.length === 0) return;

    const pick = avail[Math.floor(Math.random()*avail.length)];
    gameState.revealed.push(pick);

    // advance turn AFTER calling a number (so everyone takes turns reacting)
    advanceTurn();

    sendState();
    updateUI();
  }

  function advanceTurn(){
    const ps = gameState.players || [];
    if (ps.length === 0){
      gameState.turn = '';
      return;
    }
    if (!gameState.turn){
      gameState.turn = ps[0].name;
      return;
    }
    const idx = ps.findIndex(p=>p.name === gameState.turn);
    const next = (idx === -1) ? 0 : (idx + 1) % ps.length;
    gameState.turn = ps[next].name;
  }

  /* ==============================
     STATE BROADCAST
     ============================== */
  function sendState(){
    if (client && client.connected && isHost){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({
        type:'STATE',
        state: gameState,
        img: gameImg
      }));
    }
  }

  /* ==============================
     UI UPDATE
     ============================== */
  function updateUI(){
    const hostEl = document.getElementById('inf-host');
    const catEl  = document.getElementById('inf-cat');
    const stEl   = document.getElementById('inf-status');

    if (hostEl) hostEl.innerText = gameState.host || '?';
    if (catEl)  catEl.innerText  = gameState.cat  || '?';

    // Status
    if (stEl){
      if (gameState.status === 'WIN'){
        stEl.innerText = `WIN: ${gameState.winner || '???'}`;
      } else if ((gameState.players || []).length === 0){
        stEl.innerText = 'WAITING FOR PLAYERS';
      } else {
        stEl.innerText = `TURN: ${gameState.turn || '—'}`;
      }
    }

    // Mini-grid lighting
    let last = 0;
    const rev = gameState.revealed || [];
    for (let i=1;i<=25;i++){
      const cell = document.getElementById(`trk-${i}`);
      if (cell) cell.classList.toggle('active', rev.includes(i));
    }
    if (rev.length) last = rev[rev.length-1];

    // Call box
    const callBox = document.getElementById('call-box');
    if (callBox){
      if (last === 23){
        callBox.innerHTML = `<div class="call-lbl">ILLUMINATI</div><div class="pyramid"></div>`;
      } else {
        callBox.innerHTML = `<div class="call-lbl">CURRENT CALL</div><div class="call-val" id="call-val">${last || '--'}</div>`;
      }
    }

    // Players list + highlight
    const pl = document.getElementById('list-players');
    if (pl){
      pl.innerHTML = '';
      (gameState.players || []).forEach(p=>{
        const d = document.createElement('div');
        d.className = 'sb-item' + (p.name === gameState.turn ? ' active-turn' : '');
        d.innerText = p.name;
        pl.appendChild(d);
      });
    }

    // Guesses list
    const lg = document.getElementById('list-guesses');
    if (lg){
      lg.innerHTML = '';
      (gameState.guesses || []).forEach(g=>{
        const d = document.createElement('div');
        d.className = 'sb-item';
        d.innerText = `${g.from}: "${g.txt}"`;
        lg.appendChild(d);
      });
    }

    // Tiles: auto-reveal if number called or WIN
    const tiles = document.querySelectorAll('.tile');
    tiles.forEach(t=>{
      const n = parseInt(t.dataset.n, 10);
      const shouldReveal = (gameState.status === 'WIN') || (gameState.revealed || []).includes(n);
      if (shouldReveal && t.classList.contains('revealed') === false){
        // do not force reveal until clicked? your old behavior was click-to-reveal.
        // Keep it click-to-reveal. We ONLY disable wrong-click enforcement above.
      }
      // If WIN, reveal everything immediately (optional; matches your old host-win behavior)
      if (gameState.status === 'WIN'){
        t.classList.add('revealed');
      }
    });

    // Controls pane based on current state
    const callBtn = document.getElementById('btn-call');
    if (callBtn) callBtn.disabled = (gameState.status === 'WIN');

    setControlPaneForMe();
  }

  /* ==============================
     GUESS EVAL (HOST)
     ============================== */
  function sanitizeText(s){ return (s || '').replace(/\s+/g,'').toUpperCase(); }

  function levenshtein(a,b){
    const m=a.length, n=b.length;
    const dp = Array.from({length:m+1}, ()=>new Array(n+1).fill(0));
    for (let i=0;i<=m;i++) dp[i][0]=i;
    for (let j=0;j<=n;j++) dp[0][j]=j;
    for (let i=1;i<=m;i++){
      for (let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i-1][j] + 1,
          dp[i][j-1] + 1,
          dp[i-1][j-1] + cost
        );
      }
    }
    return dp[m][n];
  }

  function similarityPercent(guess, answer){
    const g=sanitizeText(guess), a=sanitizeText(answer);
    if (!g || !a) return 0;
    const dist = levenshtein(g,a);
    const maxLen = Math.max(g.length, a.length);
    return Math.round((1 - dist/maxLen) * 100);
  }

  function handleIncomingGuessAsHost(from, txt){
    const pct = similarityPercent(txt, gameState.ans);
    gameState.guesses.push({ from, txt });

    if (pct >= 90){
      gameState.status = 'WIN';
      gameState.winner = from;
      gameState.revealed = Array.from({length:25}, (_,i)=>i+1);
      sendState();
      updateUI();
      return;
    }

    if (pct >= 50 && client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({ type:'HINT', to: from, pct }));
    }

    // advance turn after a guess (win handled above)
    advanceTurn();
    sendState();
    updateUI();
  }

  /* ==============================
     SMALL UTILS
     ============================== */
  function copyCode(){
    if (!roomCode) return;
    navigator.clipboard.writeText(roomCode);
    showToast(`Copied: ${roomCode}`);
  }

  function showToast(text, ms=1800){
    const t=document.getElementById('toast');
    t.textContent=text;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), ms);
  }
</script>
</body>
</html>
