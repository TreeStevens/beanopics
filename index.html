<!DOCTYPE html>
<html lang="en">
<!--
REVEAL! v4.9.5
(Host adjudicates + Smart Connectivity + Round Tracking + Dealer Rotation + Gentle Nudges)

CHANGES IN THIS VERSION (v4.9.5)
#6 HEADER: Added Round Counter display.
#9 HTML: Added connectivity help text to Join Screen.
#12 CONFIG: Added Audio object for chimes (placeholder 'chime.mp3').
#16 LOGIC: Smart connection handling:
    - Distinguishes between "Network Blocked" (VPN/Firewall) and "Room Invalid".
    - 5s timeouts for each stage.
#18 HOST: "Dealer Rotation" logic implemented in hostCall().
#20 UI: Tab Title blinking added for active turn.
#20 UI: Audio chime logic (every 15s during overtime).

TEST CHECKLIST:
1. Enter invalid code -> "ROOM NOT FOUND" (not stuck searching).
2. Host Call increments Round #.
3. Turn order rotates start player (A->B->C) each round.
4. Tab title blinks "YOUR TURN" when active.
-->

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>REVEAL! v4.9.5</title>

<!--
========================================
#1 GLOBAL DEPENDENCIES
========================================
-->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
/*
========================================
#2 THEME CONFIGURATION (VARS)
========================================
*/
:root{
  --bg-color:#4c1d95;
  --panel-bg:rgba(0,0,0,.25);
  --accent:#2dd4bf;
  --text-main:#fff;
  --font-head:'Fredoka One',cursive;
  --font-body:'Nunito',sans-serif;
  --tile-off:#1e293b;
  --card-max-width:450px;
  --ink:#0b1220;
}

/*
========================================
#3 BASE STYLES & LAYOUT UTILS
========================================
*/
*{box-sizing:border-box}
body{
  margin:0; height:100vh; width:100vw; overflow:hidden;
  background:var(--bg-color); color:var(--text-main);
  font-family:var(--font-body);
}

.screen{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background:var(--bg-color);
  transform:translateX(100%); transition:transform .25s ease;
  z-index:10;
}
.screen.active{transform:translateX(0); z-index:20;}

/*
========================================
#4 SHARED COMPONENTS (PANELS, INPUTS, BUTTONS)
========================================
*/
.card-panel{
  background:rgba(255,255,255,.1);
  border:2px solid rgba(255,255,255,.18);
  border-radius:20px;
  width:90%; max-width:420px;
  padding:22px;
  backdrop-filter:blur(10px);
  box-shadow:0 10px 30px rgba(0,0,0,.3);
  text-align:center;
}

h1,h2{margin:0 0 12px 0; font-family:var(--font-head);}
.control-group{margin:10px 0; text-align:left;}

label{
  display:block; font-weight:900; font-size:.78rem;
  opacity:.8; text-transform:uppercase; margin:0 0 6px 0;
}
input,select{
  width:100%; border:none; border-radius:10px;
  padding:12px; font-family:var(--font-body); font-weight:900; font-size:1.05rem;
  outline:none; background:#f8fafc; color:#0f172a;
}
.code-input{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  letter-spacing:5px; text-align:center; font-size:1.55rem; text-transform:uppercase;
}

.big-btn{
  width:100%; border:none; border-radius:12px; padding:15px;
  font-family:var(--font-head); font-size:1.15rem;
  background:var(--accent); color:#000;
  cursor:pointer;
  box-shadow:0 5px 0 rgba(0,0,0,.25);
  transition:transform .08s;
  margin-top:8px;
}
.big-btn:active{transform:translateY(2px); box-shadow:none;}
.big-btn.secondary{background:rgba(255,255,255,.18); color:#fff;}
.big-btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none; transform:none;}

.mini-btn{
  border:none; border-radius:8px;
  padding:6px 8px;
  font-weight:900;
  cursor:pointer;
  background:rgba(255,255,255,.15);
  color:#fff;
  font-size:.75rem;
}
.mini-btn:disabled{opacity:.4; cursor:not-allowed;}
.mini-btn.danger{background:rgba(239,68,68,.75);}

.help-text{
  font-size:.75rem; opacity:.6; margin-top:12px; line-height:1.4;
}

/*
========================================
#5 GAME SCREEN LAYOUT & SIDEBAR
========================================
*/
#screen-game{
  display:grid;
  grid-template-rows: 1fr 60px;
  height:100%; width:100%;
  padding:0;
}
#game-layout{
  display:grid;
  grid-template-columns: 240px 1fr 240px; 
  overflow:hidden;
}

/* Sidebar Styles */
.sidebar{
  background:var(--panel-bg);
  border-left:1px solid rgba(255,255,255,.05);
  border-right:1px solid rgba(255,255,255,.05);
  padding:10px;
  overflow:auto;
}
.sb-head{
  font-family:var(--font-head);
  opacity:.65; font-size:.9rem;
  text-align:center; margin-bottom:10px;
}
.sb-item{
  font-size:.86rem; padding:8px;
  border-bottom:1px solid rgba(255,255,255,.06);
  word-break:break-word;
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  position:relative;
  transition:background .2s;
}
.sb-item.active-turn{
  background:rgba(255,255,255,.12);
  border-radius:6px;
  box-shadow:inset 3px 0 0 var(--accent);
}
.sb-actions{display:flex; gap:6px; flex:0 0 auto;}

/* MINI DECK (Sidebar) */
.player-row-content{
  display:flex; align-items:center; gap:10px; flex:1;
}
.mini-deck{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  grid-template-rows:repeat(5, 1fr);
  width:40px; height:40px;
  background:#000;
  border:1px solid rgba(255,255,255,.3);
  gap:1px;
}
.md-tile{
  background:rgba(255,255,255,.15);
  width:100%; height:100%;
}
.md-tile.hit{
  background:var(--accent);
  box-shadow:0 0 2px var(--accent);
}

.you-badge{
  font-size:.65rem; background:rgba(255,255,255,.2);
  padding:2px 6px; border-radius:4px; margin-left:6px;
  text-transform:uppercase; font-weight:900; opacity:.8;
}

/* Center Stage */
#center-stage{
  padding:10px;
  overflow:auto;
  display:flex; justify-content:flex-start; align-items:center;
  flex-direction:column;
}
.game-stack{
  width:100%; max-width:var(--card-max-width);
  display:flex; flex-direction:column; gap:8px;
}

/* TIMER DISPLAY */
#timer-display{
  text-align:center;
  background:rgba(0,0,0,.5);
  border-radius:8px;
  padding:8px;
  border:1px solid rgba(255,255,255,.1);
}
#timer-val{
  font-family:var(--font-head);
  font-size:1.8rem;
  line-height:1;
  font-feature-settings: "tnum";
  font-variant-numeric: tabular-nums;
}
#timer-val.overtime{color:#ef4444; animation:pulseRed 1s infinite;}
@keyframes pulseRed{ 50%{opacity:.6;} }

#timer-lbl{
  font-size:.65rem; text-transform:uppercase; opacity:.7; font-weight:900;
}

@media (max-width: 900px){
  #game-layout{grid-template-columns:1fr;}
  .sidebar{display:none;}
}

/*
========================================
#6 GAME ELEMENTS (HEADER, GRID, CARD)
========================================
*/
/* Header Info */
#header-row{
  display:grid; grid-template-columns:1fr 1fr;
  gap:4px;
  background:var(--panel-bg);
  padding:6px 6px 5px;
  border-radius:8px;
}
.info-cell{text-align:center; overflow:hidden;}
.info-lbl{font-size:.52rem; opacity:.65; font-weight:900; text-transform:uppercase;}
.info-val{font-size:.85rem; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
#inf-code{
  font-family:ui-monospace, monospace;
  cursor:pointer;
  background:rgba(255,255,255,.12);
  border-radius:6px;
  padding:2px 6px;
  display:inline-block;
}
#info-status{grid-column:1 / -1;}
#inf-status{font-weight:900;}

/* Host Answer Line */
#host-answer-line{
  grid-column:1 / -1; display:none;
  margin-top:2px; padding:6px 8px;
  border-radius:8px;
  background:rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.10);
  font-weight:900; font-size:.78rem; text-align:center;
  user-select:text; word-break:break-word;
}
#host-answer-line .lbl{opacity:.7; text-transform:uppercase; letter-spacing:.5px; margin-right:6px;}
#host-answer-line .val{color:var(--accent); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block; max-width:100%; vertical-align:bottom;}

/* Jumbotron */
#jumbotron{display:grid; grid-template-columns:1fr 1fr; gap:8px; width:100%;}
#mini-grid-container, #call-box{
  aspect-ratio:1/1; width:100%;
  border-radius:12px; overflow:hidden;
  border:2px solid rgba(255,255,255,.9);
  background:#020617;
  display:flex; align-items:center; justify-content:center;
  position:relative;
}
#mini-grid-container{padding:8px;}
#mini-grid{
  width:100%; height:100%;
  display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(5,1fr);
  gap:0;
}
.trk-cell{
  display:flex; align-items:center; justify-content:center;
  color:rgba(148,163,184,.9);
  font-weight:900; font-size:.78rem;
  user-select:none;
}
.trk-cell.active{color:var(--accent); text-shadow:0 0 10px var(--accent);}

#call-box{background:#000;}
.call-lbl{
  position:absolute; top:8px;
  font-size:.7rem; opacity:.55; font-weight:900;
  text-transform:uppercase; letter-spacing:1px;
}
.call-val{
  font-family:var(--font-head); font-size:5rem; line-height:1;
  color:#fff; transform:translateY(6px);
  animation:callPop .22s ease;
}
@keyframes callPop{
  from{transform:translateY(6px) scale(.92); opacity:.2;}
  to{transform:translateY(6px) scale(1); opacity:1;}
}

/* Main Card */
#card-wrapper{
  width:100%; aspect-ratio:1/1; position:relative;
  background:#000;
  border:4px solid rgba(255,255,255,.95); border-radius:12px;
  overflow:hidden;
  box-shadow:0 10px 40px rgba(0,0,0,.35);
}
#target-img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:1;}
#tile-grid{
  position:absolute; inset:0;
  display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(5,1fr);
  gap:0; z-index:10;
}
.tile{
  background:var(--tile-off); color:rgba(255,255,255,.25);
  display:flex; align-items:center; justify-content:center;
  font-family:var(--font-head); font-size:2rem;
  user-select:none; cursor:pointer;
  transition:opacity .18s ease;
}
.tile.revealed{opacity:0; pointer-events:none;}
/* MISSED CALL PULSE */
.tile.missed-call{
  color:var(--accent); border:2px solid var(--accent);
  animation:pulseTile 1.5s infinite;
}
@keyframes pulseTile{
  0%{box-shadow:inset 0 0 0 rgba(255,255,255,0);}
  50%{box-shadow:inset 0 0 30px var(--accent);}
  100%{box-shadow:inset 0 0 0 rgba(255,255,255,0);}
}

/*
========================================
#7 CONTROL BAR & CHAT
========================================
*/
#controls-zone{width:100%; display:flex; flex-direction:column; gap:8px;}
.ctrl-row{width:100%; display:flex; gap:10px; height:56px;}
.ctrl-btn{
  flex:1 1 auto; border:none; border-radius:12px;
  font-family:var(--font-head); font-size:1.15rem;
  cursor:pointer; box-shadow:0 5px 0 rgba(0,0,0,.25);
  transition:transform .08s;
}
.ctrl-btn:active{transform:translateY(2px); box-shadow:none;}
.ctrl-btn:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none;}
.btn-pass{background:#ef4444; color:#fff;}
.btn-guess{background:var(--accent); color:#000;}
.btn-send{background:#fff; color:#000; flex:0 0 130px;}

.ctrl-input{
  flex:1 1 auto; border:none; border-radius:12px;
  font-weight:900; font-size:1.1rem;
  text-align:center; padding:0 14px; outline:none;
}

#chat-bar{
  background:rgba(0,0,0,.35);
  border-top:1px solid rgba(255,255,255,.08);
  padding:10px; display:flex; gap:10px; align-items:center;
}
#chat-input{flex:1; border:none; border-radius:10px; padding:10px; outline:none;}
#chat-send{border:none; border-radius:10px; padding:10px 12px; font-weight:900; cursor:pointer;}

/*
========================================
#8 OVERLAYS (TOAST & WIN)
========================================
*/
#toast{
  position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
  background:rgba(15,23,42,.96); color:#fbbf24;
  padding:10px 16px; border-radius:999px;
  font-size:.9rem; font-weight:900;
  z-index:999; opacity:0; pointer-events:none;
  transition:opacity .2s ease;
}
#toast.show{opacity:1;}

#win-overlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.60);
  z-index:9999; display:none;
  align-items:center; justify-content:center;
  padding:18px;
}
#win-card{
  width:100%; max-width:520px;
  border-radius:18px;
  background:rgba(255,255,255,.10);
  border:2px solid rgba(255,255,255,.20);
  backdrop-filter:blur(10px);
  box-shadow:0 20px 60px rgba(0,0,0,.45);
  padding:16px; text-align:center;
  position:relative; overflow:hidden;
}
#win-title{font-family:var(--font-head); font-size:2rem; margin:6px 0 6px;}
#win-sub{font-weight:900; opacity:.9; margin:0 0 12px; word-break:break-word;}
#win-reveal{
  width:100%; aspect-ratio:1/1;
  border-radius:14px; border:2px solid rgba(255,255,255,.75);
  overflow:hidden; margin-top:12px;
  position:relative; background:#000;
}
#win-img{width:100%; height:100%; object-fit:cover; display:block;}

.fw{
  position:absolute; width:8px; height:8px;
  border-radius:50%; background:var(--accent);
  opacity:.9; animation:fw 1.1s ease-out infinite;
  filter:drop-shadow(0 0 8px var(--accent));
}
.fw:nth-child(1){left:8%; top:85%; animation-delay:.0s;}
.fw:nth-child(2){left:22%; top:80%; animation-delay:.2s;}
.fw:nth-child(3){left:78%; top:86%; animation-delay:.35s;}
.fw:nth-child(4){left:90%; top:82%; animation-delay:.5s;}
@keyframes fw{
  0%{transform:translateY(0) scale(1); opacity:0;}
  15%{opacity:1;}
  60%{transform:translateY(-220px) scale(1.2); opacity:1;}
  100%{transform:translateY(-260px) scale(.2); opacity:0;}
}
</style>
</head>
<body>

<!--
========================================
#9 HTML: LOBBY & SETUP SCREENS
========================================
-->
<!-- LOBBY -->
<div id="screen-lobby" class="screen active">
  <div class="card-panel">
    <h1>REVEAL! v4.9.5</h1>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:16px;">
      <button class="big-btn" onclick="showHostSetup()">HOST GAME</button>
      <div style="opacity:.55; margin:4px 0;">OR</div>
      <button class="big-btn secondary" onclick="showJoinSetup()">JOIN GAME</button>
    </div>
  </div>
</div>

<!-- HOST SETUP -->
<div id="screen-host-setup" class="screen">
  <div class="card-panel">
    <h2>GAME SETUP</h2>
    
    <div class="control-group">
      <label>HOST NAME</label>
      <input id="host-name" type="text" placeholder="Name">
    </div>

    <div class="control-group">
      <label>CATEGORY</label>
      <input id="game-cat" type="text" placeholder="e.g. 80s Movies">
    </div>

    <div class="control-group">
      <label>ANSWER</label>
      <input id="game-ans" type="text" placeholder="Secret Answer">
    </div>

    <div class="control-group">
      <label>IMAGE</label>
      <input id="img-upload" type="file" accept="image/*" onchange="processImage()">
    </div>

    <div class="control-group">
      <label>STYLE (PREVIEW)</label>
      <select id="host-style" onchange="setMySkin(this.value)"></select>
    </div>

    <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>
  </div>
</div>

<!-- JOIN CODE -->
<div id="screen-join-code" class="screen">
  <div class="card-panel">
    <h2>ENTER CODE</h2>
    <input id="join-code" class="code-input" type="text" maxlength="4" placeholder="ABCD">
    
    <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>

    <div class="help-text">
      Stuck on "Searching"?<br>Try disabling your VPN or AdBlocker.<br>Firewalls can block the game connection.
    </div>
  </div>
</div>

<!-- JOIN SETUP -->
<div id="screen-join-setup" class="screen">
  <div class="card-panel">
    <h2 id="join-room-disp">ROOM FOUND</h2>
    <div id="join-host-disp" style="color:var(--accent); font-weight:900; margin-bottom:12px;">Connecting...</div>
    
    <div class="control-group">
      <label>YOUR NAME</label>
      <input id="join-name" type="text" placeholder="Your name">
    </div>

    <div class="control-group">
      <label>STYLE (PREVIEW)</label>
      <select id="join-style" onchange="setMySkin(this.value)"></select>
    </div>

    <button class="big-btn" id="btn-enter" disabled onclick="enterGame()">ENTER GAME</button>
    <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>
  </div>
</div>

<!--
========================================
#10 HTML: MAIN GAME SCREEN
========================================
-->
<div id="screen-game" class="screen">
  <div id="game-layout">
    
    <!-- LEFT SIDEBAR: PLAYERS + MINI DECKS -->
    <div class="sidebar" id="sb-players">
      <div class="sb-head">PLAYERS</div>
      <div id="list-players"></div>
    </div>

    <!-- CENTER STAGE -->
    <div id="center-stage">
      <div class="game-stack">

        <!-- Header -->
        <div id="header-row">
          <div class="info-cell">
            <div class="info-lbl">HOST</div>
            <div class="info-val" id="inf-host">?</div>
          </div>
          <div class="info-cell">
            <div class="info-lbl">ROOM</div>
            <div class="info-val" id="inf-code" onclick="copyCode()">????</div>
          </div>
          
          <div class="info-cell">
            <div class="info-lbl">ROUND</div>
            <div class="info-val" id="inf-round">1</div>
          </div>

          <div class="info-cell">
            <div class="info-lbl">PHASE</div>
            <div class="info-val" id="inf-phase">?</div>
          </div>

          <div class="info-cell" id="info-status" style="grid-column: 1/-1">
            <div class="info-lbl">STATUS</div>
            <div class="info-val" id="inf-status">WAITING</div>
          </div>

          <!-- HOST ANSWER -->
          <div id="host-answer-line">
            <span class="lbl">HOST ANSWER:</span>
            <span class="val" id="host-answer-val">?</span>
          </div>
        </div>

        <!-- Timer Display -->
        <div id="timer-display">
          <div id="timer-val">2:00</div>
          <div id="timer-lbl">Turn Timer</div>
        </div>

        <!-- Jumbotron -->
        <div id="jumbotron">
          <div id="mini-grid-container">
            <div id="mini-grid"></div>
          </div>
          <div id="call-box">
            <div class="call-lbl" id="call-label">CURRENT CALL</div>
            <div class="call-val" id="current-call-text">--</div>
          </div>
        </div>

        <!-- The Card -->
        <div id="card-wrapper">
          <img id="target-img" src="">
          <div id="tile-grid"></div>
        </div>

        <!-- Controls -->
        <div id="controls-zone">
          <!-- PLAYER -->
          <div class="ctrl-row" id="player-row-pass">
            <button id="btn-pass" class="ctrl-btn btn-pass" onclick="passTurn()">PASS</button>
          </div>

          <div class="ctrl-row" id="row-guess-idle">
            <button id="btn-guess" class="ctrl-btn btn-guess" onclick="openGuess()">GUESS</button>
          </div>

          <div class="ctrl-row" id="row-guess-input" style="display:none;">
            <input id="guess-field" class="ctrl-input" type="text" placeholder="TYPE YOUR GUESS">
            <button id="btn-send" class="ctrl-btn btn-send" onclick="sendGuess()">SEND</button>
          </div>

          <!-- HOST -->
          <div class="ctrl-row" id="host-row-adj" style="display:none;">
            <button id="btn-wrong" class="ctrl-btn btn-pass" onclick="hostJudge(false)">WRONG</button>
          </div>
          <div class="ctrl-row" id="host-row-adj2" style="display:none;">
            <button id="btn-right" class="ctrl-btn btn-guess" onclick="hostJudge(true)">RIGHT</button>
          </div>

          <!-- HOST CALL -->
          <button id="btn-host-call" class="big-btn" style="display:none; margin-top:0;" onclick="hostCall()">CALL NEXT NUMBER</button>
        </div>

      </div>
    </div>

    <!-- RIGHT SIDEBAR: WRONG GUESSES -->
    <div class="sidebar" id="sb-guesses">
      <div class="sb-head">WRONG GUESSES</div>
      <div id="list-guesses"></div>
    </div>

  </div>

  <!-- FOOTER -->
  <div id="chat-bar">
    <input id="chat-input" type="text" placeholder="Chat... (later)">
    <button id="chat-send" onclick="alert('Chat later')">SEND</button>
  </div>
</div>

<!--
========================================
#11 HTML: OVERLAYS
========================================
-->
<div id="toast"></div>

<div id="win-overlay">
  <div id="win-card">
    <div class="fw"></div><div class="fw"></div><div class="fw"></div><div class="fw"></div>
    <div id="win-title">SOMEONE wins!</div>
    <div id="win-sub">They Guessed: ???</div>
    <div id="win-reveal">
      <img id="win-img" src="">
    </div>
    <button class="big-btn secondary" style="margin-top:12px;" onclick="hideWin()">CLOSE</button>
  </div>
</div>

<script>
/*
========================================
#12 CONFIG & SKINS
========================================
*/
const SKINS = {
  neon_grape: { label:"Neon Grape", bg:"#4c1d95", acc:"#2dd4bf", text:"#ffffff", tile:"#1e293b" },
  dark_academia:{ label:"Dark Academia", bg:"#12100e", acc:"#d6ad60", text:"#f5efe6", tile:"#2a2420" },
  art_deco: { label:"Art Deco", bg:"#0b1220", acc:"#f5c542", text:"#f8fafc", tile:"#1f2937" },
  midnight_gold:{ label:"Midnight Gold", bg:"#18181b", acc:"#facc15", text:"#f4f4f5", tile:"#27272a" },
  storm_slate: { label:"Storm Slate", bg:"#0f172a", acc:"#38bdf8", text:"#e2e8f0", tile:"#1f2937" },
  miami_sunset: { label:"Miami Sunset", bg:"#7c2d12", acc:"#fb7185", text:"#fff7ed", tile:"#451a03" },
  cryptid_forest:{label:"Cryptid Forest", bg:"#064e3b", acc:"#a7f3d0", text:"#ecfdf5", tile:"#052e16" },
  killer_carnival:{label:"Killer Carnival",bg:"#3b0764",acc:"#f472b6", text:"#fae8ff", tile:"#1f0933" },
  blue_ice: { label:"Blue Ice", bg:"#0c4a6e", acc:"#a5f3fc", text:"#ecfeff", tile:"#083344" },
  lava_lamp: { label:"Lava Lamp", bg:"#7f1d1d", acc:"#fdba74", text:"#fff7ed", tile:"#3f0b0b" },
  old_paper: { label:"Old Paper", bg:"#1c1917", acc:"#fbbf24", text:"#fef3c7", tile:"#292524" },
  mono_punch: { label:"Mono Punch", bg:"#111827", acc:"#ffffff", text:"#ffffff", tile:"#374151" }
};

let mySkinKey = localStorage.getItem("reveal_skin") || "neon_grape";

/* Anti-Ghosting Warning */
window.onbeforeunload = function() {
  return "If you leave, you will lose your spot in the game!";
};

/* Audio Chime Placeholder - Replace with your URL */
const TURN_CHIME = new Audio("https://github.com/TreeStevens/beanopics/blob/main/chime.mp3"); 

function applySkin(k){
  const s = SKINS[k] || SKINS.neon_grape;
  const r = document.documentElement.style;
  r.setProperty("--bg-color", s.bg);
  r.setProperty("--accent", s.acc);
  r.setProperty("--text-main", s.text);
  r.setProperty("--tile-off", s.tile);
}

function setMySkin(k){
  mySkinKey = k;
  localStorage.setItem("reveal_skin", mySkinKey);
  applySkin(mySkinKey);
  const ids = ["host-style","join-style","style-in-game"];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.value = mySkinKey;
  });
}

function populateSkinSelect(id){
  const sel = document.getElementById(id);
  if (!sel) return;
  sel.innerHTML = "";
  Object.entries(SKINS).forEach(([k,v])=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = v.label;
    sel.appendChild(opt);
  });
  sel.value = mySkinKey;
}

/*
========================================
#13 GLOBAL STATE & VARS
========================================
*/
let myName = "";
let roomCode = "";
let isHost = false;
let client = null;
let gameImg = null;

let gameState = {
  host:"",
  cat:"",
  ans:"",
  players:[],
  activeIdx:0,
  roundStartIdx:0,
  round:1,
  phase:"CALL",
  pendingGuess:null,
  guesses:[],
  revealed:[],
  status:"WAITING",
  winner:"",
  winGuess:""
};

/* TIMER (VISUAL ONLY) */
let timerInterval = null;
let timerSeconds = 120; // 2 minutes

const BROKER = "wss://broker.emqx.io:8084/mqtt";
const TOPIC_PRE = "reveal_v4_8_1";

/*
========================================
#14 UTILS & NAVIGATION
========================================
*/
function goTo(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if (el) el.classList.add("active");
}
function showHostSetup(){ goTo("screen-host-setup"); }
function showJoinSetup(){ goTo("screen-join-code"); }

function processImage(){
  const file = document.getElementById("img-upload").files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    const img = new Image();
    img.src = e.target.result;
    img.onload = ()=>{
      const c = document.createElement("canvas");
      const ctx = c.getContext("2d");
      const s = Math.min(img.width, img.height);
      c.width = 700; c.height = 700;
      ctx.drawImage(img, (img.width - s)/2, (img.height - s)/2, s, s, 0, 0, 700, 700);
      gameImg = c.toDataURL("image/jpeg", 0.75);
      document.getElementById("btn-create").disabled = false;
    };
  };
  reader.readAsDataURL(file);
}

function copyCode(){
  if (!roomCode) return;
  navigator.clipboard.writeText(roomCode);
  showToast("Room code copied: " + roomCode, 1500);
}
function showToast(txt, ms=2000){
  const t = document.getElementById("toast");
  t.textContent = txt;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), ms);
}

/*
========================================
#15 MQTT NETWORKING (SMART CONNECT)
========================================
*/
let searchTimeout = null;
let connectTimeout = null;

function connectMQTT(){
  // This logic is now handled in searchRoom/createGame
  // But we keep the global event handlers
}

function handleMsg(topic, m){
  const msg = JSON.parse(m.toString());
  
  if (msg.type === "STATE"){
    // Clear timeouts on success
    if (searchTimeout) clearTimeout(searchTimeout);
    if (connectTimeout) clearTimeout(connectTimeout);

    // Detect turn change for timer reset
    const prevTurn = getActivePlayerName();
    const prevPhase = gameState.phase;

    gameState = msg.state || gameState;
    if (msg.img) gameImg = msg.img;

    const newTurn = getActivePlayerName();
    const newPhase = gameState.phase;

    // Reset visual timer if turn changed
    if (prevTurn !== newTurn || (prevPhase !== "TURNS" && newPhase === "TURNS")) {
      resetTimer();
    }

    if (document.getElementById("screen-join-code").classList.contains("active")){
      document.getElementById("join-room-disp").textContent = "ROOM: " + roomCode;
      document.getElementById("join-host-disp").textContent = "HOST: " + (gameState.host || "...");
      document.getElementById("btn-enter").disabled = false;
      document.getElementById("btn-search").textContent = "NEXT";
      goTo("screen-join-setup");
    }

    if (gameImg) document.getElementById("target-img").src = gameImg;
    updateUI();
    return;
  }

  if (msg.type === "REQ_STATE" && isHost){
    sendState();
    return;
  }

  if (msg.type === "JOIN" && isHost){
    const n = (msg.name || "").trim();
    if (!n) return;
    if (!(gameState.players || []).some(p=>p.name === n)){
      gameState.players.push({name:n});
      // Do not reset index here, preserve rotation
      sendState();
    }
    return;
  }

  if (msg.type === "PASS" && isHost){
    if (gameState.phase !== "TURNS") return;
    if (!isActivePlayer(msg.from)) return;
    if (gameState.status === "WIN") return;
    
    advanceTurn();
    endTurnCycleIfComplete();
    if (gameState.phase !== "CALL") gameState.phase = "TURNS";
    sendState();
    return;
  }

  if (msg.type === "GUESS" && isHost){
    if (gameState.phase !== "TURNS") return;
    if (!isActivePlayer(msg.from)) return;
    if (gameState.status === "WIN") return;

    gameState.pendingGuess = {from: msg.from, txt: msg.txt};
    gameState.phase = "ADJUDICATE";
    sendState();
    return;
  }

  if (msg.type === "SKIP" && isHost){
    if (gameState.status === "WIN") return;
    const who = msg.who;
    if (gameState.phase === "ADJUDICATE") return;
    if (gameState.phase !== "TURNS") return;

    if (who === getActivePlayerName()){
      advanceTurn();
      endTurnCycleIfComplete();
      if (gameState.phase !== "CALL") gameState.phase = "TURNS";
      sendState();
    }
    return;
  }
}

function sendState(){
  if (client && client.connected && isHost){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"STATE", state: gameState, img: gameImg}));
  }
}

/*
========================================
#16 CORE LOGIC: SETUP/JOIN & RNG
========================================
*/
function mulberry32(a) {
  return function() {
    var t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function stringToSeed(str) {
  let h = 1779033703 ^ str.length;
  for(let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = h << 13 | h >>> 19;
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  }
}
function generateGridFor(playerName) {
  const seedFn = stringToSeed(roomCode + "_" + playerName);
  const randFn = mulberry32(seedFn());
  
  let nums = Array.from({length:25}, (_,i)=>i+1);
  for (let i=nums.length-1;i>0;i--){
    const j = Math.floor(randFn()*(i+1));
    [nums[i], nums[j]] = [nums[j], nums[i]];
  }
  return nums;
}

function createGame(){
  myName = (document.getElementById("host-name").value || "").trim() || "Host";
  gameState.host = myName;
  gameState.cat = (document.getElementById("game-cat").value || "").trim();
  gameState.ans = (document.getElementById("game-ans").value || "").trim();
  
  gameState.players = [];
  gameState.activeIdx = 0;
  gameState.roundStartIdx = 0;
  gameState.round = 1;
  gameState.phase = "CALL";
  gameState.pendingGuess = null;
  gameState.guesses = [];
  gameState.revealed = [];
  gameState.status = "WAITING";
  gameState.winner = "";
  gameState.winGuess = "";

  roomCode = Math.random().toString(36).slice(2,6).toUpperCase();
  isHost = true;

  if (client) client.end();
  client = mqtt.connect(BROKER);
  client.on("connect", ()=>{
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    sendState();
  });
  client.on("message", handleMsg);
  
  startGame();

  setInterval(()=>{
    if (client && client.connected && isHost) sendState();
  }, 2000);
}

function searchRoom(){
  const code = (document.getElementById("join-code").value || "").trim().toUpperCase();
  if (code.length !== 4) { alert("Enter 4-letter code."); return; }
  roomCode = code;
  isHost = false;
  
  const btn = document.getElementById("btn-search");
  btn.textContent = "CONNECTING...";
  btn.disabled = true;

  if (client) client.end();
  client = mqtt.connect(BROKER);
  
  // 1. Connection Timeout (Firewall/VPN check)
  connectTimeout = setTimeout(()=>{
    btn.textContent = "CONNECTION BLOCKED";
    btn.disabled = false;
    client.end();
  }, 5000);

  client.on("connect", ()=>{
    clearTimeout(connectTimeout); // Connection success
    btn.textContent = "FINDING ROOM...";
    client.subscribe(`${TOPIC_PRE}/${roomCode}`);
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"REQ_STATE"}));

    // 2. Room Timeout (Code check)
    searchTimeout = setTimeout(()=>{
      btn.textContent = "ROOM NOT FOUND";
      btn.disabled = false;
      client.end();
    }, 5000);
  });
  
  client.on("message", handleMsg);
  client.on("error", ()=>{
    clearTimeout(connectTimeout);
    btn.textContent = "NET ERROR";
    btn.disabled = false;
  });
}

function enterGame(){
  myName = (document.getElementById("join-name").value || "").trim();
  if (!myName) return;
  if (client && client.connected){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"JOIN", name: myName}));
  }
  startGame();
}

function startGame(){
  goTo("screen-game");
  document.getElementById("inf-code").textContent = roomCode;
  
  const mg = document.getElementById("mini-grid");
  mg.innerHTML = "";
  for (let i=1;i<=25;i++){
    const d = document.createElement("div");
    d.className = "trk-cell";
    d.id = "trk-" + i;
    d.textContent = i;
    mg.appendChild(d);
  }

  const nums = generateGridFor(myName);
  const grid = document.getElementById("tile-grid");
  grid.innerHTML = "";
  
  nums.forEach(n=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = n;
    t.dataset.n = n;
    t.onclick = ()=>{
      const num = parseInt(t.dataset.n,10);
      if ((gameState.revealed || []).includes(num)){
        t.classList.add("revealed");
        t.classList.remove("missed-call");
      } else {
        alert("That number hasn't been called yet.");
      }
    };
    grid.appendChild(t);
  });

  if (gameImg) document.getElementById("target-img").src = gameImg;
  updateUI();
  
  // Start visual timer tick
  if (!timerInterval) {
    timerInterval = setInterval(tickTimer, 1000);
  }
}

/*
========================================
#17 GAME LOOP HELPERS
========================================
*/
function playersCount(){ return (gameState.players || []).length; }
function clampIdx(i){ return Math.max(0, Math.min(i, playersCount()-1)); }
function getActivePlayerName(){
  const ps = gameState.players || [];
  if (!ps.length) return "";
  const idx = clampIdx(gameState.activeIdx || 0);
  return ps[idx]?.name || "";
}
function isActivePlayer(name){
  return !!name && name === getActivePlayerName();
}
function advanceTurn(){
  const ps = gameState.players || [];
  if (!ps.length) { gameState.activeIdx = 0; return; }
  gameState.activeIdx = ((gameState.activeIdx || 0) + 1) % ps.length;
}
function endTurnCycleIfComplete(){
  if (!playersCount()) return;
  if ((gameState.activeIdx || 0) === (gameState.roundStartIdx || 0)){
    gameState.phase = "CALL";
    gameState.pendingGuess = null;
  }
}

/*
========================================
#18 HOST ACTIONS
========================================
*/
function hostCall(){
  if (!isHost) return;
  if (gameState.status === "WIN") return;
  if (gameState.phase !== "CALL") return;
  if (!playersCount()) return;

  const avail = [];
  for (let i=1;i<=25;i++){
    if (!(gameState.revealed || []).includes(i)) avail.push(i);
  }
  if (!avail.length) return;

  const pick = avail[Math.floor(Math.random()*avail.length)];
  gameState.revealed.push(pick);
  
  // DEALER ROTATION: Shift start index by 1 each round
  gameState.roundStartIdx = ((gameState.roundStartIdx || 0) + 1) % playersCount();
  gameState.activeIdx = gameState.roundStartIdx;
  
  gameState.round = (gameState.round || 1) + 1;
  gameState.phase = "TURNS";
  gameState.pendingGuess = null;
  
  sendState();
  updateUI();
}

function hostJudge(isRight){
  if (!isHost) return;
  if (gameState.phase !== "ADJUDICATE") return;
  if (!gameState.pendingGuess) return;

  const pg = gameState.pendingGuess;

  if (isRight){
    gameState.status = "WIN";
    gameState.phase = "WIN";
    gameState.winner = pg.from;
    gameState.winGuess = pg.txt;
    gameState.revealed = Array.from({length:25}, (_,i)=>i+1);
    gameState.pendingGuess = null;
    
    sendState();
    updateUI();
    showWin(pg.from, pg.txt);
    return;
  }

  gameState.guesses.push({from: pg.from, txt: pg.txt});
  gameState.pendingGuess = null;
  
  advanceTurn();
  endTurnCycleIfComplete();
  if (gameState.phase !== "CALL") gameState.phase = "TURNS";
  
  sendState();
  updateUI();
}

function hostSkip(name){
  if (!isHost) return;
  if (gameState.phase !== "TURNS") return;
  if (gameState.status === "WIN") return;
  if (!name) return;

  if (client && client.connected){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"SKIP", who:name}));
  }
}

/*
========================================
#19 PLAYER ACTIONS
========================================
*/
function openGuess(){
  if (isHost) return;
  if (gameState.phase !== "TURNS") return;
  if (!isActivePlayer(myName)) return;
  if (gameState.status === "WIN") return;

  document.getElementById("row-guess-idle").style.display = "none";
  document.getElementById("row-guess-input").style.display = "flex";
  document.getElementById("guess-field").focus();
}

function closeGuessUI(){
  document.getElementById("row-guess-input").style.display = "none";
  document.getElementById("row-guess-idle").style.display = "flex";
  const gf = document.getElementById("guess-field");
  gf.value = "";
}

function passTurn(){
  if (isHost) return;
  if (gameState.phase !== "TURNS") return;
  if (!isActivePlayer(myName)) return;
  if (gameState.status === "WIN") return;

  closeGuessUI();
  if (client && client.connected){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"PASS", from: myName}));
  }
}

function sendGuess(){
  if (isHost) return;
  if (gameState.phase !== "TURNS") return;
  if (!isActivePlayer(myName)) return;
  if (gameState.status === "WIN") return;

  const gf = document.getElementById("guess-field");
  const g = (gf.value || "").trim();
  if (!g) return;

  closeGuessUI();
  if (client && client.connected){
    client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"GUESS", from: myName, txt: g}));
  }
}

/*
========================================
#20 UI UPDATE LOOP
========================================
*/
function resetTimer(){
  timerSeconds = 120; // 2 minutes
  renderTimer();
}
function tickTimer(){
  // Only tick if in TURNS phase and not WIN
  if (gameState.phase === "TURNS" && gameState.status !== "WIN") {
    timerSeconds--;
    renderTimer();

    // NUDGE: Play chime every 15s if in overtime
    if (timerSeconds < 0 && (Math.abs(timerSeconds) % 15 === 0)) {
      if (isActivePlayer(myName)) {
        try { TURN_CHIME.play().catch(()=>{}); } catch(e){}
      }
    }
  }
}
function renderTimer(){
  const disp = document.getElementById("timer-val");
  const abs = Math.abs(timerSeconds);
  const m = Math.floor(abs / 60);
  const s = abs % 60;
  const txt = (timerSeconds < 0 ? "-" : "") + m + ":" + (s < 10 ? "0"+s : s);
  
  if (disp) {
    disp.textContent = txt;
    if (timerSeconds <= 0) disp.classList.add("overtime");
    else disp.classList.remove("overtime");
  }
}

function updateUI(){
  document.getElementById("inf-host").textContent = gameState.host || "?";
  document.getElementById("inf-phase").textContent = (gameState.phase || "?").toUpperCase();
  document.getElementById("inf-round").textContent = gameState.round || 1;

  const st = document.getElementById("inf-status");
  if (gameState.status === "WIN" || gameState.phase === "WIN"){
    st.textContent = `${gameState.winner || "???"} wins!`;
  } else if (gameState.phase === "ADJUDICATE" && gameState.pendingGuess){
    const g = (gameState.pendingGuess.txt || "").trim();
    st.textContent = `"${g || "?"}" is being judged`;
  } else if (gameState.phase === "TURNS"){
    const ap = getActivePlayerName();
    st.textContent = ap ? `Turn: ${ap}` : "Turn: ?";
  } else {
    st.textContent = "WAITING";
  }

  /* Tab Title Blinking */
  if (!isHost && isActivePlayer(myName) && gameState.phase === "TURNS" && gameState.status !== "WIN"){
    // Blink title
    const isOdd = Math.floor(Date.now() / 1000) % 2 === 0;
    document.title = isOdd ? "ðŸ”´ YOUR TURN!" : "REVEAL!";
  } else {
    document.title = "REVEAL!";
  }

  /* Host Answer */
  const ha = document.getElementById("host-answer-line");
  const hav = document.getElementById("host-answer-val");
  const showHostAnswer = isHost
    && (gameState.status !== "WIN")
    && (gameState.phase === "ADJUDICATE")
    && !!(gameState.ans || "").trim();
  
  if (ha && hav){
    if (showHostAnswer){
      hav.textContent = (gameState.ans || "").trim();
      ha.style.display = "block";
    } else {
      hav.textContent = "?";
      ha.style.display = "none";
    }
  }

  /* Called Numbers & Check for Missed Clicks */
  let last = 0;
  const rev = gameState.revealed || [];
  rev.forEach(n=>{
    const el = document.getElementById("trk-" + n);
    if (el) el.classList.add("active");
    last = n;
  });
  document.getElementById("current-call-text").textContent = (last || "--");

  // Pulse tiles that are called but not revealed
  document.querySelectorAll("#tile-grid .tile").forEach(t => {
    const num = parseInt(t.dataset.n, 10);
    // If not revealed locally...
    if (!t.classList.contains("revealed")) {
      // ...but it IS in the server list
      if (rev.includes(num)) {
        t.classList.add("missed-call");
      } else {
        t.classList.remove("missed-call");
      }
    }
  });


  /* Players List + Mini Cards (SORTED: Active Top) */
  const pl = document.getElementById("list-players");
  if (pl){
    pl.innerHTML = "";
    
    // Sort players: Active first, then by index
    const ap = getActivePlayerName();
    let sorted = [...(gameState.players || [])];
    
    // Simple sort: if p.name == ap, move to front
    sorted.sort((a,b) => {
      if (a.name === ap) return -1;
      if (b.name === ap) return 1;
      return 0; // maintain original order otherwise
    });

    sorted.forEach(p=>{
      const row = document.createElement("div");
      row.className = "sb-item" + (p.name === ap ? " active-turn" : "");
      
      const content = document.createElement("div");
      content.className = "player-row-content";

      // MINI GRID
      const deck = document.createElement("div");
      deck.className = "mini-deck";
      const pGrid = generateGridFor(p.name);
      pGrid.forEach(n => {
        const t = document.createElement("div");
        t.className = "md-tile" + (rev.includes(n) ? " hit" : "");
        deck.appendChild(t);
      });
      content.appendChild(deck);

      // NAME + BADGE
      const nameDiv = document.createElement("div");
      nameDiv.textContent = p.name;
      if (p.name === myName) {
        const meBadge = document.createElement("span");
        meBadge.className = "you-badge";
        meBadge.textContent = "YOU";
        nameDiv.appendChild(meBadge);
      }
      content.appendChild(nameDiv);
      
      row.appendChild(content);

      // ACTIONS (Host Only)
      if (isHost){
        const acts = document.createElement("div");
        acts.className = "sb-actions";
        const btn = document.createElement("button");
        btn.className = "mini-btn danger";
        btn.textContent = "SKIP";
        btn.disabled = !(gameState.phase === "TURNS" && p.name === ap && gameState.status !== "WIN");
        btn.onclick = ()=>hostSkip(p.name);
        acts.appendChild(btn);
        row.appendChild(acts);
      }
      pl.appendChild(row);
    });
  }

  /* Wrong Guesses */
  const lg = document.getElementById("list-guesses");
  if (lg){
    lg.innerHTML = "";
    (gameState.guesses || []).forEach(g=>{
      const d = document.createElement("div");
      d.className = "sb-item";
      d.textContent = `${g.from}: "${g.txt}"`;
      lg.appendChild(d);
    });
  }

  /* Controls Gating */
  const myTurn = (!isHost)
    && (gameState.phase === "TURNS")
    && isActivePlayer(myName)
    && (gameState.status !== "WIN");

  if (!myTurn) closeGuessUI();

  document.getElementById("host-row-adj").style.display = isHost ? "flex" : "none";
  document.getElementById("host-row-adj2").style.display = isHost ? "flex" : "none";
  document.getElementById("btn-host-call").style.display = isHost ? "block" : "none";

  document.getElementById("player-row-pass").style.display = isHost ? "none" : "flex";
  document.getElementById("row-guess-idle").style.display = isHost ? "none" : (document.getElementById("row-guess-input").style.display === "flex" ? "none" : "flex");

  const btnPass = document.getElementById("btn-pass");
  const btnGuess = document.getElementById("btn-guess");
  const btnSend = document.getElementById("btn-send");
  if (btnPass) btnPass.disabled = !myTurn;
  if (btnGuess) btnGuess.disabled = !myTurn;
  if (btnSend) btnSend.disabled = !myTurn;

  const pending = !!gameState.pendingGuess && (gameState.phase === "ADJUDICATE") && (gameState.status !== "WIN");
  document.getElementById("btn-right").disabled = !pending;
  document.getElementById("btn-wrong").disabled = !pending;

  const canCall = isHost && (gameState.phase === "CALL") && (gameState.status !== "WIN") && playersCount() > 0;
  document.getElementById("btn-host-call").disabled = !canCall;

  if ((gameState.status === "WIN" || gameState.phase === "WIN") && gameState.winner){
    showWin(gameState.winner, gameState.winGuess || "");
  }
}

function showWin(name, guess){
  const ov = document.getElementById("win-overlay");
  document.getElementById("win-title").textContent = `${name} wins!`;
  document.getElementById("win-sub").textContent = `They Guessed: ${guess || "(unknown)"} (Round ${gameState.round || 1})`;
  if (gameImg) document.getElementById("win-img").src = gameImg;
  ov.style.display = "flex";
}
function hideWin(){
  document.getElementById("win-overlay").style.display = "none";
}

/*
========================================
#21 BOOTSTRAP
========================================
*/
(function init(){
  populateSkinSelect("host-style");
  populateSkinSelect("join-style");
  populateSkinSelect("style-in-game");
  setMySkin(mySkinKey);
})();
</script>
</body>
</html>
