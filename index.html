<!DOCTYPE html>
<html lang="en">
<!-- 
    IMAGE REVEAL BEANO v20.2
    - LAYOUT: 3-Column Design (Guesses | Board | Players).
    - VISUAL: Host Name in header, Copy Code on click.
    - LOGIC: Turn-based shuffling implemented.
    - FIX: Image starts covered. Host controls flow.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REVEAL! v20.2</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #4c1d95;
            --accent: #2dd4bf;
            --text-color: #ffffff;
            --tile-color: #1e293b;
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh; display: flex; flex-direction: column;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; inset: 0; 
            display: flex; flex-direction: column; 
            overflow-y: auto; background: var(--bg-color);
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        .screen.active { transform: translateX(0); }
        .center-content { align-items: center; justify-content: center; padding: 20px; }

        h1 { font-family: var(--font-head); font-size: 3rem; margin: 0; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); }
        .subtitle { opacity: 0.8; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; }

        .card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; width: 100%; max-width: 400px;
            border: 2px solid rgba(255,255,255,0.2); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* INPUTS & BUTTONS */
        .control-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: 900; margin-bottom: 5px; font-size: 0.8rem; text-transform: uppercase; color: rgba(255,255,255,0.7); }
        input, select {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            font-family: var(--font-body); font-weight: bold; font-size: 1.1rem;
            background: rgba(255,255,255,0.9); color: #333; outline: none;
        }
        .code-input { font-family: 'Courier New', monospace; letter-spacing: 5px; text-align: center; text-transform: uppercase; font-weight: 900; }

        .big-btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-family: var(--font-head); font-size: 1.4rem; cursor: pointer;
            background: var(--accent); color: #000;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s; margin-top: 10px;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn.secondary { background: rgba(255,255,255,0.2); color: white; }

        /* --- GAME LAYOUT (3 Columns) --- */
        #game-layout {
            display: flex; flex: 1; width: 100%; overflow: hidden;
            position: relative;
        }
        
        /* HEADER (JUMBOTRON) */
        #jumbotron {
            height: 60px; width: 100%; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
        }
        #host-badge { font-weight: 900; text-transform: uppercase; font-size: 1.2rem; }
        #cat-badge { background: #fbbf24; color: black; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; }
        #room-badge { 
            font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.2rem; 
            cursor: pointer; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px;
        }
        #room-badge:active { background: rgba(255,255,255,0.2); }

        /* COLUMNS */
        .side-col {
            flex: 1; padding: 10px; display: flex; flex-direction: column;
            background: rgba(0,0,0,0.1); overflow-y: auto;
            max-width: 200px;
        }
        #center-col {
            flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; padding: 20px;
        }

        /* LISTS */
        .list-header { font-family: var(--font-head); text-transform: uppercase; opacity: 0.5; margin-bottom: 10px; text-align: center; }
        
        .guess-item {
            background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.3);
            padding: 5px 10px; border-radius: 8px; margin-bottom: 5px; font-size: 0.8rem;
        }
        .guess-item span { display: block; font-weight: bold; opacity: 0.8; font-size: 0.7rem; }
        
        .player-item {
            background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;
            margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; text-align: center;
            border: 2px solid transparent;
        }
        .player-item.active-turn {
            border-color: var(--accent); background: rgba(45, 212, 191, 0.2);
            animation: pulseTurn 1s infinite;
        }
        @keyframes pulseTurn { 0%{border-color:var(--accent);} 50%{border-color:white;} 100%{border-color:var(--accent);} }

        /* BOARD */
        #game-board-container {
            width: 90vmin; height: 90vmin;
            max-width: 500px; max-height: 500px;
            position: relative;
            background: #000;
            border: 4px solid #fff; border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        #target-image {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; inset: 0; z-index: 1;
        }
        #grid-overlay {
            position: absolute; inset: 0; z-index: 2;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 1px;
        }
        .tile {
            background: var(--tile-color);
            color: rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-head); font-size: 1.5rem;
            cursor: pointer; user-select: none;
            transition: opacity 0.3s;
        }
        .tile.revealed { opacity: 0; pointer-events: none; }
        
        /* TILE 23 */
        .tile[data-n="23"] span { display: none; }
        .tile[data-n="23"]::after { content: '23'; color: #fbbf24; font-size: 1.2rem; }

        /* FOOTER ACTION */
        #action-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; display: flex; gap: 10px; z-index: 100;
        }
        
        /* CHAT */
        #btn-chat {
            position: absolute; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: white; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 200;
        }
        #btn-chat.shake { animation: shake 0.5s infinite; background: #fbbf24; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        /* MOBILE ADJUSTMENTS */
        @media (max-width: 700px) {
            .side-col { display: none; } /* Hide sidebars on phone, maybe add drawer toggles later */
            #center-col { padding: 10px; }
            /* Simple mobile layout: just board + buttons */
        }
        
        #chat-drawer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 50vh;
            background: white; color: #333; z-index: 2000;
            transform: translateY(110%); transition: transform 0.3s;
            display: flex; flex-direction: column; border-radius: 20px 20px 0 0;
        }
        #chat-drawer.open { transform: translateY(0); }
        
        #input-guess-modal {
            position: fixed; top: 20%; left: 5%; right: 5%; 
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.8); z-index: 3000;
            display: none; flex-direction: column; align-items: center; text-align: center;
        }
        #input-guess-modal.active { display: flex; }

    </style>
</head>
<body>

    <!-- SCREEN 1: START -->
    <div id="screen-start" class="screen active center-content">
        <h1>REVEAL!</h1>
        <div class="subtitle">v20.2</div>
        <div style="display:flex; flex-direction:column; gap:15px; width:100%;">
            <button class="big-btn" onclick="goToHost()">HOST A GAME</button>
            <button class="big-btn secondary" onclick="goToJoin()">JOIN A GAME</button>
        </div>
    </div>

    <!-- SCREEN 2: HOST SETUP -->
    <div id="screen-host" class="screen center-content">
        <h2>SETUP</h2>
        <div class="card">
            <div class="control-group">
                <label>Host Name</label>
                <input type="text" id="host-name" placeholder="YOUR NAME">
            </div>
            <div class="control-group">
                <label>Category</label>
                <input type="text" id="game-cat" placeholder="E.G. 80s MOVIES">
            </div>
            <div class="control-group">
                <label>Answer</label>
                <input type="text" id="game-ans" placeholder="THE SECRET">
            </div>
            <div class="control-group">
                <label>Image</label>
                <input type="file" id="img-upload" accept="image/*" onchange="processImage()">
                <div id="img-preview-box" style="width:100px; height:100px; margin:10px auto; display:none;"><img id="img-preview" style="width:100%; height:100%; object-fit:cover;"></div>
            </div>
            <div class="control-group">
                <label>Theme</label>
                <select id="host-skin" onchange="applySkin(this.value)">
                    <option value="default">Vibrant</option>
                    <option value="dark">Dark Mode</option>
                    <option value="retro">Retro</option>
                </select>
            </div>
            <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE</button>
        </div>
    </div>

    <!-- SCREEN 3: JOIN CODE -->
    <div id="screen-join-code" class="screen center-content">
        <h2>ENTER CODE</h2>
        <div class="card">
            <input type="text" id="join-code-input" class="code-input" maxlength="4" placeholder="ABCD">
            <button class="big-btn" onclick="verifyCode()">NEXT</button>
        </div>
    </div>

    <!-- SCREEN 4: JOIN DETAILS -->
    <div id="screen-join-setup" class="screen center-content">
        <h2 id="join-room-title">ROOM: ????</h2>
        <div style="margin-bottom:15px; font-weight:bold; color:var(--accent);" id="join-host-display">Loading Host...</div>
        <div class="card">
            <div class="control-group">
                <label>Your Name</label>
                <input type="text" id="join-name" placeholder="YOUR NAME">
            </div>
            <button class="big-btn" onclick="joinGame()">ENTER</button>
        </div>
    </div>

    <!-- SCREEN 5: GAME BOARD -->
    <div id="screen-game" class="screen" style="padding:0;">
        <!-- HEADER -->
        <div id="jumbotron">
            <span id="cat-badge">CATEGORY</span>
            <span id="host-badge">HOST: ???</span>
            <span id="room-badge" onclick="copyCode()">CODE</span>
        </div>

        <div id="game-layout">
            <!-- LEFT: GUESSES -->
            <div class="side-col" id="col-guesses">
                <div class="list-header">WRONG GUESSES</div>
                <div id="list-guesses"></div>
            </div>

            <!-- CENTER: BOARD -->
            <div id="center-col">
                <div id="game-board-container">
                    <img id="target-image" src="">
                    <div id="grid-overlay"></div>
                </div>
            </div>

            <!-- RIGHT: PLAYERS -->
            <div class="side-col" id="col-players">
                <div class="list-header">PLAYERS</div>
                <div id="list-players"></div>
            </div>
        </div>

        <!-- FOOTER ACTION -->
        <div id="action-bar">
            <!-- DYNAMIC BUTTONS INSERTED HERE -->
        </div>

        <button id="btn-chat" onclick="toggleChat()">ðŸ’¬</button>

        <!-- GUESS MODAL -->
        <div id="input-guess-modal">
            <h2 style="color:#333;">IT IS YOUR TURN!</h2>
            <input type="text" id="guess-input" placeholder="TYPE ANSWER..." style="border:2px solid #333; margin-bottom:10px;">
            <div style="display:flex; gap:10px; width:100%;">
                <button class="big-btn" onclick="submitGuess()">SUBMIT</button>
                <button class="big-btn secondary" style="background:#ef4444;" onclick="passTurn()">PASS</button>
            </div>
        </div>

        <!-- CHAT DRAWER -->
        <div id="chat-drawer">
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <strong>CHAT</strong>
                <button onclick="toggleChat()" style="border:none; bg:none;">X</button>
            </div>
            <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:10px;"></div>
            <div style="padding:10px; display:flex;">
                <input id="chat-txt" type="text" placeholder="Message...">
                <button onclick="sendChat()" style="margin-left:5px; background:var(--accent); border:none; padding:0 15px; border-radius:8px;">&rarr;</button>
            </div>
        </div>
    </div>

<script>
    // --- SKINS ---
    const SKINS = {
        default: { bg: '#4c1d95', acc: '#2dd4bf', text: '#fff', tile: '#1e293b' },
        dark: { bg: '#18181b', acc: '#facc15', text: '#f4f4f5', tile: '#27272a' },
        retro: { bg: '#0f766e', acc: '#f43f5e', text: '#fff', tile: '#334155' }
    };
    function applySkin(key) {
        const s = SKINS[key] || SKINS.default;
        document.documentElement.style.setProperty('--bg-color', s.bg);
        document.documentElement.style.setProperty('--accent', s.acc);
        document.documentElement.style.setProperty('--tile-color', s.tile);
    }

    // --- STATE ---
    let myName, roomCode, isHost;
    let client;
    let gameImg = null; 
    let gameState = { 
        hostName: "", 
        players: [], 
        guesses: [], 
        revealed: [],
        turnOrder: [],
        currentTurnIdx: 0,
        status: 'WAITING' // WAITING, PLAYING, GUESSING
    };
    
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_PRE = 'reveal_v20_2';

    // --- NAVIGATION ---
    function goTo(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goToHost() { goTo('screen-host'); }
    function goToJoin() { goTo('screen-join-code'); }

    // --- HOST SETUP ---
    function processImage() {
        const file = document.getElementById('img-upload').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                // Center crop 1:1
                const s = Math.min(img.width, img.height);
                canvas.width = 600; canvas.height = 600;
                ctx.drawImage(img, (img.width-s)/2, (img.height-s)/2, s, s, 0, 0, 600, 600);
                gameImg = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('img-preview').src = gameImg;
                document.getElementById('img-preview').parentElement.style.display='block';
                checkHostReady();
            };
        };
        reader.readAsDataURL(file);
    }
    function checkHostReady() {
        const n=document.getElementById('host-name').value, c=document.getElementById('game-cat').value, a=document.getElementById('game-ans').value;
        document.getElementById('btn-create').disabled = !(n && c && a && gameImg);
    }
    ['host-name','game-cat','game-ans'].forEach(id=>document.getElementById(id).addEventListener('keyup', checkHostReady));

    function createGame() {
        myName = document.getElementById('host-name').value;
        gameState.hostName = myName;
        roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        isHost = true;
        gameState.players.push({name: myName, score: 0});
        
        // Setup Local UI
        setupGameUI();
        connectMQTT();
    }

    // --- JOIN FLOW ---
    function verifyCode() {
        const c = document.getElementById('join-code-input').value.trim().toUpperCase();
        if(c.length !== 4) return alert("Code must be 4 letters");
        roomCode = c;
        // Move to Setup
        goTo('screen-join-setup');
        document.getElementById('join-room-title').innerText = "ROOM: " + c;
        // Connect to get Host Name early
        connectMQTT();
    }

    function joinGame() {
        myName = document.getElementById('join-name').value;
        if(!myName) return alert("Enter Name");
        send({ type: 'JOIN', name: myName });
        isHost = false;
        setupGameUI();
    }

    // --- UI SETUP ---
    function setupGameUI() {
        goTo('screen-game');
        document.getElementById('room-badge').innerText = roomCode;
        if(isHost) {
            document.getElementById('target-image').src = gameImg;
            document.getElementById('cat-badge').innerText = document.getElementById('game-cat').value;
            document.getElementById('host-badge').innerText = "HOST: " + myName;
            updateActionBar();
        }
        buildGrid();
    }
    
    function buildGrid() {
        const g = document.getElementById('grid-overlay'); g.innerHTML = '';
        for(let i=1; i<=25; i++) {
            let t = document.createElement('div');
            t.className = 'tile'; t.dataset.n = i; t.innerText = i;
            if(i===23) { t.innerHTML = '<span>23</span>'; t.classList.add('eye-tile'); } // Prep for pyramid
            t.onclick = () => { if(isHost) revealTile(i); }; // Host reveals manually for now
            g.appendChild(t);
        }
    }

    function updateActionBar() {
        const bar = document.getElementById('action-bar');
        bar.innerHTML = '';
        
        if(isHost) {
            bar.innerHTML = `
                <button class="big-btn" onclick="hostCallNumber()">CALL #</button>
                <button class="big-btn secondary" onclick="startGuessRound()">START GUESSING</button>
            `;
        } else {
            if(gameState.status === 'GUESSING') {
                // If it is my turn
                if(gameState.turnOrder[gameState.currentTurnIdx] === myName) {
                    bar.innerHTML = `<button class="big-btn" onclick="openGuessModal()">IT'S YOUR TURN!</button>`;
                } else {
                     bar.innerHTML = `<div style="background:rgba(0,0,0,0.5); padding:10px; border-radius:10px;">Waiting for ${gameState.turnOrder[gameState.currentTurnIdx]}...</div>`;
                }
            } else {
                bar.innerHTML = `<button class="big-btn" onclick="requestGuess()">I KNOW IT!</button>`;
            }
        }
    }

    // --- GAMEPLAY LOGIC ---
    function hostCallNumber() {
        // Logic to pick random number not in revealed
        let available = [];
        for(let i=1; i<=25; i++) if(!gameState.revealed.includes(i)) available.push(i);
        if(available.length === 0) return;
        let pick = available[Math.floor(Math.random()*available.length)];
        
        gameState.revealed.push(pick);
        sendState();
    }
    
    function startGuessRound() {
        // Shuffle Players
        let pNames = gameState.players.map(p => p.name);
        gameState.turnOrder = pNames.sort(() => Math.random() - 0.5);
        gameState.currentTurnIdx = 0;
        gameState.status = 'GUESSING';
        sendState();
    }

    // --- RENDERING STATE ---
    function renderState() {
        // 1. Host Name
        document.getElementById('host-badge').innerText = "HOST: " + gameState.hostName;
        // 2. Category (Joiners get this from state)
        if(gameState.category) document.getElementById('cat-badge').innerText = gameState.category;
        
        // 3. Tiles
        document.querySelectorAll('.tile').forEach(t => {
            let n = parseInt(t.dataset.n);
            if(gameState.revealed.includes(n)) t.classList.add('revealed');
        });

        // 4. Player List
        const pList = document.getElementById('list-players');
        pList.innerHTML = '';
        gameState.players.forEach(p => {
            let div = document.createElement('div');
            div.className = 'player-item';
            div.innerText = p.name;
            // Highlight turn
            if(gameState.status === 'GUESSING' && gameState.turnOrder[gameState.currentTurnIdx] === p.name) {
                div.classList.add('active-turn');
            }
            pList.appendChild(div);
        });

        // 5. Guesses
        const gList = document.getElementById('list-guesses');
        gList.innerHTML = '';
        gameState.guesses.forEach(g => {
            let div = document.createElement('div');
            div.className = 'guess-item';
            div.innerHTML = `<span>${g.name}</span>${g.guess}`;
            gList.prepend(div);
        });
        
        updateActionBar();
    }

    // --- MQTT ---
    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const t = `${TOPIC_PRE}/${roomCode}`;
        
        client.on('connect', () => {
            client.subscribe(t);
            if(!isHost) {
                // Request state immediately
                client.publish(t, JSON.stringify({type:'REQ_STATE', from:myName}));
            }
        });

        client.on('message', (tpc, m) => {
            const msg = JSON.parse(m.toString());
            
            if(msg.type === 'STATE') {
                gameState = msg.state;
                // If I am joiner and just joined, grab the image
                if(!isHost && msg.img && document.getElementById('target-image').src === "") {
                    document.getElementById('target-image').src = msg.img;
                }
                renderState();
                
                // Update Host Name on Join Screen if waiting
                if(document.getElementById('screen-join-setup').classList.contains('active')) {
                    document.getElementById('join-host-display').innerText = "HOST: " + gameState.hostName;
                }
            }
            
            if(msg.type === 'JOIN' && isHost) {
                // Add player if new
                if(!gameState.players.find(p=>p.name===msg.name)) {
                    gameState.players.push({name:msg.name, score:0});
                    sendState();
                }
            }
            
            if(msg.type === 'REQ_STATE' && isHost) {
                sendState();
            }
            
            if(msg.type === 'CHAT') {
                const box = document.getElementById('chat-msgs');
                box.innerHTML += `<div class="msg"><b>${msg.from}:</b> ${msg.txt}</div>`;
                if(!document.getElementById('chat-drawer').classList.contains('open')) {
                    document.getElementById('btn-chat').classList.add('shake');
                }
            }
        });
    }

    function sendState() {
        if(!isHost) return;
        // Attach image only occasionally or if requested? 
        // For simple proto, attach image to every state (bandwidth heavy but reliable)
        let pl = { type: 'STATE', state: gameState, img: gameImageBase64 };
        // Sync Category too
        gameState.category = document.getElementById('game-cat').value;
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl));
    }
    
    function send(pl) { client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl)); }

    // --- UTILS ---
    function copyCode() {
        navigator.clipboard.writeText(roomCode);
        alert("Copied: " + roomCode);
    }
    
    function toggleChat() {
        document.getElementById('chat-drawer').classList.toggle('open');
        document.getElementById('btn-chat').classList.remove('shake');
    }
    
    function sendChat() {
        let txt = document.getElementById('chat-txt').value;
        if(txt) {
            send({type:'CHAT', from:myName, txt:txt});
            document.getElementById('chat-txt').value = '';
        }
    }
    
    // Guessing Mockups
    function openGuessModal() { document.getElementById('input-guess-modal').classList.add('active'); }
    function submitGuess() {
        let g = document.getElementById('guess-input').value;
        // Logic to send guess to host...
        document.getElementById('input-guess-modal').classList.remove('active');
    }

</script>
</body>
</html>
