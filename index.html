<!DOCTYPE html>
<html lang="en">
<!--
  REVEAL! v4.8.1 – Host adjudication + turn gating (no fuzzy matching)

  CORE LOOP (v4.8)
  - Host CALLS a number -> starts a full player turn-cycle.
  - Only active player can PASS or GUESS.
  - If player GUESSES -> game enters ADJUDICATE. Host must click RIGHT/WRONG.
  - WRONG -> guess added to public list; turn advances.
  - RIGHT -> WIN overlay (winner + guess + revealed picture). Winning guess NOT shown in sidebar.
  - CALL NEXT is disabled until the entire cycle completes (everyone has had a turn).

  NOTES
  - Everyone sees ALL wrong guesses (no %).
  - Status shows: “"GUESS" is being judged” during adjudication.
  - Host can SKIP a player.
  - No 23 gag.
  - Jumbotron panels are square (no rectangles).
-->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>REVEAL! v4.8.1</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color:#4c1d95;
      --panel-bg:rgba(0,0,0,.25);
      --accent:#2dd4bf;
      --text-main:#fff;
      --font-head:'Fredoka One',cursive;
      --font-body:'Nunito',sans-serif;
      --tile-off:#1e293b;

      --card-max-width:450px;
      --ink:#0b1220;
    }

    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; width:100vw; overflow:hidden;
      background:var(--bg-color); color:var(--text-main);
      font-family:var(--font-body);
    }

    .screen{
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:var(--bg-color);
      transform:translateX(100%); transition:transform .25s ease;
      z-index:10;
    }
    .screen.active{transform:translateX(0); z-index:20;}

    .card-panel{
      background:rgba(255,255,255,.1);
      border:2px solid rgba(255,255,255,.18);
      border-radius:20px;
      width:90%; max-width:420px;
      padding:22px;
      backdrop-filter:blur(10px);
      box-shadow:0 10px 30px rgba(0,0,0,.3);
      text-align:center;
    }

    h1,h2{margin:0 0 12px 0; font-family:var(--font-head);}
    .control-group{margin:10px 0; text-align:left;}
    label{
      display:block; font-weight:900; font-size:.78rem;
      opacity:.8; text-transform:uppercase; margin:0 0 6px 0;
    }
    input,select{
      width:100%; border:none; border-radius:10px;
      padding:12px; font-family:var(--font-body); font-weight:900; font-size:1.05rem;
      outline:none; background:#f8fafc; color:#0f172a;
    }
    .code-input{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:5px; text-align:center; font-size:1.55rem; text-transform:uppercase;
    }

    .big-btn{
      width:100%; border:none; border-radius:12px; padding:15px;
      font-family:var(--font-head); font-size:1.15rem;
      background:var(--accent); color:#000;
      cursor:pointer;
      box-shadow:0 5px 0 rgba(0,0,0,.25);
      transition:transform .08s;
      margin-top:8px;
    }
    .big-btn:active{transform:translateY(2px); box-shadow:none;}
    .big-btn.secondary{background:rgba(255,255,255,.18); color:#fff;}
    .big-btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none; transform:none;}

    /* GAME LAYOUT */
    #screen-game{
      display:grid;
      grid-template-rows: 1fr 60px;
      height:100%; width:100%;
      padding:0;
    }
    #game-layout{
      display:grid;
      grid-template-columns: 220px 1fr 220px;
      overflow:hidden;
    }
    .sidebar{
      background:var(--panel-bg);
      border-left:1px solid rgba(255,255,255,.05);
      border-right:1px solid rgba(255,255,255,.05);
      padding:10px;
      overflow:auto;
    }
    .sb-head{
      font-family:var(--font-head);
      opacity:.65;
      font-size:.9rem;
      text-align:center;
      margin-bottom:10px;
    }
    .sb-item{
      font-size:.86rem;
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,.06);
      word-break:break-word;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sb-item.active-turn{
      background:rgba(255,255,255,.18);
      border-left:4px solid var(--accent);
      padding-left:6px;
    }
    .sb-actions{
      display:flex; gap:6px; flex:0 0 auto;
    }
    .mini-btn{
      border:none; border-radius:8px;
      padding:6px 8px;
      font-weight:900;
      cursor:pointer;
      background:rgba(255,255,255,.15);
      color:#fff;
      font-size:.75rem;
    }
    .mini-btn:disabled{opacity:.4; cursor:not-allowed;}
    .mini-btn.danger{background:rgba(239,68,68,.75);}

    #center-stage{
      padding:10px;
      overflow:auto;
      display:flex;
      justify-content:flex-start;
      align-items:center;
      flex-direction:column;
    }
    .game-stack{
      width:100%;
      max-width:var(--card-max-width);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* HEADER */
    #header-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:4px;
      background:var(--panel-bg);
      padding:6px 6px 5px;
      border-radius:8px;
    }
    .info-cell{text-align:center; overflow:hidden;}
    .info-lbl{font-size:.52rem; opacity:.65; font-weight:900; text-transform:uppercase;}
    .info-val{font-size:.85rem; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #inf-code{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      cursor:pointer;
      background:rgba(255,255,255,.12);
      border-radius:6px;
      padding:2px 6px;
      display:inline-block;
    }
    #info-status{grid-column:1 / -1;}
    #inf-status{font-weight:900;}

    /* CATEGORY ABOVE CARD */
    #cat-strip{
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #cat-strip .left{
      display:flex; flex-direction:column; align-items:flex-start; gap:2px; min-width:0;
    }
    #cat-strip .lbl{font-size:.6rem; opacity:.75; font-weight:900; text-transform:uppercase;}
    #cat-strip .val{font-size:1rem; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    #cat-strip .me{
      font-size:.8rem;
      font-weight:900;
      opacity:.9;
      background:rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* JUMBOTRON (SQUARE PANELS) */
    #jumbotron{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      width:100%;
    }
    #mini-grid-container,
    #call-box{
      aspect-ratio:1/1;
      width:100%;
      border-radius:12px;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.9);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #mini-grid-container{padding:8px;}
    #mini-grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns:repeat(5,1fr);
      grid-template-rows:repeat(5,1fr);
      gap:0;
    }
    .trk-cell{
      display:flex; align-items:center; justify-content:center;
      color:rgba(148,163,184,.9);
      font-weight:900;
      font-size:.78rem;
      user-select:none;
    }
    .trk-cell.active{
      color:var(--accent);
      text-shadow:0 0 10px var(--accent);
    }

    /* Current call panel – NO throbbing */
    #call-box{background:#000;}
    .call-lbl{
      position:absolute; top:8px;
      font-size:.7rem; opacity:.55; font-weight:900;
      text-transform:uppercase; letter-spacing:1px;
    }
    .call-val{
      font-family:var(--font-head);
      font-size:5rem;
      line-height:1;
      color:#fff;
      transform:translateY(6px);
      animation:callPop .22s ease;
    }
    @keyframes callPop{
      from{transform:translateY(6px) scale(.92); opacity:.2;}
      to{transform:translateY(6px) scale(1); opacity:1;}
    }

    /* CARD */
    #card-wrapper{
      width:100%;
      aspect-ratio:1/1;
      position:relative;
      background:#000;
      border:4px solid rgba(255,255,255,.95);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.35);
    }
    #target-img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      z-index:1;
    }
    #tile-grid{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns:repeat(5,1fr);
      grid-template-rows:repeat(5,1fr);
      gap:0;
      z-index:10;
    }
    .tile{
      background:var(--tile-off);
      color:rgba(255,255,255,.25);
      display:flex; align-items:center; justify-content:center;
      font-family:var(--font-head);
      font-size:2rem;
      user-select:none;
      cursor:pointer;
      transition:opacity .18s ease;
    }
    .tile.revealed{opacity:0; pointer-events:none;}

    /* CONTROLS (2 ROWS PLAYER, 2 ROWS HOST) */
    #controls-zone{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .ctrl-row{
      width:100%;
      display:flex;
      gap:10px;
      height:56px;
    }
    .ctrl-btn{
      flex:1 1 auto;
      border:none;
      border-radius:12px;
      font-family:var(--font-head);
      font-size:1.15rem;
      cursor:pointer;
      box-shadow:0 5px 0 rgba(0,0,0,.25);
      transition:transform .08s;
    }
    .ctrl-btn:active{transform:translateY(2px); box-shadow:none;}
    .ctrl-btn:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none;}
    .btn-pass{background:#ef4444; color:#fff;}
    .btn-guess{background:var(--accent); color:#000;}
    .btn-send{background:#fff; color:#000; flex:0 0 130px;}
    .ctrl-input{
      flex:1 1 auto;
      border:none; border-radius:12px;
      font-weight:900;
      font-size:1.1rem;
      text-align:center;
      padding:0 14px;
      outline:none;
    }

    /* HOST CALL BUTTON BAR (bottom) */
    #chat-bar{
      background:rgba(0,0,0,.35);
      border-top:1px solid rgba(255,255,255,.08);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    #chat-input{flex:1; border:none; border-radius:10px; padding:10px; outline:none;}
    #chat-send{border:none; border-radius:10px; padding:10px 12px; font-weight:900; cursor:pointer;}

    /* TOAST */
    #toast{
      position:fixed;
      bottom:90px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,.96);
      color:#fbbf24;
      padding:10px 16px;
      border-radius:999px;
      font-size:.9rem;
      font-weight:900;
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    #toast.show{opacity:1;}

    /* WIN OVERLAY */
    #win-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    #win-card{
      width:100%;
      max-width:520px;
      border-radius:18px;
      background:rgba(255,255,255,.10);
      border:2px solid rgba(255,255,255,.20);
      backdrop-filter:blur(10px);
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:16px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    #win-title{
      font-family:var(--font-head);
      font-size:2rem;
      margin:6px 0 6px;
    }
    #win-sub{
      font-weight:900;
      opacity:.9;
      margin:0 0 12px;
      word-break:break-word;
    }
    #win-reveal{
      width:100%;
      aspect-ratio:1/1;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.75);
      overflow:hidden;
      margin-top:12px;
      position:relative;
      background:#000;
    }
    #win-img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .fw{
      position:absolute;
      width:8px; height:8px;
      border-radius:50%;
      background:var(--accent);
      opacity:.9;
      animation:fw 1.1s ease-out infinite;
      filter:drop-shadow(0 0 8px var(--accent));
    }
    .fw:nth-child(1){left:8%; top:85%; animation-delay:.0s;}
    .fw:nth-child(2){left:22%; top:80%; animation-delay:.2s;}
    .fw:nth-child(3){left:78%; top:86%; animation-delay:.35s;}
    .fw:nth-child(4){left:90%; top:82%; animation-delay:.5s;}
    @keyframes fw{
      0%{transform:translateY(0) scale(1); opacity:0;}
      15%{opacity:1;}
      60%{transform:translateY(-220px) scale(1.2); opacity:1;}
      100%{transform:translateY(-260px) scale(.2); opacity:0;}
    }

    @media (max-width: 900px){
      #game-layout{grid-template-columns:1fr;}
      .sidebar{display:none;}
    }
  </style>
</head>

<body>
  <!-- LOBBY -->
  <div id="screen-lobby" class="screen active">
    <div class="card-panel">
      <h1>REVEAL! v4.8.1</h1>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:16px;">
        <button class="big-btn" onclick="showHostSetup()">HOST GAME</button>
        <div style="opacity:.55; margin:4px 0;">OR</div>
        <button class="big-btn secondary" onclick="showJoinSetup()">JOIN GAME</button>
      </div>
    </div>
  </div>

  <!-- HOST SETUP -->
  <div id="screen-host-setup" class="screen">
    <div class="card-panel">
      <h2>GAME SETUP</h2>

      <div class="control-group">
        <label>HOST NAME</label>
        <input id="host-name" type="text" placeholder="Name">
      </div>

      <div class="control-group">
        <label>CATEGORY</label>
        <input id="game-cat" type="text" placeholder="e.g. 80s Movies">
      </div>

      <div class="control-group">
        <label>ANSWER</label>
        <input id="game-ans" type="text" placeholder="Secret Answer">
      </div>

      <div class="control-group">
        <label>IMAGE</label>
        <input id="img-upload" type="file" accept="image/*" onchange="processImage()">
      </div>

      <div class="control-group">
        <label>STYLE (PREVIEW)</label>
        <select id="host-style" onchange="setMySkin(this.value)"></select>
      </div>

      <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- JOIN CODE -->
  <div id="screen-join-code" class="screen">
    <div class="card-panel">
      <h2>ENTER CODE</h2>
      <input id="join-code" class="code-input" type="text" maxlength="4" placeholder="ABCD">
      <button class="big-btn" id="btn-search" onclick="searchRoom()">NEXT</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- JOIN SETUP -->
  <div id="screen-join-setup" class="screen">
    <div class="card-panel">
      <h2 id="join-room-disp">ROOM FOUND</h2>
      <div id="join-host-disp" style="color:var(--accent); font-weight:900; margin-bottom:12px;">Connecting...</div>

      <div class="control-group">
        <label>YOUR NAME</label>
        <input id="join-name" type="text" placeholder="Your name">
      </div>

      <div class="control-group">
        <label>STYLE (PREVIEW)</label>
        <select id="join-style" onchange="setMySkin(this.value)"></select>
      </div>

      <button class="big-btn" id="btn-enter" disabled onclick="enterGame()">ENTER GAME</button>
      <button class="big-btn secondary" onclick="goTo('screen-lobby')" style="margin-top:12px; font-size:1rem;">BACK</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div id="game-layout">

      <!-- LEFT -->
      <div class="sidebar" id="sb-players">
        <div class="sb-head">PLAYERS</div>
        <div id="list-players"></div>
      </div>

      <!-- CENTER -->
      <div id="center-stage">
        <div class="game-stack">

          <div id="header-row">
            <div class="info-cell">
              <div class="info-lbl">HOST</div>
              <div class="info-val" id="inf-host">?</div>
            </div>
            <div class="info-cell">
              <div class="info-lbl">ROOM</div>
              <div class="info-val" id="inf-code" onclick="copyCode()">????</div>
            </div>

            <div class="info-cell">
              <div class="info-lbl">STYLE</div>
              <select id="style-in-game" onchange="setMySkin(this.value)" style="padding:0;margin:0;height:22px;font-size:.85rem;background:transparent;color:#fff;border:none;outline:none;"></select>
            </div>
            <div class="info-cell">
              <div class="info-lbl">PHASE</div>
              <div class="info-val" id="inf-phase">?</div>
            </div>

            <div class="info-cell" id="info-status">
              <div class="info-lbl">STATUS</div>
              <div class="info-val" id="inf-status">WAITING</div>
            </div>
          </div>

          <div id="cat-strip">
            <div class="left">
              <div class="lbl">CATEGORY</div>
              <div class="val" id="inf-cat">?</div>
            </div>
            <div class="me" id="me-pill">ME: ?</div>
          </div>

          <div id="jumbotron">
            <div id="mini-grid-container">
              <div id="mini-grid"></div>
            </div>
            <div id="call-box">
              <div class="call-lbl" id="call-label">CURRENT CALL</div>
              <div class="call-val" id="current-call-text">--</div>
            </div>
          </div>

          <div id="card-wrapper">
            <img id="target-img" src="">
            <div id="tile-grid"></div>
          </div>

          <!-- CONTROLS ZONE -->
          <div id="controls-zone">
            <!-- PLAYER -->
            <div class="ctrl-row" id="player-row-pass">
              <button id="btn-pass" class="ctrl-btn btn-pass" onclick="passTurn()">PASS</button>
            </div>

            <div class="ctrl-row" id="row-guess-idle">
              <button id="btn-guess" class="ctrl-btn btn-guess" onclick="openGuess()">GUESS</button>
            </div>

            <div class="ctrl-row" id="row-guess-input" style="display:none;">
              <input id="guess-field" class="ctrl-input" type="text" placeholder="TYPE YOUR GUESS">
              <button id="btn-send" class="ctrl-btn btn-send" onclick="sendGuess()">SEND</button>
            </div>

            <!-- HOST -->
            <div class="ctrl-row" id="host-row-adj" style="display:none;">
              <button id="btn-wrong" class="ctrl-btn btn-pass" onclick="hostJudge(false)">WRONG</button>
            </div>
            <div class="ctrl-row" id="host-row-adj2" style="display:none;">
              <button id="btn-right" class="ctrl-btn btn-guess" onclick="hostJudge(true)">RIGHT</button>
            </div>

            <!-- HOST CALL -->
            <button id="btn-host-call" class="big-btn" style="display:none; margin-top:0;" onclick="hostCall()">CALL NEXT NUMBER</button>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="sidebar" id="sb-guesses">
        <div class="sb-head">WRONG GUESSES</div>
        <div id="list-guesses"></div>
      </div>

    </div>

    <!-- FOOTER (placeholder) -->
    <div id="chat-bar">
      <input id="chat-input" type="text" placeholder="Chat... (later)">
      <button id="chat-send" onclick="alert('Chat later')">SEND</button>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

  <!-- WIN OVERLAY -->
  <div id="win-overlay">
    <div id="win-card">
      <div class="fw"></div><div class="fw"></div><div class="fw"></div><div class="fw"></div>
      <div id="win-title">SOMEONE wins!</div>
      <div id="win-sub">They Guessed: ???</div>
      <div id="win-reveal">
        <img id="win-img" src="">
      </div>
      <button class="big-btn secondary" style="margin-top:12px;" onclick="hideWin()">CLOSE</button>
    </div>
  </div>

<script>
  /* SKINS (names restored) */
  const SKINS = {
    neon_grape:   { label:"Neon Grape",     bg:"#4c1d95", acc:"#2dd4bf", text:"#ffffff", tile:"#1e293b" },
    dark_academia:{ label:"Dark Academia",  bg:"#12100e", acc:"#d6ad60", text:"#f5efe6", tile:"#2a2420" },
    art_deco:     { label:"Art Deco",       bg:"#0b1220", acc:"#f5c542", text:"#f8fafc", tile:"#1f2937" },
    midnight_gold:{ label:"Midnight Gold",  bg:"#18181b", acc:"#facc15", text:"#f4f4f5", tile:"#27272a" },
    storm_slate:  { label:"Storm Slate",    bg:"#0f172a", acc:"#38bdf8", text:"#e2e8f0", tile:"#1f2937" },
    miami_sunset: { label:"Miami Sunset",   bg:"#7c2d12", acc:"#fb7185", text:"#fff7ed", tile:"#451a03" },
    cryptid_forest:{label:"Cryptid Forest", bg:"#064e3b", acc:"#a7f3d0", text:"#ecfdf5", tile:"#052e16" },
    killer_carnival:{label:"Killer Carnival",bg:"#3b0764",acc:"#f472b6", text:"#fae8ff", tile:"#1f0933" },
    blue_ice:     { label:"Blue Ice",       bg:"#0c4a6e", acc:"#a5f3fc", text:"#ecfeff", tile:"#083344" },
    lava_lamp:    { label:"Lava Lamp",      bg:"#7f1d1d", acc:"#fdba74", text:"#fff7ed", tile:"#3f0b0b" },
    old_paper:    { label:"Old Paper",      bg:"#1c1917", acc:"#fbbf24", text:"#fef3c7", tile:"#292524" },
    mono_punch:   { label:"Mono Punch",     bg:"#111827", acc:"#ffffff", text:"#ffffff", tile:"#374151" }
  };

  let mySkinKey = localStorage.getItem("reveal_skin") || "neon_grape";

  function applySkin(k){
    const s = SKINS[k] || SKINS.neon_grape;
    const r = document.documentElement.style;
    r.setProperty("--bg-color", s.bg);
    r.setProperty("--accent", s.acc);
    r.setProperty("--text-main", s.text);
    r.setProperty("--tile-off", s.tile);
  }

  function setMySkin(k){
    mySkinKey = k;
    localStorage.setItem("reveal_skin", mySkinKey);
    applySkin(mySkinKey);

    const ids = ["host-style","join-style","style-in-game"];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.value = mySkinKey;
    });
  }

  function populateSkinSelect(id){
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = "";
    Object.entries(SKINS).forEach(([k,v])=>{
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = v.label;
      sel.appendChild(opt);
    });
    sel.value = mySkinKey;
  }

  /* GLOBAL STATE */
  let myName = "";
  let roomCode = "";
  let isHost = false;
  let client = null;
  let gameImg = null;

  let gameState = {
    host:"",
    cat:"",
    ans:"",
    players:[],
    activeIdx:0,
    roundStartIdx:0,
    phase:"CALL",
    pendingGuess:null,
    guesses:[],
    revealed:[],
    status:"WAITING",
    winner:"",
    winGuess:""
  };

  const BROKER = "wss://broker.emqx.io:8084/mqtt";
  const TOPIC_PRE = "reveal_v4_8_1";

  /* NAV */
  function goTo(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
  }
  function showHostSetup(){ goTo("screen-host-setup"); }
  function showJoinSetup(){ goTo("screen-join-code"); }

  /* IMAGE */
  function processImage(){
    const file = document.getElementById("img-upload").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = ()=>{
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");
        const s = Math.min(img.width, img.height);
        c.width = 700; c.height = 700;
        ctx.drawImage(img, (img.width - s)/2, (img.height - s)/2, s, s, 0, 0, 700, 700);
        gameImg = c.toDataURL("image/jpeg", 0.75);
        document.getElementById("btn-create").disabled = false;
      };
    };
    reader.readAsDataURL(file);
  }

  /* MQTT */
  function connectMQTT(){
    if (client) return;
    client = mqtt.connect(BROKER);
    client.on("connect", ()=>{
      client.subscribe(`${TOPIC_PRE}/${roomCode}`);
      if (!isHost){
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"REQ_STATE"}));
      }
    });
    client.on("message", handleMsg);
  }

  /* GAME CREATE / JOIN */
  function createGame(){
    myName = (document.getElementById("host-name").value || "").trim() || "Host";
    gameState.host = myName;
    gameState.cat  = (document.getElementById("game-cat").value || "").trim();
    gameState.ans  = (document.getElementById("game-ans").value || "").trim();

    gameState.players = [];
    gameState.activeIdx = 0;
    gameState.roundStartIdx = 0;
    gameState.phase = "CALL";
    gameState.pendingGuess = null;
    gameState.guesses = [];
    gameState.revealed = [];
    gameState.status = "WAITING";
    gameState.winner = "";
    gameState.winGuess = "";

    roomCode = Math.random().toString(36).slice(2,6).toUpperCase();
    isHost = true;

    connectMQTT();
    startGame();
    sendState();

    setInterval(()=>{
      if (client && client.connected && isHost) sendState();
    }, 2000);
  }

  function searchRoom(){
    const code = (document.getElementById("join-code").value || "").trim().toUpperCase();
    if (code.length !== 4) { alert("Enter 4-letter code."); return; }
    roomCode = code;
    isHost = false;
    document.getElementById("btn-search").textContent = "SEARCHING...";
    connectMQTT();
  }

  function enterGame(){
    myName = (document.getElementById("join-name").value || "").trim();
    if (!myName) return;
    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"JOIN", name: myName}));
    }
    startGame();
  }

  /* TURN HELPERS */
  function playersCount(){ return (gameState.players || []).length; }
  function clampIdx(i){ return Math.max(0, Math.min(i, playersCount()-1)); }
  function getActivePlayerName(){
    const ps = gameState.players || [];
    if (!ps.length) return "";
    const idx = clampIdx(gameState.activeIdx || 0);
    return ps[idx]?.name || "";
  }
  function isActivePlayer(name){
    return !!name && name === getActivePlayerName();
  }
  function advanceTurn(){
    const ps = gameState.players || [];
    if (!ps.length) { gameState.activeIdx = 0; return; }
    gameState.activeIdx = ((gameState.activeIdx || 0) + 1) % ps.length;
  }
  function endTurnCycleIfComplete(){
    if (!playersCount()) return;
    if ((gameState.activeIdx || 0) === (gameState.roundStartIdx || 0)){
      gameState.phase = "CALL";
      gameState.pendingGuess = null;
    }
  }

  /* START GAME */
  function startGame(){
    goTo("screen-game");

    document.getElementById("inf-code").textContent = roomCode;
    document.getElementById("me-pill").textContent = `ME: ${myName || "?"}`;

    const mg = document.getElementById("mini-grid");
    mg.innerHTML = "";
    for (let i=1;i<=25;i++){
      const d = document.createElement("div");
      d.className = "trk-cell";
      d.id = "trk-" + i;
      d.textContent = i;
      mg.appendChild(d);
    }

    const grid = document.getElementById("tile-grid");
    grid.innerHTML = "";
    let nums = Array.from({length:25}, (_,i)=>i+1);
    for (let i=nums.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [nums[i], nums[j]] = [nums[j], nums[i]];
    }
    nums.forEach(n=>{
      const t = document.createElement("div");
      t.className = "tile";
      t.textContent = n;
      t.dataset.n = n;
      t.onclick = ()=>{
        const num = parseInt(t.dataset.n,10);
        if ((gameState.revealed || []).includes(num)){
          t.classList.add("revealed");
        } else {
          alert("That number hasn't been called yet.");
        }
      };
      grid.appendChild(t);
    });

    if (gameImg) document.getElementById("target-img").src = gameImg;

    updateUI();
  }

  /* MESSAGES */
  function handleMsg(topic, m){
    const msg = JSON.parse(m.toString());

    if (msg.type === "STATE"){
      gameState = msg.state || gameState;
      if (msg.img) gameImg = msg.img;

      if (document.getElementById("screen-join-code").classList.contains("active")){
        document.getElementById("join-room-disp").textContent = "ROOM: " + roomCode;
        document.getElementById("join-host-disp").textContent = "HOST: " + (gameState.host || "...");
        document.getElementById("btn-enter").disabled = false;
        document.getElementById("btn-search").textContent = "NEXT";
        goTo("screen-join-setup");
      }

      if (gameImg) document.getElementById("target-img").src = gameImg;

      updateUI();
      return;
    }

    if (msg.type === "REQ_STATE" && isHost){
      sendState();
      return;
    }

    if (msg.type === "JOIN" && isHost){
      const n = (msg.name || "").trim();
      if (!n) return;

      if (!(gameState.players || []).some(p=>p.name === n)){
        gameState.players.push({name:n});
        gameState.activeIdx = clampIdx(gameState.activeIdx || 0);
        gameState.roundStartIdx = clampIdx(gameState.roundStartIdx || 0);
        sendState();
      }
      return;
    }

    if (msg.type === "PASS" && isHost){
      if (gameState.phase !== "TURNS") return;
      if (!isActivePlayer(msg.from)) return;
      if (gameState.status === "WIN") return;

      advanceTurn();
      endTurnCycleIfComplete();
      if (gameState.phase !== "CALL") gameState.phase = "TURNS";

      sendState();
      return;
    }

    if (msg.type === "GUESS" && isHost){
      if (gameState.phase !== "TURNS") return;
      if (!isActivePlayer(msg.from)) return;
      if (gameState.status === "WIN") return;

      gameState.pendingGuess = {from: msg.from, txt: msg.txt};
      gameState.phase = "ADJUDICATE";
      sendState();
      return;
    }

    if (msg.type === "SKIP" && isHost){
      if (gameState.status === "WIN") return;
      const who = msg.who;

      if (gameState.phase === "ADJUDICATE") return;
      if (gameState.phase !== "TURNS") return;

      if (who === getActivePlayerName()){
        advanceTurn();
        endTurnCycleIfComplete();
        if (gameState.phase !== "CALL") gameState.phase = "TURNS";
        sendState();
      }
      return;
    }
  }

  /* HOST CALL */
  function hostCall(){
    if (!isHost) return;
    if (gameState.status === "WIN") return;
    if (gameState.phase !== "CALL") return;
    if (!playersCount()) return;

    const avail = [];
    for (let i=1;i<=25;i++){
      if (!(gameState.revealed || []).includes(i)) avail.push(i);
    }
    if (!avail.length) return;

    const pick = avail[Math.floor(Math.random()*avail.length)];
    gameState.revealed.push(pick);

    gameState.phase = "TURNS";
    gameState.roundStartIdx = clampIdx(gameState.activeIdx || 0);
    gameState.pendingGuess = null;

    sendState();
    updateUI();
  }

  /* HOST JUDGE */
  function hostJudge(isRight){
    if (!isHost) return;
    if (gameState.phase !== "ADJUDICATE") return;
    if (!gameState.pendingGuess) return;

    const pg = gameState.pendingGuess;

    if (isRight){
      gameState.status = "WIN";
      gameState.phase  = "WIN";
      gameState.winner = pg.from;
      gameState.winGuess = pg.txt;

      gameState.revealed = Array.from({length:25}, (_,i)=>i+1);

      gameState.pendingGuess = null;

      sendState();
      updateUI();
      showWin(pg.from, pg.txt);
      return;
    }

    gameState.guesses.push({from: pg.from, txt: pg.txt});
    gameState.pendingGuess = null;

    advanceTurn();
    endTurnCycleIfComplete();
    if (gameState.phase !== "CALL") gameState.phase = "TURNS";

    sendState();
    updateUI();
  }

  /* HOST SKIP */
  function hostSkip(name){
    if (!isHost) return;
    if (gameState.phase !== "TURNS") return;
    if (gameState.status === "WIN") return;
    if (!name) return;

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"SKIP", who:name}));
    }
  }

  /* PLAYER CONTROLS */
  function openGuess(){
    if (isHost) return;
    if (gameState.phase !== "TURNS") return;
    if (!isActivePlayer(myName)) return;
    if (gameState.status === "WIN") return;

    document.getElementById("row-guess-idle").style.display = "none";
    document.getElementById("row-guess-input").style.display = "flex";
    document.getElementById("guess-field").focus();
  }
  function closeGuessUI(){
    document.getElementById("row-guess-input").style.display = "none";
    document.getElementById("row-guess-idle").style.display = "flex";
    const gf = document.getElementById("guess-field");
    gf.value = "";
  }

  function passTurn(){
    if (isHost) return;
    if (gameState.phase !== "TURNS") return;
    if (!isActivePlayer(myName)) return;
    if (gameState.status === "WIN") return;

    closeGuessUI();

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"PASS", from: myName}));
    }
  }

  function sendGuess(){
    if (isHost) return;
    if (gameState.phase !== "TURNS") return;
    if (!isActivePlayer(myName)) return;
    if (gameState.status === "WIN") return;

    const gf = document.getElementById("guess-field");
    const g = (gf.value || "").trim();
    if (!g) return;

    closeGuessUI();

    if (client && client.connected){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"GUESS", from: myName, txt: g}));
    }
  }

  /* STATE BROADCAST */
  function sendState(){
    if (client && client.connected && isHost){
      client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({type:"STATE", state: gameState, img: gameImg}));
    }
  }

  /* UI */
  function updateUI(){
    document.getElementById("inf-host").textContent = gameState.host || "?";
    document.getElementById("inf-cat").textContent  = gameState.cat  || "?";
    document.getElementById("inf-phase").textContent = (gameState.phase || "?").toUpperCase();

    const st = document.getElementById("inf-status");

    if (gameState.status === "WIN" || gameState.phase === "WIN"){
      st.textContent = `${gameState.winner || "???"} wins!`;
    } else if (gameState.phase === "ADJUDICATE" && gameState.pendingGuess){
      const g = (gameState.pendingGuess.txt || "").trim();
      st.textContent = `"${g || "?"}" is being judged`;
    } else if (gameState.phase === "TURNS"){
      const ap = getActivePlayerName();
      st.textContent = ap ? `Turn: ${ap}` : "Turn: ?";
    } else {
      st.textContent = "WAITING";
    }

    let last = 0;
    (gameState.revealed || []).forEach(n=>{
      const el = document.getElementById("trk-" + n);
      if (el) el.classList.add("active");
      last = n;
    });
    document.getElementById("current-call-text").textContent = (last || "--");

    const pl = document.getElementById("list-players");
    if (pl){
      pl.innerHTML = "";
      const ap = getActivePlayerName();
      (gameState.players || []).forEach(p=>{
        const row = document.createElement("div");
        row.className = "sb-item" + (p.name === ap ? " active-turn" : "");
        const left = document.createElement("div");
        left.textContent = p.name;
        row.appendChild(left);

        if (isHost){
          const acts = document.createElement("div");
          acts.className = "sb-actions";
          const btn = document.createElement("button");
          btn.className = "mini-btn danger";
          btn.textContent = "SKIP";
          btn.disabled = !(gameState.phase === "TURNS" && p.name === ap && gameState.status !== "WIN");
          btn.onclick = ()=>hostSkip(p.name);
          acts.appendChild(btn);
          row.appendChild(acts);
        }
        pl.appendChild(row);
      });
    }

    const lg = document.getElementById("list-guesses");
    if (lg){
      lg.innerHTML = "";
      (gameState.guesses || []).forEach(g=>{
        const d = document.createElement("div");
        d.className = "sb-item";
        d.textContent = `${g.from}: "${g.txt}"`;
        lg.appendChild(d);
      });
    }

    const myTurn = (!isHost)
      && (gameState.phase === "TURNS")
      && isActivePlayer(myName)
      && (gameState.status !== "WIN");

    if (!myTurn) closeGuessUI();

    document.getElementById("host-row-adj").style.display  = isHost ? "flex" : "none";
    document.getElementById("host-row-adj2").style.display = isHost ? "flex" : "none";
    document.getElementById("btn-host-call").style.display = isHost ? "block" : "none";

    document.getElementById("player-row-pass").style.display = isHost ? "none" : "flex";
    document.getElementById("row-guess-idle").style.display  = isHost ? "none" : (document.getElementById("row-guess-input").style.display === "flex" ? "none" : "flex");

    const btnPass = document.getElementById("btn-pass");
    const btnGuess = document.getElementById("btn-guess");
    const btnSend = document.getElementById("btn-send");
    if (btnPass) btnPass.disabled = !myTurn;
    if (btnGuess) btnGuess.disabled = !myTurn;
    if (btnSend) btnSend.disabled = !myTurn;

    const pending = !!gameState.pendingGuess && (gameState.phase === "ADJUDICATE") && (gameState.status !== "WIN");
    document.getElementById("btn-right").disabled = !pending;
    document.getElementById("btn-wrong").disabled = !pending;

    const canCall = isHost && (gameState.phase === "CALL") && (gameState.status !== "WIN") && playersCount() > 0;
    document.getElementById("btn-host-call").disabled = !canCall;

    if ((gameState.status === "WIN" || gameState.phase === "WIN") && gameState.winner){
      showWin(gameState.winner, gameState.winGuess || "");
    }
  }

  /* WIN OVERLAY */
  function showWin(name, guess){
    const ov = document.getElementById("win-overlay");
    document.getElementById("win-title").textContent = `${name} wins!`;
    document.getElementById("win-sub").textContent = `They Guessed: ${guess || "(unknown)"}`;
    if (gameImg) document.getElementById("win-img").src = gameImg;
    ov.style.display = "flex";
  }
  function hideWin(){
    document.getElementById("win-overlay").style.display = "none";
  }

  /* UTIL */
  function copyCode(){
    if (!roomCode) return;
    navigator.clipboard.writeText(roomCode);
    showToast("Room code copied: " + roomCode, 1500);
  }
  function showToast(txt, ms=2000){
    const t = document.getElementById("toast");
    t.textContent = txt;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), ms);
  }

  /* INIT */
  (function init(){
    populateSkinSelect("host-style");
    populateSkinSelect("join-style");
    populateSkinSelect("style-in-game");
    setMySkin(mySkinKey);
  })();
</script>
</body>
</html>
