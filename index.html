<!DOCTYPE html>
<html lang="en">
<!-- 
    IMAGE REVEAL BEANO v2.1
    - FIX: "Call #" button now updates Host screen immediately.
    - FIX: Joiner can now select Color Theme properly.
    - FIX: "Loading Host..." is faster (Host broadcasts state every 1s).
    - FEATURE: 10 Color Schemes (Art Deco, Noir, Academia, etc).
    - LOGIC: Grid numbers are shuffled per player (1-25 randomized).
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REVEAL! v2.1</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #4c1d95; /* Vibrant (Default) */
            --accent: #2dd4bf;
            --text-color: #ffffff;
            --tile-color: #1e293b;
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh; display: flex; flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        .screen.active { transform: translateX(0); }
        .center-content { align-items: center; justify-content: center; }

        h1 { font-family: var(--font-head); font-size: 3rem; margin: 0; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        .subtitle { opacity: 0.8; font-weight: 900; margin-bottom: 20px; letter-spacing: 1px; }

        .card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; width: 100%; max-width: 400px;
            border: 2px solid rgba(255,255,255,0.2); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* CONTROLS */
        .control-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: 900; margin-bottom: 5px; font-size: 0.8rem; text-transform: uppercase; color: rgba(255,255,255,0.8); }
        input, select {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            font-family: var(--font-body); font-weight: 800; font-size: 1.1rem;
            background: rgba(255,255,255,0.95); color: #111; outline: none;
        }
        .code-input { font-family: 'Courier New', monospace; letter-spacing: 5px; text-align: center; text-transform: uppercase; font-weight: 900; font-size: 1.5rem; }

        .big-btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-family: var(--font-head); font-size: 1.4rem; cursor: pointer;
            background: var(--accent); color: #000;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s; margin-top: 10px;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
        .big-btn:disabled { background: #94a3b8; color: #666; cursor: default; box-shadow: none; }

        /* --- GAME LAYOUT --- */
        #game-layout { display: flex; flex: 1; width: 100%; overflow: hidden; position: relative; }
        
        #jumbotron {
            height: 60px; width: 100%; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #host-badge { font-weight: 900; text-transform: uppercase; }
        #cat-badge { background: var(--accent); color: black; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 900; }
        #room-badge { 
            font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.2rem; 
            cursor: pointer; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px;
        }

        /* COLUMNS */
        .side-col {
            flex: 1; padding: 10px; display: flex; flex-direction: column;
            background: rgba(0,0,0,0.1); overflow-y: auto; max-width: 250px;
        }
        #center-col {
            flex: 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; padding: 20px;
        }

        /* LIST ITEMS */
        .list-header { font-family: var(--font-head); text-transform: uppercase; opacity: 0.5; margin-bottom: 10px; text-align: center; }
        .guess-item { background: rgba(255,0,0,0.2); padding: 5px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; }
        .player-item {
            background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;
            margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; text-align: center;
            border: 2px solid transparent;
        }
        .player-item.active-turn { border-color: var(--accent); background: rgba(255,255,255,0.2); }

        /* THE BOARD */
        #game-board-container {
            width: 90vmin; height: 90vmin;
            max-width: 500px; max-height: 500px;
            position: relative;
            background: #000;
            border: 5px solid white; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        #target-image { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; z-index: 1; }
        #grid-overlay {
            position: absolute; inset: 0; z-index: 2;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 1px;
        }
        .tile {
            background: var(--tile-color);
            color: rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-head); font-size: 1.8rem;
            cursor: pointer; user-select: none;
            transition: opacity 0.3s;
        }
        .tile.revealed { opacity: 0; pointer-events: none; }

        /* TILE 23 Special Styling */
        .tile.is-23 { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; }

        /* FOOTER & CHAT */
        #action-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; display: flex; gap: 10px; z-index: 100;
        }
        #btn-chat {
            position: absolute; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: white; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 200;
        }
        #btn-chat.shake { animation: shake 0.5s infinite; background: #fbbf24; }
        
        #chat-drawer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 50vh;
            background: white; color: #333; z-index: 2000;
            transform: translateY(110%); transition: transform 0.3s;
            display: flex; flex-direction: column; border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 100px rgba(0,0,0,0.5);
        }
        #chat-drawer.open { transform: translateY(0); }

        @media (max-width: 700px) {
            .side-col { display: none; } 
            #jumbotron { padding: 0 10px; }
            #host-badge { font-size: 0.9rem; }
        }
        
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

    </style>
</head>
<body>

    <!-- 1. START -->
    <div id="screen-start" class="screen active center-content">
        <h1>REVEAL!</h1>
        <div class="subtitle">VERSION 2.1</div>
        <div style="display:flex; flex-direction:column; gap:15px; width:100%; max-width:300px;">
            <button class="big-btn" onclick="goToHost()">HOST A GAME</button>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7;">Create a room & upload a pic</div>
            <button class="big-btn secondary" onclick="goToJoin()">JOIN A GAME</button>
            <div style="text-align:center; font-size:0.8rem; opacity:0.7;">Enter a code</div>
        </div>
    </div>

    <!-- 2. HOST SETUP -->
    <div id="screen-host" class="screen center-content">
        <h2>GAME SETUP</h2>
        <div class="card">
            <div class="control-group">
                <label>Your Name</label>
                <input type="text" id="host-name" placeholder="HOST NAME">
            </div>
            <div class="control-group">
                <label>Category (e.g. 80s Movies)</label>
                <input type="text" id="game-cat" placeholder="CATEGORY">
            </div>
            <div class="control-group">
                <label>Answer (Hidden)</label>
                <input type="text" id="game-ans" placeholder="THE SECRET">
            </div>
            <div class="control-group">
                <label>Image (Square)</label>
                <input type="file" id="img-upload" accept="image/*" onchange="processImage()">
                <div id="img-preview-box" style="width:100px; height:100px; margin:10px auto; display:none; border:2px solid white; border-radius:10px; overflow:hidden;">
                    <img id="img-preview" style="width:100%; height:100%; object-fit:cover;">
                </div>
            </div>
            <div class="control-group">
                <label>Theme</label>
                <select id="host-skin" onchange="applySkin(this.value)"></select>
            </div>
            <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
        </div>
        <button onclick="goTo('screen-start')" style="margin-top:20px; background:none; border:none; color:white; font-weight:bold;">&larr; BACK</button>
    </div>

    <!-- 3. JOIN CODE -->
    <div id="screen-join-code" class="screen center-content">
        <h2>ENTER CODE</h2>
        <div class="card">
            <input type="text" id="join-code-input" class="code-input" maxlength="4" placeholder="ABCD">
            <button class="big-btn" onclick="verifyCode()">NEXT</button>
        </div>
        <button onclick="goTo('screen-start')" style="margin-top:20px; background:none; border:none; color:white; font-weight:bold;">&larr; BACK</button>
    </div>

    <!-- 4. JOIN SETUP -->
    <div id="screen-join-setup" class="screen center-content">
        <h2 id="join-room-title">ROOM: ????</h2>
        <div style="margin-bottom:15px; font-weight:bold; color:var(--accent); animation: pulse 1s infinite;" id="join-host-display">Loading Host...</div>
        <div class="card">
            <div class="control-group">
                <label>Your Name</label>
                <input type="text" id="join-name" placeholder="YOUR NAME">
            </div>
            <div class="control-group">
                <label>Color Theme</label>
                <select id="join-skin" onchange="applySkin(this.value)"></select>
            </div>
            <button class="big-btn" onclick="joinGame()">ENTER</button>
        </div>
    </div>

    <!-- 5. GAME BOARD -->
    <div id="screen-game" class="screen" style="padding:0;">
        <div id="jumbotron">
            <span id="cat-badge">WAITING...</span>
            <span id="host-badge">HOST: ???</span>
            <span id="room-badge" onclick="copyCode()">CODE</span>
        </div>

        <div id="game-layout">
            <div class="side-col" id="col-guesses">
                <div class="list-header">GUESSES</div>
                <div id="list-guesses"></div>
            </div>

            <div id="center-col">
                <div id="game-board-container">
                    <img id="target-image" src="">
                    <div id="grid-overlay"></div>
                </div>
            </div>

            <div class="side-col" id="col-players">
                <div class="list-header">PLAYERS</div>
                <div id="list-players"></div>
            </div>
        </div>

        <div id="action-bar"></div>
        <button id="btn-chat" onclick="toggleChat()">ðŸ’¬</button>

        <div id="chat-drawer">
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <strong>CHAT</strong>
                <button onclick="toggleChat()" style="border:none; bg:none;">X</button>
            </div>
            <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:10px;"></div>
            <div style="padding:10px; display:flex;">
                <input id="chat-txt" type="text" placeholder="Message..." style="border:2px solid #ccc;">
                <button onclick="sendChat()" style="margin-left:5px; background:var(--accent); border:none; padding:0 15px; border-radius:8px;">&rarr;</button>
            </div>
        </div>
    </div>

<script>
    // --- 10 SKINS ---
    const SKINS = {
        vibrant:   { n: "Vibrant",    bg: '#4c1d95', acc: '#2dd4bf', text: '#fff', tile: '#1e293b' },
        artdeco:   { n: "Art Deco",   bg: '#121212', acc: '#d4af37', text: '#e0e0e0', tile: '#1f1f1f' },
        academia:  { n: "Academia",   bg: '#2b2118', acc: '#8b9d83', text: '#eaddcf', tile: '#3e3226' },
        noir:      { n: "Noir",       bg: '#000000', acc: '#ffffff', text: '#cccccc', tile: '#333333' },
        cotton:    { n: "Cotton",     bg: '#fbcfe8', acc: '#38bdf8', text: '#333333', tile: '#ffffff' },
        matrix:    { n: "Matrix",     bg: '#000000', acc: '#00ff00', text: '#00ff00', tile: '#111111' },
        blueprint: { n: "Blueprint",  bg: '#1e3a8a', acc: '#ffffff', text: '#ffffff', tile: '#3b82f6' },
        sunset:    { n: "Sunset",     bg: '#7c2d12', acc: '#f59e0b', text: '#fff7ed', tile: '#431407' },
        dracula:   { n: "Dracula",    bg: '#282a36', acc: '#ff79c6', text: '#f8f8f2', tile: '#44475a' },
        forest:    { n: "Forest",     bg: '#064e3b', acc: '#a7f3d0', text: '#ecfdf5', tile: '#065f46' }
    };

    // Populate Dropdowns
    const skinOpts = Object.keys(SKINS).map(k => `<option value="${k}">${SKINS[k].n}</option>`).join('');
    document.getElementById('host-skin').innerHTML = skinOpts;
    document.getElementById('join-skin').innerHTML = skinOpts;

    function applySkin(key) {
        const s = SKINS[key] || SKINS.vibrant;
        const r = document.documentElement.style;
        r.setProperty('--bg-color', s.bg);
        r.setProperty('--accent', s.acc);
        r.setProperty('--text-color', s.text);
        r.setProperty('--tile-color', s.tile);
    }

    // --- STATE ---
    let myName, roomCode, isHost;
    let client, gameImg = null; 
    let gameState = { 
        hostName: "", players: [], guesses: [], 
        revealed: [], turnOrder: [], currentTurnIdx: 0, status: 'WAITING' 
    };
    
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_PRE = 'reveal_v21';

    // --- NAVIGATION ---
    function goTo(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goToHost() { goTo('screen-host'); }
    function goToJoin() { goTo('screen-join-code'); }

    // --- HOST LOGIC ---
    function processImage() {
        const file = document.getElementById('img-upload').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const s = Math.min(img.width, img.height);
                canvas.width = 600; canvas.height = 600;
                ctx.drawImage(img, (img.width-s)/2, (img.height-s)/2, s, s, 0, 0, 600, 600);
                gameImg = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('img-preview').src = gameImg;
                document.getElementById('img-preview').parentElement.style.display='block';
                checkHostReady();
            };
        };
        reader.readAsDataURL(file);
    }

    function checkHostReady() {
        const n=document.getElementById('host-name').value, c=document.getElementById('game-cat').value, a=document.getElementById('game-ans').value;
        document.getElementById('btn-create').disabled = !(n && c && a && gameImg);
    }
    ['host-name','game-cat','game-ans'].forEach(id=>document.getElementById(id).addEventListener('keyup', checkHostReady));

    function createGame() {
        myName = document.getElementById('host-name').value;
        gameState.hostName = myName;
        roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        isHost = true;
        gameState.players.push({name: myName, score: 0});
        setupGameUI();
        connectMQTT();
        startHostLoop();
    }

    function startHostLoop() {
        // Broadcast State Loop (Every 1s to help Joiners)
        setInterval(() => {
            const pl = { type: 'STATE', state: gameState, img: gameImg, cat: document.getElementById('game-cat').value.toUpperCase() };
            client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl));
        }, 1000);
    }

    // --- JOIN LOGIC ---
    function verifyCode() {
        const c = document.getElementById('join-code-input').value.trim().toUpperCase();
        if(c.length !== 4) return alert("Code must be 4 letters");
        roomCode = c;
        goTo('screen-join-setup');
        document.getElementById('join-room-title').innerText = "ROOM: " + c;
        // Connect early to listen for Host Name
        isHost = false;
        connectMQTT();
    }

    function joinGame() {
        myName = document.getElementById('join-name').value;
        if(!myName) return alert("Enter a name.");
        send({ type: 'JOIN', name: myName });
        setupGameUI();
    }

    // --- UI & GRID ---
    function setupGameUI() {
        goTo('screen-game');
        document.getElementById('room-badge').innerText = roomCode;
        if(isHost) {
            document.getElementById('target-image').src = gameImg;
            document.getElementById('cat-badge').innerText = document.getElementById('game-cat').value;
            document.getElementById('host-badge').innerText = "HOST: " + myName;
            updateActionBar();
        }
        buildGrid();
    }
    
    function buildGrid() {
        const grid = document.getElementById('grid-overlay');
        grid.innerHTML = '';
        
        // 1. Create Array 1-25
        let numbers = Array.from({length: 25}, (_, i) => i + 1);
        
        // 2. SHUFFLE THE ARRAY (Fisher-Yates)
        for (let i = numbers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
        }
        
        // 3. Build Tiles
        numbers.forEach(n => {
            let t = document.createElement('div');
            t.className = 'tile';
            if(n === 23) t.classList.add('is-23'); // Special class for #23
            t.dataset.n = n;
            t.innerText = n;
            // Joiners can only click if server says revealed, Host can manual click to test
            t.onclick = () => { if(isHost) { 
                gameState.revealed.push(n); 
                send({ type:'STATE', state:gameState });
                renderState();
            }};
            grid.appendChild(t);
        });
    }

    function updateActionBar() {
        const bar = document.getElementById('action-bar');
        bar.innerHTML = '';
        if(isHost) {
            bar.innerHTML = `<button class="big-btn" onclick="hostCallNumber()">CALL NUMBER</button>`;
        } else {
            bar.innerHTML = `<button class="big-btn" onclick="alert('Wait for your turn!')">I KNOW IT!</button>`;
        }
    }

    // --- GAME ACTIONS ---
    function hostCallNumber() {
        // Pick random uncalled
        let available = [];
        for(let i=1; i<=25; i++) if(!gameState.revealed.includes(i)) available.push(i);
        
        if(available.length > 0) {
            let pick = available[Math.floor(Math.random() * available.length)];
            gameState.revealed.push(pick);
            
            // LOCAL RENDER IMMEDIATELY
            renderState(); 
            
            // NETWORK SYNC
            send({ type: 'STATE', state: gameState });
        }
    }

    function renderState() {
        // 1. Info
        document.getElementById('host-badge').innerText = "HOST: " + gameState.hostName;
        if(gameState.category) document.getElementById('cat-badge').innerText = gameState.category;
        
        // 2. Reveal Tiles
        document.querySelectorAll('.tile').forEach(t => {
            let n = parseInt(t.dataset.n);
            if(gameState.revealed.includes(n)) t.classList.add('revealed');
        });

        // 3. Players
        const pList = document.getElementById('list-players');
        pList.innerHTML = '';
        gameState.players.forEach(p => {
            let div = document.createElement('div');
            div.className = 'player-item';
            div.innerText = p.name;
            pList.appendChild(div);
        });
    }

    // --- NETWORK ---
    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const t = `${TOPIC_PRE}/${roomCode}`;
        
        client.on('connect', () => {
            client.subscribe(t);
        });

        client.on('message', (tpc, m) => {
            const msg = JSON.parse(m.toString());
            
            if(msg.type === 'STATE') {
                gameState = msg.state;
                if(!isHost && msg.img) {
                    document.getElementById('target-image').src = msg.img;
                    document.getElementById('display-cat') ? document.getElementById('display-cat').innerText = msg.cat : null;
                }
                
                // HOST NAME LOADER
                if(document.getElementById('screen-join-setup').classList.contains('active')) {
                    if(gameState.hostName) {
                        document.getElementById('join-host-display').innerText = "HOST: " + gameState.hostName;
                        document.getElementById('join-host-display').style.animation = 'none';
                    }
                }
                
                renderState();
            }
            
            if(msg.type === 'JOIN' && isHost) {
                if(!gameState.players.find(p=>p.name===msg.name)) {
                    gameState.players.push({name:msg.name});
                }
            }
            
            if(msg.type === 'CHAT') {
                const box = document.getElementById('chat-msgs');
                box.innerHTML += `<div class="msg"><b>${msg.from}:</b> ${msg.txt}</div>`;
                if(!document.getElementById('chat-drawer').classList.contains('open')) {
                    document.getElementById('btn-chat').classList.add('shake');
                }
            }
        });
    }

    function send(pl) { client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify(pl)); }

    // --- UTILS ---
    function copyCode() { navigator.clipboard.writeText(roomCode); alert("Copied!"); }
    function toggleChat() { 
        document.getElementById('chat-drawer').classList.toggle('open'); 
        document.getElementById('btn-chat').classList.remove('shake');
    }
    function sendChat() {
        let txt = document.getElementById('chat-txt').value;
        if(txt) { send({type:'CHAT', from:myName, txt:txt}); document.getElementById('chat-txt').value = ''; }
    }

</script>
</body>
</html>
