<!DOCTYPE html>
<html lang="en">
<!-- 
    IMAGE REVEAL BEANO v20.1
    - VISUAL: New Fonts (Fredoka/Nunito), New Themes (Art Deco, Dark Academia, etc).
    - ENGINE: Canvas Image Cropper (1:1 Aspect Ratio force).
    - FLOW: Host vs Join Split.
    - NETWORK: Chat system integrated.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REVEAL! v20.1</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #4c1d95; /* Default: Vivid Purple */
            --accent: #2dd4bf;    /* Default: Teal */
            --text-color: #ffffff;
            --tile-bg: #1e293b;
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            overflow: hidden; /* App-like feel */
            height: 100vh; display: flex; flex-direction: column;
            transition: background 0.5s ease;
        }

        /* --- COMMON UI --- */
        .screen {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
            transform: translateX(100%); transition: transform 0.3s ease;
        }
        .screen.active { transform: translateX(0); }

        h1 { font-family: var(--font-head); font-size: 3rem; margin: 20px 0 5px 0; text-shadow: 2px 2px 0 rgba(0,0,0,0.3); text-align: center; }
        .subtitle { opacity: 0.8; font-weight: bold; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }

        .card {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; width: 100%; max-width: 400px;
            border: 2px solid rgba(255,255,255,0.2); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* INPUTS & BUTTONS */
        .control-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; }
        input, select {
            width: 100%; padding: 12px; border-radius: 12px; border: none;
            font-family: var(--font-body); font-weight: bold; font-size: 1.1rem;
            background: rgba(255,255,255,0.9); color: #333; outline: none;
        }
        /* Monospace for Codes to avoid 0/O confusion */
        .code-input { font-family: 'Courier New', monospace; letter-spacing: 5px; text-align: center; text-transform: uppercase; }

        .big-btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            font-family: var(--font-head); font-size: 1.4rem; cursor: pointer;
            background: var(--accent); color: #000;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s; margin-top: 10px;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn.secondary { background: rgba(255,255,255,0.2); color: white; }

        /* --- START SCREEN --- */
        #start-split { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 300px; }
        
        /* --- HOST SETUP --- */
        #img-preview-box {
            width: 150px; height: 150px; background: rgba(0,0,0,0.3);
            margin: 10px auto; border-radius: 10px; overflow: hidden;
            border: 2px dashed rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center;
        }
        #img-preview { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* --- GAME BOARD --- */
        #jumbotron {
            width: 100%; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2);
        }
        .cat-badge { background: var(--accent); color: black; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
        
        #stage-container {
            flex: 1; display: flex; align-items: center; justify-content: center; width: 100%;
        }
        #the-stage {
            width: 90vw; height: 90vw; max-width: 500px; max-height: 500px;
            position: relative; border-radius: 4px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 4px solid white;
        }
        #hidden-image { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
        #tile-grid {
            position: absolute; inset: 0; display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 1px; background: rgba(0,0,0,0.1);
        }
        .tile {
            background: var(--tile-color);
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-head); font-size: 1.5rem; color: rgba(255,255,255,0.5);
            cursor: pointer; transition: opacity 0.3s; user-select: none;
        }
        .tile.revealed { opacity: 0; pointer-events: none; }

        /* --- FOOTER & CHAT --- */
        #game-footer {
            padding: 15px; width: 100%; max-width: 600px; display: flex; gap: 10px;
            margin-bottom: 20px;
        }
        #btn-chat {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: white; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); flex-shrink: 0;
        }

        #chat-drawer {
            position: fixed; bottom: 0; left: 0; right: 0; height: 60vh;
            background: white; color: #333;
            border-radius: 20px 20px 0 0;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
        }
        #chat-drawer.open { transform: translateY(0); }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; }
        .msg { margin-bottom: 8px; font-size: 0.9rem; }
        .msg b { color: #4c1d95; }
        .msg.sys { color: #666; font-style: italic; text-align: center; font-size: 0.8rem; margin: 10px 0; }
        
        #chat-input-bar { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #chat-input { flex: 1; border: 2px solid #ddd; background: #fff; }

    </style>
</head>
<body>

    <!-- SCREEN 1: START -->
    <div id="screen-start" class="screen active" style="justify-content:center;">
        <h1>REVEAL!</h1>
        <div class="subtitle">v20.1 &bull; FOUNDATION</div>
        <div id="start-split">
            <button class="big-btn" onclick="goTo('screen-host')">HOST A GAME</button>
            <button class="big-btn secondary" onclick="goTo('screen-join-code')">JOIN A GAME</button>
        </div>
    </div>

    <!-- SCREEN 2: HOST SETUP -->
    <div id="screen-host" class="screen">
        <button onclick="goTo('screen-start')" style="align-self:flex-start; background:none; border:none; color:white; font-weight:bold;">&larr; BACK</button>
        <h2>SETUP</h2>
        <div class="card">
            <div class="control-group">
                <label>Host Name</label>
                <input type="text" id="host-name" placeholder="YOUR NAME">
            </div>
            <div class="control-group">
                <label>Category</label>
                <input type="text" id="game-cat" placeholder="E.G. 90s MOVIES">
            </div>
            <div class="control-group">
                <label>Secret Answer</label>
                <input type="text" id="game-ans" placeholder="E.G. JURASSIC PARK">
            </div>
            <div class="control-group">
                <label>Upload Image</label>
                <input type="file" id="img-upload" accept="image/*" onchange="processImage()">
                <div id="img-preview-box"><img id="img-preview"></div>
                <div style="font-size:0.7rem; margin-top:5px; opacity:0.7;">Auto-cropped to center square.</div>
            </div>
            <div class="control-group">
                <label>Color Theme</label>
                <select id="host-skin" onchange="applySkin(this.value)">
                    <option value="default">Vibrant (Purple/Teal)</option>
                    <option value="artdeco">Art Deco (Black/Gold)</option>
                    <option value="academia">Dark Academia (Brown/Sage)</option>
                    <option value="noir">Noir (Black/White)</option>
                    <option value="cotton">Cotton Candy (Pink/Blue)</option>
                </select>
            </div>
            <button class="big-btn" id="btn-create" disabled onclick="createGame()">CREATE ROOM</button>
        </div>
    </div>

    <!-- SCREEN 3: JOIN CODE -->
    <div id="screen-join-code" class="screen" style="justify-content:center;">
        <button onclick="goTo('screen-start')" style="position:absolute; top:20px; left:20px; background:none; border:none; color:white; font-weight:bold;">&larr; BACK</button>
        <h2>ENTER CODE</h2>
        <div class="card">
            <input type="text" id="join-code-input" class="code-input" maxlength="4" placeholder="ABCD">
            <button class="big-btn" onclick="verifyCode()">NEXT</button>
        </div>
    </div>

    <!-- SCREEN 4: JOIN SETUP -->
    <div id="screen-join-setup" class="screen">
        <h2>JOINING</h2>
        <div class="subtitle" id="join-room-display">ROOM: ????</div>
        <div class="card">
            <div class="control-group">
                <label>Your Name</label>
                <input type="text" id="join-name" placeholder="YOUR NAME">
            </div>
            <div class="control-group">
                <label>Color Theme</label>
                <select id="join-skin" onchange="applySkin(this.value)">
                    <option value="default">Vibrant (Purple/Teal)</option>
                    <option value="artdeco">Art Deco (Black/Gold)</option>
                    <option value="academia">Dark Academia (Brown/Sage)</option>
                    <option value="noir">Noir (Black/White)</option>
                    <option value="cotton">Cotton Candy (Pink/Blue)</option>
                </select>
            </div>
            <button class="big-btn" onclick="joinGame()">ENTER</button>
        </div>
    </div>

    <!-- SCREEN 5: GAME BOARD -->
    <div id="screen-game" class="screen" style="padding:0;">
        <div id="jumbotron">
            <span class="cat-badge" id="display-cat">LOADING...</span>
            <span style="font-family:var(--font-head); font-size:1.5rem;" id="display-code">CODE</span>
        </div>

        <div id="stage-container">
            <div id="the-stage">
                <img id="hidden-image" src="">
                <div id="grid-overlay">
                    <!-- Tiles injected here -->
                </div>
            </div>
        </div>

        <div id="game-footer">
            <button class="big-btn" style="flex:1;">I KNOW IT!</button>
            <button id="btn-chat" onclick="toggleChat()">ðŸ’¬</button>
        </div>

        <!-- CHAT DRAWER -->
        <div id="chat-drawer">
            <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <strong>CHAT</strong>
                <button onclick="toggleChat()" style="border:none; background:none; font-size:1.2rem;">âœ•</button>
            </div>
            <div id="chat-msgs"></div>
            <div id="chat-input-bar">
                <input type="text" id="chat-input" placeholder="Say something...">
                <button onclick="sendChat()" style="background:var(--bg-color); color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold;">SEND</button>
            </div>
        </div>
    </div>

<script>
    // --- SKINS ---
    const SKINS = {
        default: { bg: '#4c1d95', acc: '#2dd4bf', text: '#fff' },
        artdeco: { bg: '#101010', acc: '#D4AF37', text: '#f0f0f0' },
        academia: { bg: '#2C241B', acc: '#A09E86', text: '#f3f4f6' },
        noir: { bg: '#000000', acc: '#ffffff', text: '#ffffff' },
        cotton: { bg: '#FFC0CB', acc: '#40E0D0', text: '#333' }
    };

    function applySkin(key) {
        const s = SKINS[key];
        const r = document.documentElement.style;
        r.setProperty('--bg-color', s.bg);
        r.setProperty('--accent', s.acc);
        r.setProperty('--text-color', s.text);
    }

    // --- STATE ---
    let myName, roomCode, isHost;
    let client;
    let gameImg = null;
    const BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_PRE = 'reveal_v20_1';

    // --- NAVIGATION ---
    function goTo(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- HOST LOGIC ---
    function processImage() {
        const file = document.getElementById('img-upload').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                // FORCE SQUARE CROP
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = Math.min(img.width, img.height);
                const ox = (img.width - size) / 2;
                const oy = (img.height - size) / 2;
                
                canvas.width = 600; canvas.height = 600; // Standardize
                ctx.drawImage(img, ox, oy, size, size, 0, 0, 600, 600);
                
                gameImg = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('img-preview').src = gameImg;
                document.getElementById('img-preview').style.display = 'block';
                checkHostReady();
            };
        };
        reader.readAsDataURL(file);
    }

    function checkHostReady() {
        const n = document.getElementById('host-name').value;
        const c = document.getElementById('game-cat').value;
        const a = document.getElementById('game-ans').value;
        document.getElementById('btn-create').disabled = !(n && c && a && gameImg);
    }
    
    // Monitor inputs
    ['host-name','game-cat','game-ans'].forEach(id => {
        document.getElementById(id).addEventListener('keyup', checkHostReady);
    });

    function createGame() {
        myName = document.getElementById('host-name').value;
        roomCode = Math.random().toString(36).substr(2,4).toUpperCase();
        isHost = true;
        
        startGameUI(roomCode, document.getElementById('game-cat').value.toUpperCase());
        connectMQTT();
    }

    // --- JOIN LOGIC ---
    function verifyCode() {
        const c = document.getElementById('join-code-input').value.trim().toUpperCase();
        if(c.length !== 4) return alert("Code must be 4 letters.");
        roomCode = c;
        document.getElementById('join-room-display').innerText = "ROOM: " + c;
        goTo('screen-join-setup');
    }

    function joinGame() {
        myName = document.getElementById('join-name').value;
        if(!myName) return alert("Enter a name.");
        isHost = false;
        connectMQTT();
        goTo('screen-game');
    }

    // --- GAME UI ---
    function startGameUI(code, cat) {
        goTo('screen-game');
        document.getElementById('display-code').innerText = code;
        document.getElementById('display-cat').innerText = cat;
        if(gameImg) document.getElementById('hidden-image').src = gameImg;
        buildGrid();
    }

    function buildGrid() {
        const grid = document.getElementById('grid-overlay');
        grid.innerHTML = '';
        for(let i=1; i<=25; i++) {
            let t = document.createElement('div');
            t.className = 'tile';
            t.innerText = i;
            t.id = 'tile-'+i;
            
            // Temporary reveal logic for testing
            t.onclick = () => t.classList.add('revealed');
            
            grid.appendChild(t);
        }
    }

    // --- CHAT & MQTT ---
    function toggleChat() {
        document.getElementById('chat-drawer').classList.toggle('open');
    }

    function sendChat() {
        const txt = document.getElementById('chat-input').value;
        if(!txt) return;
        client.publish(`${TOPIC_PRE}/${roomCode}`, JSON.stringify({
            type: 'CHAT', from: myName, msg: txt
        }));
        document.getElementById('chat-input').value = '';
    }

    function connectMQTT() {
        client = mqtt.connect(BROKER);
        const t = `${TOPIC_PRE}/${roomCode}`;
        
        client.on('connect', () => {
            client.subscribe(t);
            // Announce
            client.publish(t, JSON.stringify({ type: 'SYS', msg: `${myName} joined.` }));
            
            if(isHost) {
                // Host broadcast loop
                setInterval(() => {
                    client.publish(t, JSON.stringify({
                        type: 'INIT',
                        img: gameImg,
                        cat: document.getElementById('game-cat').value.toUpperCase()
                    }));
                }, 3000);
            }
        });

        client.on('message', (tpc, m) => {
            const data = JSON.parse(m.toString());
            
            if(data.type === 'CHAT') {
                const row = document.createElement('div');
                row.className = 'msg';
                row.innerHTML = `<b>${data.from}:</b> ${data.msg}`;
                document.getElementById('chat-msgs').appendChild(row);
            }
            if(data.type === 'SYS') {
                const row = document.createElement('div');
                row.className = 'msg sys';
                row.innerText = data.msg;
                document.getElementById('chat-msgs').appendChild(row);
            }
            if(data.type === 'INIT' && !isHost) {
                // Joiner Sync
                document.getElementById('hidden-image').src = data.img;
                document.getElementById('display-cat').innerText = data.cat;
                document.getElementById('display-code').innerText = roomCode;
                // Only build grid if not exists
                if(!document.getElementById('tile-1')) buildGrid();
            }
        });
    }

</script>
</body>
</html>
